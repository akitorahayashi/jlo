schema_version: 1

id: "g8t4w9"
role: "leverage_architect"

created_at: "2024-05-23"

title: "Transactional Git Workspace"
problem: |
  The current `GitCommandAdapter` executes commands directly against the repository's working directory. Complex operations, such as workflow execution or automated refactoring, involve multiple steps (checkout, modify, commit, push). If any step fails midway, the repository is often left in a "dirty" or inconsistent state (e.g., a temporary branch checked out, partial changes staged), requiring manual intervention to restore. This lack of atomicity makes automation fragile and prone to leaving the user's environment broken.
introduction: |
  Introduce a `GitWorkspace` or `Transaction` abstraction that encapsulates a sequence of git operations within an isolated context. This mechanism can leverage `git worktree` to create temporary, disposable working directories for automation tasks, ensuring that the main working directory remains untouched until the operation is fully successful. Alternatively, implement a robust rollback mechanism for the primary working directory that can revert changes if a multi-step operation fails.
importance: |
  Reliable automation must be atomic. By isolating operations in a transactional workspace, we guarantee that failures do not corrupt the user's primary environment. This significantly increases the safety of running complex, multi-step git workflows and reduces the fear of "messing up the repo" when using advanced features.

impact_surface:
  - "src/adapters/git/git_command.rs (Implement workspace management)"
  - "src/ports/git.rs (Update Git trait or introduce Transaction trait)"
  - "src/app/commands/ (Update workflow runners to use the new abstraction)"

implementation_cost: |
  Medium to High. Implementing a robust `git worktree` manager requires handling cross-platform path issues, cleanup on failure (using `Drop` or similar), and ensuring performance overhead is acceptable.

consistency_risks:
  - "Increased disk usage due to temporary worktrees."
  - "Potential for orphaned worktrees if the process crashes hard (requires a `jlo doctor` cleanup rule)."

verification_signals:
  - "Tests demonstrate that a simulated failure in the middle of a transaction leaves the original working directory state identical to before the start."
  - "Successful execution of workflows using the new abstraction without side effects on the current branch."
