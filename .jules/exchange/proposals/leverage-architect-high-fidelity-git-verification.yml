schema_version: 1

id: "z5r7q2"
role: "leverage_architect"

created_at: "2026-02-20"

title: "High-Fidelity Git Verification"
problem: |
  The current test infrastructure relies on `FakeGit`, a stub that provides false confidence by returning
  hardcoded success values and failing to track critical side effects (branch creation, pushing, diffs).
  This forces heavy reliance on manual testing or brittle integration tests, leaving core git workflows vulnerable to regressions.
introduction: |
  Replace `FakeGit` with a hermetic, stateful test harness that accurately simulates git operations.
  This could use a temporary, isolated git repository for each test (via `assert_fs` and `git2` or CLI wrapper)
  or a high-fidelity in-memory model that tracks HEAD, branches, and index state.
importance: |
  As a git automation tool, verifying git interactions is non-negotiable. A reliable test harness
  allows us to catch "silent failures" (e.g., forgetting to push) in the test suite, drastically reducing
  the risk of shipping broken automation logic.

impact_surface:
  - "src/testing/ports/git_stub.rs: Replace with robust implementation."
  - "src/app/commands/run/mod.rs: Update to use new harness."
  - "tests/: Integration tests can become more deterministic and less flaky."

implementation_cost: |
  Medium-High. Building a robust git harness is non-trivial but pays off in long-term stability.
  Estimated 3-4 days.
  Strategy: Create the new harness in parallel, migrate tests incrementally.

consistency_risks:
  - "Existing tests that 'passed' with FakeGit might start failing (revealing bugs)."
  - "Tests will be slightly slower if using real FS, but much more valuable."

verification_signals:
  - "Test suite catches regressions (e.g., introduce a bug that skips push, test must fail)."
  - "Coverage: Logic branches handling git errors (merge conflicts, dirty state) are covered by tests."
  - "Confidence: Developers can trust `cargo test` to catch git workflow issues."
