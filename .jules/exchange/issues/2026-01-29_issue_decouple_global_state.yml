schema_version: 2

# Metadata
id: "2026-01-29_issue_decouple_global_state"
category: "refacts"
priority: "high"
status: "open"
requires_deep_analysis: false
sources:
  - "2025-05-22_120001_refacts_qa_002"
  - "2026-01-28_152238_refacts_qa_genfs"
  - "2026-01-28_120000_tests_qa_obs01"
  - "2025-05-22_120000_tests_qa_001"

# Content
title: "Decouple Core Services from Global Process State"
summary: "Refactor FilesystemWorkspaceStore and Generator to remove dependency on global process state (CWD), enabling parallelizable tests."

affected_areas:
  - "src/services/workspace_filesystem.rs"
  - "src/services/generator.rs"
  - "tests/common/mod.rs"

constraints: []
risks: []

problem: |
  `FilesystemWorkspaceStore::current()` and `Generator::merge_env_toml` rely on `std::env::current_dir()` and direct filesystem access. This tightly couples the code to global process state, forcing integration tests to modify the actual CWD and run serially (`#[serial]`), which is slow and fragile (violating State Isolation).

impact: |
  Test suite performance is limited by serial execution. Tests are fragile and side-effect prone. Reusability of services in non-CWD contexts is poor.

desired_outcome: |
  Services accept explicit paths or readers/writers, allowing tests to inject mock paths or in-memory buffers without modifying global state. Integration tests can run in parallel.

acceptance_criteria:
  - "`FilesystemWorkspaceStore` does not use `current_dir()` implicitly."
  - "`Generator` methods accept input strings/readers instead of opening files directly."
  - "Integration tests do not use `#[serial]` (where applicable)."
