schema_version: 2

# Metadata
id: "bnwe9a" # stable identity
source_events:
  - "rust01"
title: "Optimize Assemble Prompt Dispatch"
label: "refacts" # Must match a key in .jules/github-labels.json
priority: "medium"
summary: "Remove unnecessary dynamic dispatch (boxing) in assemble_prompt."

# Content
goal: |
  Use static dispatch for PromptAssetLoader.

problem: |
  Generic function boxes the argument, defeating the purpose of generics.

impact: |
  Unnecessary allocation and vtable lookup.

desired_outcome: |
  assemble_prompt uses the generic type directly.

constraints:
  - "Ensure IncludeContext struct becomes generic over L and R."
  - "Maintain Send + Sync + 'static bounds to satisfy minijinja requirements."

risks:
  - "Potential increase in binary size due to monomorphization."

# Specifics
affected_areas:
  - "src/domain/prompt_assemble/assembler.rs"

acceptance_criteria:
  - "IncludeContext struct definition uses generics <L, R> instead of Box<dyn ...>."
  - "assemble_prompt function no longer boxes loader or prompt_assemble_reader."
  - "Existing tests in src/domain/prompt_assemble/assembler.rs pass without modification."

verification_criteria:
  - "Run cargo test --lib domain::prompt_assemble::assembler to verify functionality."
  - "Inspect src/domain/prompt_assemble/assembler.rs to confirm absence of Box::new for loader/reader."

# Planning Flags
implementation_ready: true # false routes to planner; true routes to implementer
planner_request_reason: "Verify if boxing was needed for some specific reason." # required when implementation_ready is false
