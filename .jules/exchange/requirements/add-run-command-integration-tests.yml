schema_version: 2

# Metadata
id: "i406f9" # stable identity
source_events:
  - "mis456"
title: "Add Run Command Integration Tests"
label: "tests" # Must match a key in .jules/github-labels.json
priority: "medium"
summary: "Add integration tests for the jlo run execution loop."

# Content
goal: |
  Verify the end-to-end behavior of jlo run.

problem: |
  Existing tests only check previews/contracts, not the actual execution loop.

impact: |
  Regressions in the main loop (LLM interaction, git ops) may go unnoticed.

desired_outcome: |
  Integration tests that simulate a full run.

constraints:
  - "Must use shared test doubles from src/testing/ports (enhance FakeGit/FakeGitHub, do not duplicate)."
  - "Must expose run_with_deps and testing module via a 'testing' feature flag in Cargo.toml."
  - "Integration tests must verify the full execution loop (Git -> LLM -> Git/GitHub) using injected mocks."
  - "Do not introduce circular dependencies between tests and the library."

risks:
  - "Exposing internal APIs (run_with_deps) via feature flag increases public surface area; mitigation: use #[cfg(feature = 'testing')]."
  - "Mocking the LLM client requires careful orchestration to ensure the loop proceeds correctly."

# Specifics
affected_areas:
  - "src/testing/ports/git_stub.rs"
  - "src/app/api.rs"
  - "src/lib.rs"
  - "Cargo.toml"
  - "tests/cli/run/execution_loop_test.rs"

acceptance_criteria:
  - "FakeGit enhanced to track pushed branches and simulate basic commands (rm)."
  - "testing feature added to Cargo.toml and utilized in src/lib.rs to expose internals."
  - "New integration test file execution_loop_test.rs added covering Planner, Implementer, and Observers flows."
  - "Tests verify side effects: branch creation, file modification, and PR creation via mocks."
  - "run command unit tests in mod.rs migrated to use shared doubles."

verification_criteria:
  - "cargo test --features testing passes."

# Planning Flags
implementation_ready: true # false routes to planner; true routes to implementer
planner_request_reason: "Design the integration test scenario." # required when implementation_ready is false
