schema_version: 2

# Metadata
id: "cfgcnt"
source_events:
  - "aaaa01"
  - "bbbb02"
  - "dupcfg"
  - "conf01"
  - "redsch"
title: "Centralize Configuration Logic"
label: "refacts"
priority: "high"
summary: "Fix duplicate config parsing, domain leakage, and ambiguous sections in `.jlo/config.toml`."

# Content
goal: |
  Ensure configuration is parsed in one place (domain layer), and runtime options are separate from domain config.

problem: |
  Adapters re-parse config. `RunOptions` leaks runtime flags into domain. `RunConfig` duplicates `Schedule`. `[jules]` section is ambiguous.

impact: |
  Maintenance nightmare. Drift between adapter and domain logic.

desired_outcome: |
  Adapters use domain config models. `RunOptions` is pure. `RunConfig` reuses `Schedule`. `[jules]` section is renamed or clarified.

constraints:
  - "Backward compatibility for [jules] section (alias)"

risks:
  - "Breaking change for CLI args if not careful"
  - "Config schema migration complexity"

# Specifics
affected_areas:
  - "src/domain/config/"
  - "src/adapters/control_plane_config.rs"
  - "src/app/commands/"
  - "src/testing/"

acceptance_criteria:
  - "`WorkflowGenerateConfigDto` is removed from adapters."
  - "`RunConfig` uses `Schedule` struct."
  - "`RunOptions` does not contain CLI flags."

verification_criteria:
  - "Grep for duplicate config parsing logic."
  - "Review `RunConfig` struct definition."

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: |
  Refactoring configuration parsing affects the entire application initialization flow.

  DEEP ANALYSIS FINDINGS:
  1. Duplication in Adapters:
     The `WorkflowGenerateConfigDto` in `src/adapters/control_plane_config.rs` duplicates the `RunConfig` structure defined in the domain layer. This creates drift where adapter logic (parsing) and domain logic (validation/defaults) are separated. The fix requires removing `WorkflowGenerateConfigDto` and using `RunConfig` directly, or a domain-defined DTO if necessary, ensuring the domain owns the schema.

  2. Structural Duplication in Domain:
     `RunConfig` (in `src/domain/config/run.rs`) manually re-defines `observers` and `innovators` fields, mirroring `Schedule` (in `src/domain/config/schedule.rs`). `RunConfig` should instead embed `Schedule` as a field (e.g., `pub schedule: Schedule`) to enforce a single source of truth for scheduling logic.

  3. RunOptions Leakage:
     `RunOptions` currently confounds "Run Target" (Layer, Role, Requirement) with "Execution Context" (Mock mode, Prompt Preview, Branch overrides). This structure is passed deep into domain logic, carrying CLI-specific flags.
     - Recommendation: Split `RunOptions` into `RunTarget` (domain entity) and `RuntimeContext` (execution parameters).
     - Mock execution should be handled via dependency injection (Service Strategy) at the composition root, rather than passing a boolean flag down to the domain.

  4. [jules] Section Ambiguity:
     The `[jules]` TOML section maps specifically to `JulesApiConfig`, which is misleading as it implies general system config. It should be renamed to `[api]` or `[jules_api]`. To maintain backward compatibility, the parser should support both keys (alias) during a transition period.
