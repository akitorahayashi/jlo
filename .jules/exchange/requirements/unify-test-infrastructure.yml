schema_version: 2

# Metadata
id: "t4m8p2"
source_events:
  - "jgug9f"
  - "cov001"
  - "cov003"
  - "rust02"
  - "sarc01"
  - "tact03"
title: "Unify and Strengthen Test Infrastructure"
label: "tests"
priority: "high"
summary: "Centralize test doubles and improve test coverage for critical execution paths."

# Content
goal: |
  Eliminate duplicated test doubles (`TestGit`, `TestGitHub`), improve the realism of shared mocks (`FakeGit`), and ensure that `execute_real` paths in the `run` command are adequately tested (via integration tests or improved unit tests).

problem: |
  The codebase currently duplicates mock definitions in `src/app/commands/run/mod.rs` instead of using the shared ones in `src/testing/`. Additionally, the shared `FakeGit` implementation is too simplistic (hardcoded success), and the `execute_real` paths for `Decider` and `Implementer` layers are completely uncovered by unit tests, relying solely on `execute_mock`.

impact: |
  This fragmentation leads to maintenance burden (multiple sources of truth for mocks), "false confidence" in tests that pass against unrealistic mocks, and potential regressions in critical production paths that are currently untested.

desired_outcome: |
  All tests should use shared test doubles from `src/testing/`. `FakeGit` should support stateful simulation (tracking commits, branches). `execute_real` paths should be covered by tests that inject these improved shared mocks.

constraints:
  - "Ensure backward compatibility for existing tests using `FakeGit`."
  - "Do not expose `FakeJulesClient` or factory details excessively outside of testing context."

risks:
  - "Refactoring `FakeGit` to use shared state (`Arc<Mutex<T>>`) might require updates to existing tests that assume ownership or non-shared state."
  - "Injecting `JulesClientFactory` into `execute_with_mock_prerequisite_validator` changes internal API but should be contained within `run/mod.rs`."

# Specifics
affected_areas:
  - "src/testing/ports/git_stub.rs"
  - "src/testing/ports/github_stub.rs"
  - "src/testing/ports/jules_client_stub.rs"
  - "src/testing/ports/mod.rs"
  - "src/testing/mod.rs"
  - "src/app/commands/run/mod.rs"

acceptance_criteria:
  - "Create `src/testing/ports/jules_client_stub.rs` implementing `FakeJulesClient` and `FakeJulesClientFactory`."
  - "Enhance `FakeGit` in `src/testing/ports/git_stub.rs` to use `Arc<Mutex<T>>` for fields (shared state), supporting `Clone`."
  - "Enhance `FakeGit` to support `rm --` simulation (via optional `root` path) and track pushed branches."
  - "Refactor `src/app/commands/run/mod.rs`: remove `TestGit`/`TestGitHub`, import shared mocks."
  - "Update `execute` flow in `run/mod.rs` to support injecting `JulesClientFactory` for testing."
  - "Add at least one test case in `run/mod.rs` exercising `execute_real` path for Decider or Implementer using `FakeJulesClient`."

verification_criteria:
  - "Grep for `struct TestGit` in `src/app/commands/run/` returns no results."
  - "Run `cargo test` and ensure all tests (including new `execute_real` tests) pass."
  - "Verify `FakeGit` changes do not break existing tests in other modules."

# Planning Flags
implementation_ready: true
planner_request_reason: "Design required for dependency injection of JulesClient in execute_real and unification of test doubles."
