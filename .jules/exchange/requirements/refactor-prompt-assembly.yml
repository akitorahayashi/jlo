schema_version: 2

# Metadata
id: "p2n5r8"
source_events:
  - "da0003"
  - "cov002"
  - "rust03"
title: "Refactor Prompt Assembly Engine"
label: "refacts"
priority: "medium"
summary: "Decouple prompt assembly from schema layout and improve concurrency model."

# Content
goal: |
  Refactor `IncludeContext::seed_from_schema` in `src/domain/prompt_assemble/assembler.rs` to remove hardcoded assumptions about directory layout (`schemas_dir.join(file_name)`). Replace `Arc<Mutex<T>>` usage with proper context passing (e.g., `minijinja::State`) for better concurrency. Ensure `seed_from_schema` logic is actually covered by tests.

problem: |
  The prompt assembly logic is tightly coupled to a flat schema directory structure, preventing reorganization. It also uses `Arc<Mutex<T>>` unnecessarily for synchronous operations to satisfy `minijinja` trait bounds, introducing overhead. Furthermore, critical seeding logic is skipped in existing tests.

impact: |
  This coupling limits future architectural changes, and the lack of test coverage risks regressions in schema seeding (auto-creation).

desired_outcome: |
  Prompt assembly should be agnostic to storage layout. Concurrency primitives should be removed where unnecessary. Tests should verify seeding logic.

constraints: []
risks: []

# Specifics
affected_areas:
  - "src/domain/prompt_assemble/assembler.rs"

acceptance_criteria:
  - "`seed_from_schema` does not assume flat layout."
  - "`Arc<Mutex<T>>` is removed from `assemble_prompt`."
  - "A new test case verifies `SeedOp` generation when file is missing."

verification_criteria:
  - "Review code changes."
  - "Run `cargo test`."
  - "Check coverage report."

# Planning Flags
implementation_ready: true
planner_request_reason: ""
