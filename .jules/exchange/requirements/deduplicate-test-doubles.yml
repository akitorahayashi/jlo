schema_version: 2

# Metadata
id: "ttxq9h" # stable identity
source_events:
  - "dup123"
  - "rust03"
title: "Deduplicate Test Doubles"
label: "refacts" # Must match a key in .jules/github-labels.json
priority: "medium"
summary: "Remove duplicate TestGit and TestGitHub structs in run command."

# Content
goal: |
  Use shared test doubles from src/testing/.

problem: |
  run command re-implements test doubles, violating DRY.

impact: |
  Maintenance burden, inconsistent test behavior.

desired_outcome: |
  run command tests use shared GitStub and GitHubStub.

constraints:
  - "Shared `FakeGit` must be enhanced to simulate `rm --` commands and track pushed branches to support existing `run` command tests."
  - "Do not introduce breaking changes to `FakeGit` public API."

risks:
  - "Modifying shared `FakeGit` might affect other tests relying on it (e.g., `publish_proposals.rs`, `process.rs`)."
  - "Shared `FakeGitHub` uses incremental IDs while `TestGitHub` used fixed IDs; ensure test assertions are robust."

# Specifics
affected_areas:
  - "src/app/commands/run/mod.rs"
  - "src/testing/ports/git_stub.rs"

acceptance_criteria:
  - "Local `TestGit` and `TestGitHub` structs removed from `src/app/commands/run/mod.rs`."
  - "All tests in `src/app/commands/run/mod.rs` use shared `FakeGit` and `FakeGitHub`."
  - "Shared `FakeGit` supports `run_command` for file removal simulation."
  - "Shared `FakeGit` supports tracking pushed branches."
  - "All existing tests pass."

verification_criteria:
  - "Run `cargo test --package jlo --lib app::commands::run` to verify `run` command tests."
  - "Run `cargo test --package jlo --lib testing::ports` to verify shared doubles."
  - "Run `cargo test` (full suite) to ensure no regressions."

# Planning Flags
implementation_ready: true # false routes to planner; true routes to implementer
planner_request_reason: "Verify shared doubles cover all needs of run command." # required when implementation_ready is false
