schema_version: 2
id: "a7c4t5"
source_events:
  - "d4e5f6"
  - "da0001"
  - "da0003"
  - "g7h8i9"
  - "ab1cd2"
  - "qa0003"
  - "ev3pro"
title: "Enforce Domain Sovereignty"
label: "refacts"
priority: "high"
summary: "Clean up the domain layer to enforce separation of concerns, remove adapter leakage, and resolve cyclic dependencies."
goal: |
  Restore the purity of the domain layer by moving transport concerns, side effects, and concrete adapter instantiations to the outer layers.
  Ensure domain models enforce their own invariants rather than relying on external validation.
problem: |
  Domain logic is leaking into adapters (config validation).
  Transport protocols (TOML) are leaking into domain errors.
  Side effects (file writes) are present in domain logic (prompt assembly).
  Cyclic dependencies exist between domain and ports.
  Domain models are anemic or loosely typed (`Box<dyn ...>` usage).
  API layer is coupled to concrete adapters.
impact: |
  Architecture is brittle and hard to refactor.
  Testing is difficult due to coupling and side effects.
  Validation logic is scattered and potentially inconsistent.
desired_outcome: |
  Domain models validate themselves.
  Domain errors are transport-agnostic.
  Prompt assembly is side-effect free (returns data, doesn't write).
  Cyclic dependencies are broken (likely by moving AppError or extracting shared types).
  API layer uses dependency injection or factories.
affected_areas:
  - "src/domain/config/"
  - "src/adapters/"
  - "src/domain/prompt_assemble/"
  - "src/domain/error.rs"
  - "src/ports/"
  - "src/app/api.rs"
acceptance_criteria:
  - "Configuration validation logic resides in `src/domain/config/`."
  - "`ScheduleError` does not expose `toml::de::Error`."
  - "`IncludeContext::seed_from_schema` returns operations instead of performing IO."
  - "Cyclic dependency between `src/domain` and `src/ports` is resolved."
  - "`AppError` is decoupled from concrete transport errors where possible."
  - "`api.rs` does not instantiate concrete adapters."
verification_criteria:
  - "Run `cargo check` and ensure no circular dependencies."
  - "Run `cargo test`."
requires_deep_analysis: false
deep_analysis_reason: |
  Resolving cyclic dependencies and refactoring core error types may have widespread impact on the codebase.

  ### System Impact Analysis
  - **Cyclic Dependency Resolution**: Moving `src/ports` to `src/domain/ports` is a structural refactor affecting imports in `src/adapters`, `src/app`, and `src/domain`. This eliminates the `domain <-> ports` cycle but requires touching ~20-30 files.
  - **API Decoupling**: Refactoring `src/app/api.rs` to use dependency injection (e.g., passing `impl RepositoryFilesystem` instead of `PathBuf`) breaks the public API signature of the library crate. Consumers (CLI, integration tests) must be updated to instantiate adapters before calling API functions.
  - **Prompt Assembly**: Changing `IncludeContext::seed_from_schema` to return operations instead of executing side effects changes the contract of `assemble_prompt`. The caller (`run` command) must now handle these operations. This decouples IO from the domain logic.

  ### Dependency Analysis
  - **Current**: `src/domain` -> `src/ports` -> `src/domain` (via `AppError`).
  - **Target**: `src/adapters` -> `src/domain/ports`; `src/app` -> `src/domain/ports`; `src/domain` (self-contained).
  - **External**: `ScheduleError` exposes `toml::de::Error`. This must be wrapped or mapped to `AppError::InvalidConfig` to remove the `toml` dependency from the domain public interface.

  ### Risks
  - **Merge Conflicts**: High risk due to the number of files affected by import changes.
  - **Regression**: The prompt assembly refactor changes how files are created. If the operation list is not correctly executed by the runner, schemas will not be seeded, potentially confusing users.
  - **Validation Gaps**: Moving validation from adapters to domain must ensure that *all* checks (e.g., "cron not empty") are preserved.

  ### Implementation Specifics
  1.  **Domain/Ports Refactor**:
      - Create `src/domain/ports/` and move `src/ports/*.rs` there.
      - Update `src/lib.rs` (or `main.rs`) to export `domain::ports`.
      - Bulk update imports from `crate::ports` to `crate::domain::ports`.
      - Delete `src/ports/`.
  2.  **Config Validation**:
      - Implement `validate()` for `WorkflowTimingConfig` in `src/domain/config/control_plane.rs`.
      - Invoke `self.workflow.validate()` in `ControlPlaneConfig::validate()`.
      - Remove manual validation from `src/adapters/control_plane_config.rs`.
  3.  **Error Decoupling**:
      - In `src/domain/config/schedule.rs`, remove `#[from] toml::de::Error`.
      - In `Schedule::parse_toml`, map the error: `toml::from_str(content).map_err(|e| ScheduleError::Toml(e.to_string()))?`.
  4.  **Prompt Assembly**:
      - Modify `IncludeContext` to store `Vec<SeedOp>` (enum with `Copy { from, to }`).
      - Return `(AssembledPrompt, Vec<SeedOp>)` from `assemble_prompt`.
      - Update `src/app/commands/run/layer.rs` to iterate and execute seed ops using the repository adapter.
  5.  **API Injection**:
      - Update `src/app/api.rs`: `pub fn run_at(..., repo: &impl RepositoryFilesystem, ...)`.
      - Update `src/app/cli/run.rs`: Instantiate `LocalRepositoryAdapter`, `GitCommandAdapter`, etc., and pass them to `run_at`.
