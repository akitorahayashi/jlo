schema_version: 2

# Metadata
id: "c6et07" # stable identity
source_events:
  - "da0002"
  - "4s99pv"
  - "da0003"
  - "cou789"
title: "Strengthen Config Validation And Models"
label: "refacts" # Must match a key in .jules/github-labels.json
priority: "medium"
summary: "Move validation logic from adapters to domain models and replace stringly-typed errors."

# Content
goal: |
  Enforce valid state in domain models and improve validation robustness by moving logic from adapters to domain entities.

problem: |
  Validation currently resides in `src/adapters/control_plane_config.rs`, leaving domain models (`WorkflowGenerateConfig`, `Proposal`) anemic (public fields without constraints). Configuration errors are primarily stringly-typed (`ConfigError::Invalid(String)`), making programmatic error handling brittle and reducing type safety.

impact: |
  - **Reliability**: Invalid configurations can be instantiated in memory, potentially leading to runtime failures deep in the execution path rather than at load time.
  - **Maintainability**: Validation logic is coupled to the loading mechanism (adapter) rather than the data structure (domain), violating separation of concerns.
  - **Testability**: Testing validation logic requires mocking filesystem interactions or parsing TOML, rather than unit testing pure domain logic.
  - **Error Handling**: String-based errors prevent callers from reacting to specific failure modes (e.g., distinguishing a missing field from an invalid format).

desired_outcome: |
  - Domain models (`WorkflowGenerateConfig`, `Proposal`) implement self-validation methods (e.g., `validate()`).
  - Validation logic is encapsulated within the domain structs.
  - `ConfigError` and related error enums use specific, typed variants for different failure modes.
  - Adapters delegate validation to domain models immediately after parsing.

constraints:
  - "Validation logic must be strictly moved to domain models, not duplicated in adapters."
  - "Error types must be enum variants (e.g., `MissingField`, `InvalidValue`), not string wrappers, except where wrapping external errors."
  - "Existing configuration behavior (e.g., default values, trimming) must be preserved unless explicitly invalid."

risks:
  - "Strict validation might reject currently working but technically malformed configs (e.g., untrimmed strings) if migration is not handled carefully."
  - "Changes to `ConfigError` will ripple through `AppError` and may require updates to error handling in multiple adapters."

# Specifics
affected_areas:
  - "src/domain/config/error.rs"
  - "src/domain/config/workflow_generate.rs"
  - "src/domain/config/control_plane.rs"
  - "src/domain/exchange/proposals/model.rs"
  - "src/adapters/control_plane_config.rs"

acceptance_criteria:
  - "The `ConfigError` enum is expanded with specific variants (e.g., `EmptyBranch`, `InvalidCron`, `InvalidTimeout`, `MissingField`)."
  - "`WorkflowGenerateConfig::validate(&self)` is implemented and enforces: `target_branch` not empty, `worker_branch` not empty, `schedule_crons` not empty, `wait_minutes_default` > 0."
  - "`Proposal::validate(&self)` is implemented and enforces required fields (id, role, title, problem, etc.) are not empty."
  - "`load_workflow_generate_config` in `src/adapters/control_plane_config.rs` is refactored to delegate validation to `WorkflowGenerateConfig::validate`."
  - "`ControlPlaneConfig::validate` is updated to use the new typed errors."

verification_criteria:
  - "Unit tests in `src/domain/config/workflow_generate.rs` verify all validation rules and error variants."
  - "Unit tests in `src/domain/exchange/proposals/model.rs` verify mandatory field validation."
  - "Existing adapter tests in `src/adapters/control_plane_config.rs` pass or are updated to assert on specific error variants."
  - "Manual verification: Run `jlo doctor` (or equivalent config loader) with invalid config to confirm new error messages."

# Planning Flags
implementation_ready: true # false routes to planner; true routes to implementer
planner_request_reason: "Define the validation strategy and error types." # required when implementation_ready is false
