schema_version: 2
id: "k9l3m6"
source_events:
  - "d4e5f6"
  - "a1b2c3"
  - "q7w4r2"
  - "runenv"
title: "Logic Coupled to IO Preventing Testing"
label: "refacts"
priority: "medium"
summary: "Core logic in Doctor, Narrator, and API is tightly coupled to IO and global environment, hindering testing."
problem: |
  Important business logic is mixed directly with filesystem, git operations, and global environment variables. This prevents pure unit testing and forces reliance on slower, more complex integration tests.
  1. `Doctor` schema validation is coupled to file reading.
  2. `Narrator` logic is coupled to `GitPort`.
  3. The `jlo::run` API relies on `std::env::current_dir()` and lacks a path-aware variant, making it hard to test in isolation.
  4. The `workflow::run` command directly accesses environment variables (`JULES_MOCK_TAG`, `ROUTING_LABELS`) instead of accepting them via configuration or arguments.
impact: |
  1. **Low Test Coverage**: Critical logic paths are uncovered because they are hard to reach in integration tests.
  2. **Regression Risk**: Changes to validation rules or git logic can easily break functionality without detection.
  3. **Slow Feedback Loop**: Developers must run full commands to verify changes instead of fast unit tests.
  4. **Implicit Dependencies**: Global state dependencies make the system behavior unpredictable and hard to mock.
desired_outcome: |
  1. Validation logic in `doctor/schema.rs` is decoupled from file reading (accepts data structures, not paths).
  2. Narrator logic (`collect_git_context`, `determine_range`) is separated into pure functions that accept data, not ports.
  3. The `jlo::run` API is updated to accept an optional path or a path-aware variant is added.
  4. `workflow::run` accepts configuration objects instead of reading environment variables directly.
affected_areas:
  - "src/app/commands/doctor/schema.rs"
  - "src/app/commands/run/narrator.rs"
  - "src/app/api.rs"
  - "src/app/commands/workflow/run.rs"
acceptance_criteria:
  - "`validate_*` functions in `schema.rs` accept `serde_yaml::Value` or structs instead of `Path`."
  - "Narrator logic is extracted to a testable module/struct that does not depend on `GitPort` directly."
  - "`jlo::run` API supports running against a specific path (e.g., `run_at` or `RunOptions` with path)."
  - "`workflow::run` logic relies on passed configuration, not `std::env::var`."
  - "New unit tests cover the extracted pure logic."
verification_commands:
  - "cargo check"
  - "cargo test"
requires_deep_analysis: false
deep_analysis_reason: ""
