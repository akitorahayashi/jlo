schema_version: 2

# Metadata
id: "ref88y"
source_events:
  - "ev49za"
  - "dep001"
  - "work01"
  - "2wq7mt"
  - "1zpqgm"
title: "Enforce Dependency Injection and Port Usage in Commands"
label: "refacts"
priority: "high"
summary: "Refactor commands to use Dependency Injection and Ports/Adapters pattern."

# Content
problem: |
  Several application commands violate the Dependency Inversion Principle and Hexagonal Architecture.
  1. **Direct Instantiation**: Commands instantiate concrete adapters directly.
  2. **Port Bypassing**: `bootstrap.rs` and `render.rs` use `std::fs` directly, bypassing `WorkspaceStore`.
  3. **Fragility**: Fragile string path conversions.

impact: |
  Makes unit testing with mocks impossible (requires full filesystem), couples code to implementation details, and reduces robustness.

desired_outcome: |
  Commands accept injected dependencies via ports (`ComponentCatalog`, `GitPort`, `WorkspaceStore`) and use robust `Path` operations.

constraints: []
risks:
  - "API Breaking Changes: Changing command signatures requires updates to all call sites, potentially breaking integration tests or other consumers if not careful."
  - "Port Expansion: Adding `remove_dir_all` and `is_symlink` to `WorkspaceStore` might require careful implementation across different store backends (e.g., memory store)."

# Specifics
affected_areas:
  - "src/app/commands/setup/generate.rs"
  - "src/app/commands/setup/list.rs"
  - "src/app/commands/workflow/run.rs"
  - "src/app/commands/workflow/bootstrap.rs"
  - "src/app/commands/workflow/render.rs"
  - "src/app/commands/workflow/mod.rs"
  - "src/ports/workspace_store.rs"
  - "src/adapters/workspace_filesystem.rs"
  - "src/adapters/memory_workspace_store.rs"
  - "src/app/cli/setup.rs"
  - "src/app/cli/workflow.rs"

acceptance_criteria:
  - "Refactor `setup` commands to accept `impl ComponentCatalog`."
  - "Refactor `workflow::run` to accept `impl GitPort` and `impl GitHubPort`."
  - "Refactor `workflow::bootstrap` and `workflow::render` to use `impl WorkspaceStore`."
  - "Remove direct `std::fs` usage from commands."
  - "Replace `to_string_lossy()` with `Path` methods in `bootstrap.rs`."

verification_commands:
  - "cargo test"
  - "cargo clippy --all-targets --all-features -- -D warnings"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: |
  Refactoring core commands and dependency injection requires careful architectural planning to avoid breaking changes and ensure all call sites are updated.

  Analysis completed. Technical plan:
  1.  **Extend `WorkspaceStore`**: Add `remove_dir_all` and `is_symlink` to support recursive directory removal and symlink detection required by `bootstrap.rs`. Implement these in `FilesystemWorkspaceStore` and `MemoryWorkspaceStore`.
  2.  **Refactor Setup Commands**: Update `generate.rs` and `list.rs` to accept `&impl ComponentCatalog` as an argument, removing internal `EmbeddedComponentCatalog::new()` calls.
  3.  **Refactor Workflow Bootstrap**: Update `bootstrap.rs` to accept `&impl WorkspaceStore` and `&impl RoleTemplateStore`. Replace `std::fs` usage with `store` methods. Refactor `collect_files_recursive` to use `store` methods.
  4.  **Refactor Workflow Render**: Update `render.rs` to accept `&impl WorkspaceStore`. Replace `std::fs` usage.
  5.  **Refactor Workflow Facade**: Update `workflow/mod.rs` to expose `run`, `bootstrap`, `render` functions that take dependencies as arguments.
  6.  **Update CLI Layer**: Update `cli/setup.rs` and `cli/workflow.rs` to act as the composition root, instantiating concrete adapters (`EmbeddedComponentCatalog`, `FilesystemWorkspaceStore`, `GitCommandAdapter`, etc.) and injecting them into the commands.
