schema_version: 2

# Metadata
id: "915dd8"
source_events:
  - "app001"
  - "cli001"
  - "mix001"
title: "Structural Cleanup"
label: "refacts"
priority: "high"
summary: "Refactor app and services modules to improve cohesion and reduce coupling."

# Content
problem: |
  The codebase suffers from structural issues:
  1. Circular Dependency: src/lib.rs (the crate root) depends on src/app (via pub mod app) and src/app/cli (via pub use app::cli::run). However, src/app/cli depends back on src/lib.rs (via crate::init, crate::run, etc.) to execute commands. This creates a cycle (lib -> app -> cli -> lib) and tightly couples the presentation layer to the library root facade.
  2. Low Cohesion in src/app: It mixes business logic (commands, context, config) with CLI presentation (cli).
  3. Unorganized Services: src/services is a flat directory containing unrelated concerns (Adapters, Domain Services, Assets, Catalog).

impact: |
  - Refactoring Difficulty: The circular dependency makes it hard to move code or split the crate.
  - Testing: Unit testing the CLI logic is difficult because it's coupled to the global crate functions.
  - Navigation: Developers struggle to find logic in src/services due to the lack of categorization.

desired_outcome: |
  A clean separation of concerns with a Directed Acyclic Graph (DAG) of dependencies:
  - CLI Decoupling: src/app/cli should depend on a specific API module (e.g., src/app/api.rs), not the crate root.
  - Logic Extraction: The high-level "Facade" logic currently in src/lib.rs (which glues context creation to command execution) should be moved to src/app/api.rs. src/lib.rs should merely re-export this API.
  - Service Organization: src/services should be structured into adapters, domain, and assets.

constraints:
  - "Public API Stability: The public functions exported by jlo (in src/lib.rs) must remain available with the same signatures, even if their implementation moves."
  - "CLI Interface: The command-line interface (arguments, output) must not change."

risks:
  - "Merge Conflicts: Moving many files in src/services poses a high risk of conflict with concurrent work."
  - "Import Breakage: Renaming modules will break imports throughout the codebase. cargo check must be run frequently."

# Specifics
affected_areas:
  - "src/app/cli/mod.rs"
  - "src/app/api.rs"
  - "src/lib.rs"
  - "src/services/"

acceptance_criteria:
  - "src/app/cli does not use crate::init, crate::update, etc. It uses crate::app::api."
  - "src/lib.rs does not contain implementation logic for commands; it delegates to app::api."
  - "src/services is organized into submodules (adapters, domain, assets)."
  - "All unit and integration tests pass."

verification_commands:
  - "cargo check"
  - "cargo test"
  - "cargo run -- doctor"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: "Major structural refactoring involving core modules `app` and `services` requires dependency analysis to avoid breaking the CLI or introducing circular dependencies. FINDINGS: Initial analysis identified the specific circular dependency mechanism (lib->app->cli->lib). The mitigation strategy is to extract the library facade into src/app/api.rs and make src/lib.rs a re-export shell. Services will be grouped by architectural role."
