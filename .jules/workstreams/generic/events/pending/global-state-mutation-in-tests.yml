schema_version: 1

# Metadata
id: "ab12cd"
issue_id: ""
created_at: "2024-05-22"
author_role: "qa"
confidence: "high"

# Content
title: "Global State Mutation in Integration Tests"
statement: |
  The `TestContext` integration test harness modifies global process state, specifically the `HOME` environment variable and the current working directory (`CWD`). This global mutation forces all tests using `TestContext` to be marked with `#[serial]`, preventing parallel execution. As the number of integration tests grows, this will significantly degrade feedback speed.

# Evidence supporting the observation
evidence:
  - path: "tests/common/mod.rs"
    loc:
      - "unsafe { env::set_var(\"HOME\", root.path()); }"
    note: "The harness overwrites the global HOME environment variable for the entire process."

  - path: "tests/common/mod.rs"
    loc:
      - "env::set_current_dir(&self.work_dir).expect(\"Failed to switch current dir\");"
    note: "The harness changes the process-wide current working directory."

  - path: "tests/cli_commands.rs"
    loc:
      - "#[serial]"
    note: "Tests are forced to run serially to avoid race conditions on the global state."

tags:
  - "test-architecture"
  - "performance"
  - "scalability"
  - "anti-pattern"
