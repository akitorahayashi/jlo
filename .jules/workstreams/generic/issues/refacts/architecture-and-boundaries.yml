schema_version: 2

# Metadata
id: "k2m4n9"
source_events:
  - "kd92la"
  - "m9d2ka"
  - "j8s7d1"
title: "Architecture and Layer Boundary Violations"
label: "refacts"
priority: "high"
summary: "App layer bypasses ports, services lack cohesion, and internal app module is public."

# Content
problem: |
  The codebase exhibits significant architectural violations:
  1. The `src/app` layer bypasses the `src/ports` abstraction layer by directly importing concrete implementations from `src/services` (e.g., `EmbeddedRoleTemplateStore`).
  2. The `src/lib.rs` file exposes the internal `app` module publicly (`pub mod app`), leaking implementation details and CLI structure to the public API surface.
  3. The `src/services` directory is a flat list of unrelated implementations (HTTP, Filesystem, Artifacts), lacking domain-driven structure and cohesion.

impact: |
  These violations degrade the maintainability and testability of the system. Direct dependencies on services prevent effective mocking of ports during testing. Public exposure of internal modules limits future refactoring without breaking changes. The flat service structure makes it difficult to navigate and understand domain boundaries.

desired_outcome: |
  The architecture should strictly follow hexagonal principles:
  1. `src/app` should only depend on `src/ports` (traits) and `src/domain` (types). Concrete services should be injected via `main.rs` or a DI container.
  2. `src/lib.rs` should not export `app` publicly; it should only expose necessary entry points.
  3. `src/services` should be organized into cohesive sub-modules or directories reflecting domain responsibilities.

constraints: []
risks: []

# Specifics
affected_areas:
  - "src/app/"
  - "src/services/"
  - "src/lib.rs"

acceptance_criteria:
  - "`src/app` code does not contain direct `use crate::services::...` imports (except in `app/context.rs` or `main.rs` where injection happens)."
  - "`src/lib.rs` does not contain `pub mod app`."
  - "`src/services` is reorganized to group related implementations (e.g., `services/scaffold/`, `services/build/`)."

verification_commands:
  - "cargo check"
  - "cargo test"
  - "grep -r 'use crate::services' src/app | grep -v 'context.rs' | wc -l"
  - "grep 'pub mod app' src/lib.rs"
  - "ls -F src/services/"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: ""
