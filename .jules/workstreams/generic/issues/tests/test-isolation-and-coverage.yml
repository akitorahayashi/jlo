schema_version: 2

# Metadata
id: "t2n8m4"
source_events:
  - "lit3s7"
  - "k8j2x9"
title: "Test Isolation and Coverage"
label: "tests"
priority: "medium"
summary: "CLI tests leak global state, and DependencyResolver lacks property-based tests."

# Content
problem: |
  1. `TestContext` modifies process-global state (CWD, HOME env var) to simulate isolation. This forces serial execution of tests and creates a risk of race conditions or state leakage if tests crash.
  2. `DependencyResolver` relies on a small set of manual unit tests. It lacks property-based testing (`proptest`) to verify invariants (acyclicity, sorting correctness) across a wide range of graph structures.

impact: |
  Serial test execution slows down the feedback loop. State leakage makes tests flaky. Lack of property tests leaves the core resolution algorithm vulnerable to edge cases.

desired_outcome: |
  1. Refactor `TestContext` to avoid modifying global state. Use arguments or thread-local storage if possible, or execute subprocesses with explicit environments.
  2. Add `proptest` coverage for `DependencyResolver` to verify sorting and cycle detection invariants.

constraints: []
risks: []

# Specifics
affected_areas:
  - "tests/common/mod.rs"
  - "tests/cli_commands.rs"
  - "src/services/dependency_resolver.rs"

acceptance_criteria:
  - "`tests/cli_commands.rs` no longer requires `#[serial]`."
  - "`TestContext` does not use `env::set_current_dir` or `env::set_var`."
  - "`DependencyResolver` has property tests validating topological sort invariants."

verification_commands:
  - "cargo test"

# Analysis Flags
requires_deep_analysis: false
deep_analysis_reason: ""
