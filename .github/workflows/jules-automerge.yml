# This file is generated by the jlo CLI; edits are not recommended.

# Jules Auto-Merge
#
# Validates Jules PRs with doctor check and enables auto-merge on success.
# Policy gates (branch prefix, .jules/-only scope, draft, duplicates) are
# evaluated by `jlo workflow gh pr enable-automerge`, not inline shell logic.
#
# Flow:
#   1. Jules creates PR → doctor runs
#   2. Doctor fails → Jules detects, fixes, pushes
#   3. Doctor passes → enable-automerge evaluates gates → merges when checks pass
#
# Prerequisites:
# - Repository Settings: Enable "Allow auto-merge"
# - Branch Protection: Require this workflow as status check

name: Jules Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - 'jules'

jobs:
  validate-and-automerge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      JLO_TARGET_BRANCH: 'main'
      JULES_WORKER_BRANCH: 'jules'
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Validate with doctor
        run: |
          echo "::group::Doctor check"
          jlo doctor
          echo "::endgroup::"

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          set -euo pipefail
          PR_NUMBER=${{ github.event.pull_request.number }}
          ATTEMPTS=6
          RETRY_DELAY_SECONDS=10

          for attempt in $(seq 1 "$ATTEMPTS"); do
            set +e
            OUTPUT=$(jlo workflow gh pr enable-automerge "$PR_NUMBER" 2>&1)
            STATUS=$?
            set -e

            echo "$OUTPUT"

            if [ "$STATUS" -eq 0 ]; then
              exit 0
            fi

            if ! printf '%s' "$OUTPUT" | grep -q "enablePullRequestAutoMerge"; then
              echo "::error::Auto-merge enable failed with a non-retriable error."
              exit "$STATUS"
            fi

            if [ "$attempt" -eq "$ATTEMPTS" ]; then
              echo "::error::Auto-merge enable failed after ${ATTEMPTS} attempts."
              exit "$STATUS"
            fi

            echo "::warning::Auto-merge branch protection is not ready yet (attempt ${attempt}/${ATTEMPTS}); retrying in ${RETRY_DELAY_SECONDS}s."
            sleep "$RETRY_DELAY_SECONDS"
          done
