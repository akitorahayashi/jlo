# Jules Auto-Merge
#
# Enables squash-merge with branch deletion for PRs from observer/decider/planner.
# Only applies when:
#   1. Branch matches jules-{observer,decider,planner}-* pattern
#   2. All changed files are within .jules/ directory
#
# Does NOT apply to:
#   - jules-implementer-* branches (implementation requires human review)
#   - Any PR that modifies files outside .jules/
#
# Prerequisites:
# - Repository Settings: Enable "Allow auto-merge"
# - Branch Protection: Require status checks to pass before merging

name: Jules Auto-Merge

on:
  workflow_call:
    inputs:
      head_ref:
        required: true
        type: string
      is_draft:
        required: true
        type: boolean
      pr_number:
        required: true
        type: number
    secrets:
      bot_token:
        required: true

jobs:
  check-scope:
    if: |
      (startsWith(inputs.head_ref, 'jules-observer-') ||
       startsWith(inputs.head_ref, 'jules-decider-') ||
       startsWith(inputs.head_ref, 'jules-planner-')) &&
      inputs.is_draft == false
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
    outputs:
      jules_only: ${{ steps.check.outputs.jules_only }}
    steps:
      - name: Check changed files
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Use paginated API to handle PRs with >100 files
          changed=$(gh api --paginate \
            "/repos/${{ github.repository }}/pulls/${{ inputs.pr_number }}/files" \
            --jq '.[].filename')
          
          # Check if any file is outside .jules/
          non_jules=$(echo "$changed" | grep -v '^\.jules/' || true)
          
          if [ -z "$non_jules" ]; then
            echo "jules_only=true" >> "$GITHUB_OUTPUT"
            echo "All changes are within .jules/ - auto-merge eligible"
          else
            echo "jules_only=false" >> "$GITHUB_OUTPUT"
            echo "::warning::PR modifies files outside .jules/:"
            echo "$non_jules"
          fi

  enable:
    needs: check-scope
    if: needs.check-scope.outputs.jules_only == 'true'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    steps:
      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.bot_token }}
        run: |
          for i in {1..5}; do
            if gh pr merge "${{ inputs.pr_number }}" \
              --auto --squash --delete-branch \
              --repo "${{ github.repository }}"; then
              exit 0
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done
          exit 1
