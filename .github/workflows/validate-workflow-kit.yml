name: Validate Workflow Kit

on:
  pull_request:
    paths:
      - 'src/assets/workflows/**'
      - 'src/app/commands/run/**'
      - 'src/domain/mock_config.rs'
      - '.github/workflows/validate-workflow-kit.yml'
  workflow_dispatch:
    inputs:
      mock_scope:
        description: 'Mock scope for validation (role or layer)'
        required: false
        default: 'layer'
        type: choice
        options:
          - role
          - layer

env:
  CARGO_TERM_COLOR: always
  MOCK_SCOPE: ${{ inputs.mock_scope || 'layer' }}

jobs:
  # Build jlo first
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build jlo
        run: cargo build --release

      - name: Upload jlo binary
        uses: actions/upload-artifact@v4
        with:
          name: jlo-binary
          path: target/release/jlo
          retention-days: 1

  # Initialize scaffold in a temp directory and validate it
  validate-scaffold:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download jlo binary
        uses: actions/download-artifact@v4
        with:
          name: jlo-binary
          path: ./bin

      - name: Setup jlo
        run: |
          chmod +x ./bin/jlo
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Create test repository
        run: |
          mkdir -p /tmp/test-repo
          cd /tmp/test-repo
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"
          echo "# Test Repo" > README.md
          git add .
          git commit -m "Initial commit"

      - name: Initialize scaffold
        run: |
          cd /tmp/test-repo
          jlo init scaffold

      - name: Validate scaffold structure
        run: |
          cd /tmp/test-repo
          # Required directories
          test -d .jules/roles
          test -d .jules/roles/narrators/narrator
          test -d .jules/roles/observers
          test -d .jules/roles/deciders
          test -d .jules/roles/planners
          test -d .jules/roles/implementers
          
          # Required files
          test -f .jules/config.toml
          test -f .jules/JULES.md
          test -f .jules/prompt.yml
          test -f .jules/github-labels.json
          
          echo "✓ Scaffold structure validated"

      - name: Initialize workflows
        run: |
          cd /tmp/test-repo
          jlo init workflows

      - name: Validate workflow structure
        run: |
          cd /tmp/test-repo
          # Required workflow files
          test -f .github/workflows/jules-workflows.yml
          test -f .github/actions/install-jlo/action.yml
          test -f .github/actions/configure-git/action.yml
          
          # Required scripts
          test -f .github/scripts/jules-run-narrator.sh
          test -f .github/scripts/jules-run-observers-sequential.sh
          test -f .github/scripts/jules-run-deciders-sequential.sh
          test -f .github/scripts/jules-run-planners-sequential.sh
          test -f .github/scripts/jules-run-implementers-sequential.sh
          
          echo "✓ Workflow structure validated"

  # Run mock mode E2E validation using workflow_call
  mock-e2e:
    needs: [build, validate-scaffold]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download jlo binary
        uses: actions/download-artifact@v4
        with:
          name: jlo-binary
          path: ./bin

      - name: Setup jlo
        run: |
          chmod +x ./bin/jlo
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Create test repository with scaffold
        run: |
          mkdir -p /tmp/mock-test-repo
          cd /tmp/mock-test-repo
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"
          echo "# Mock Test Repo" > README.md
          git add .
          git commit -m "Initial commit"
          
          # Initialize scaffold
          jlo init scaffold
          git add .
          git commit -m "Add jlo scaffold"

      - name: Validate mock dry-run for each layer
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd /tmp/mock-test-repo
          
          # Test --mock --dry-run for each layer (no actual PR creation)
          echo "Testing narrator mock dry-run..."
          jlo run narrator --mock --mock-scope layer --dry-run 2>&1 | tee /tmp/narrator-output.txt
          
          echo "Testing observers mock dry-run..."
          jlo run observers --mock --mock-scope layer --dry-run 2>&1 | tee /tmp/observers-output.txt
          
          echo "Testing deciders mock dry-run..."
          jlo run deciders --mock --mock-scope layer --dry-run 2>&1 | tee /tmp/deciders-output.txt
          
          echo "Testing planners mock dry-run..."
          jlo run planners --mock --mock-scope layer --dry-run 2>&1 | tee /tmp/planners-output.txt
          
          echo "Testing implementers mock dry-run..."
          jlo run implementers --mock --mock-scope layer --dry-run 2>&1 | tee /tmp/implementers-output.txt
          
          echo "✓ All mock dry-runs completed successfully"

  # Validate that workflow template renders correctly with mock inputs
  validate-workflow-template:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download jlo binary
        uses: actions/download-artifact@v4
        with:
          name: jlo-binary
          path: ./bin

      - name: Setup jlo
        run: |
          chmod +x ./bin/jlo
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Create test repository
        run: |
          mkdir -p /tmp/template-test-repo
          cd /tmp/template-test-repo
          git init
          git config user.email "test@example.com"
          git config user.name "Test User"
          echo "# Template Test Repo" > README.md
          git add .
          git commit -m "Initial commit"

      - name: Initialize and validate workflows
        run: |
          cd /tmp/template-test-repo
          jlo init scaffold
          jlo init workflows
          
          # Validate workflow YAML is valid
          python3 -c "import yaml; yaml.safe_load(open('.github/workflows/jules-workflows.yml'))"
          echo "✓ Workflow YAML is valid"

      - name: Check mock support in rendered workflow
        run: |
          cd /tmp/template-test-repo
          
          # Verify mock inputs are present in workflow
          grep -q "mock:" .github/workflows/jules-workflows.yml || { echo "Missing mock input"; exit 1; }
          grep -q "mock_scope:" .github/workflows/jules-workflows.yml || { echo "Missing mock_scope input"; exit 1; }
          grep -q "workflow_call:" .github/workflows/jules-workflows.yml || { echo "Missing workflow_call trigger"; exit 1; }
          grep -q "MOCK_MODE:" .github/workflows/jules-workflows.yml || { echo "Missing MOCK_MODE env"; exit 1; }
          grep -q "JLO_RUN_FLAGS:" .github/workflows/jules-workflows.yml || { echo "Missing JLO_RUN_FLAGS env"; exit 1; }
          
          echo "✓ Mock support validated in workflow"

      - name: Check JLO_RUN_FLAGS in scripts
        run: |
          cd /tmp/template-test-repo
          
          for script in .github/scripts/jules-run-*.sh; do
            if ! grep -q 'JLO_RUN_FLAGS' "$script"; then
              echo "Missing JLO_RUN_FLAGS in $script"
              exit 1
            fi
          done
          
          echo "✓ JLO_RUN_FLAGS validated in all scripts"

  # Summary job
  summary:
    needs: [validate-scaffold, mock-e2e, validate-workflow-template]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Validation Results:"
          echo "  - Scaffold: ${{ needs.validate-scaffold.result }}"
          echo "  - Mock E2E: ${{ needs.mock-e2e.result }}"
          echo "  - Template: ${{ needs.validate-workflow-template.result }}"
          
          if [[ "${{ needs.validate-scaffold.result }}" != "success" ]] || \
             [[ "${{ needs.mock-e2e.result }}" != "success" ]] || \
             [[ "${{ needs.validate-workflow-template.result }}" != "success" ]]; then
            echo "::error::One or more validation jobs failed"
            exit 1
          fi
          
          echo "✓ All validations passed"
