# Jules Agent Orchestration
#
# Orchestrates workstream pipelines using jlo schedule export and inspection outputs.

name: Jules Workflows

on:
  schedule:
    - cron: '0 19 * * *'  # Daily at 19:00 UTC (04:00 JST)
  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: choice
        options:
          - observers
          - deciders
        default: observers
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: 15
      routing_labels:
        description: 'Issue labels eligible for planner/implementer routing (comma-separated)'
        type: string
        default: docs,tests

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: jules
  cancel-in-progress: false

jobs:
  export-workstreams:
    if: >-
      vars.JULES_PAUSED != 'true' &&
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_workstreams: ${{ steps.matrix.outputs.has_workstreams }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Validate .jules workspace
        shell: bash
        run: |
          if [ ! -d ".jules" ]; then
            echo "::error::.jules directory is missing on the 'jules' branch."
            exit 1
          fi
          if ! ls .jules/workstreams/*/scheduled.toml >/dev/null 2>&1; then
            echo "::error::No workstream scheduled.toml found under .jules/workstreams/."
            exit 1
          fi

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Export enabled workstreams
        id: matrix
        run: |
          set -euo pipefail
          matrix=$(jlo schedule export --scope workstreams --format github-matrix | jq -c '.')
          echo "$matrix" > matrix.json

          count=$(jq '.include | length' matrix.json)
          if [ "$count" -gt 0 ]; then
            echo "has_workstreams=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_workstreams=false" >> "$GITHUB_OUTPUT"
          fi

          echo "matrix<<EOF" >> "$GITHUB_OUTPUT"
          cat matrix.json >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

  workstream-pipeline:
    needs: export-workstreams
    if: needs.export-workstreams.outputs.has_workstreams == 'true'
    strategy:
      max-parallel: 1
      matrix: ${{ fromJson(needs.export-workstreams.outputs.matrix) }}
    uses: ./.github/workflows/jules-workstream.yml
    with:
      workstream: ${{ matrix.workstream }}
      entry_point: ${{ inputs.entry_point || 'observers' }}
      wait_minutes: ${{ inputs.wait_minutes || 15 }}
      routing_labels: ${{ inputs.routing_labels || 'docs,tests' }}
    secrets: inherit
