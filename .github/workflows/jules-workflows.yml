# Jules Agent Execution
#
# Simplified workflow using jlo CLI for agent orchestration.
# Configuration is managed via .jules/config.toml.

name: Jules Agents

on:
  schedule:
    # Daily at 19:00 UTC (04:00 JST)
    - cron: '0 19 * * *'
  workflow_dispatch:
    inputs:
      layer:
        description: 'Agent layer to run'
        required: true
        type: choice
        options:
          - observers
          - deciders
          - planners
          - implementers
      role:
        description: 'Specific role (optional, comma-separated)'
        required: false
        type: string
      dry_run:
        description: 'Show prompts without executing'
        required: false
        type: boolean
        default: false
      mock:
        description: 'Run in mock mode (no Jules API calls)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Scheduled run: execute observers layer
  scheduled:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Install jlo
        run: |
          curl -sSL https://github.com/akitorahayashi/jlo/releases/latest/download/jlo-linux-x86_64 -o jlo
          chmod +x jlo && sudo mv jlo /usr/local/bin/

      - name: Run observers
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: jlo run observers

  # Manual dispatch: run specified layer
  manual:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.layer == 'implementers' && 'main' || 'jules' }}

      - name: Install jlo
        run: |
          curl -sSL https://github.com/akitorahayashi/jlo/releases/latest/download/jlo-linux-x86_64 -o jlo
          chmod +x jlo && sudo mv jlo /usr/local/bin/

      - name: Parse role input
        id: parse
        run: |
          if [ -n "${{ inputs.role }}" ]; then
            # Convert comma-separated to --role flags
            roles=$(echo "${{ inputs.role }}" | tr ',' '\n' | sed 's/^/--role /' | tr '\n' ' ')
            echo "role_args=$roles" >> "$GITHUB_OUTPUT"
          else
            echo "role_args=" >> "$GITHUB_OUTPUT"
          fi

      - name: Run agents
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          ARGS=""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            ARGS="$ARGS --dry-run"
          fi
          if [ "${{ inputs.mock }}" = "true" ]; then
            ARGS="$ARGS --mock"
          fi
          jlo run ${{ inputs.layer }} ${{ steps.parse.outputs.role_args }}$ARGS
