name: Jules Workflows
on:
  schedule:
  - cron: 0 20 * * *
  workflow_dispatch:
    inputs:
      entry_point:
        description: Start from layer
        type: string
        default: narrator
      wait_minutes:
        description: Minutes to wait between layers (Jules async processing time)
        type: number
        default: 30
      routing_labels:
        description: Issue labels eligible for planner/implementer routing (comma-separated)
        type: string
        default: bugs,feats,refacts,tests,docs
      mock:
        description: Run in mock mode (creates branches/PRs without Jules API)
        type: boolean
        default: false
  workflow_call:
    inputs:
      entry_point:
        type: string
        default: narrator
      wait_minutes:
        type: number
        default: 30
      routing_labels:
        type: string
        default: bugs,feats,refacts,tests,docs
      mock:
        type: boolean
        default: false
permissions:
  contents: write
  issues: write
  pull-requests: write
concurrency:
  group: jules
  cancel-in-progress: false
env:
  WAIT_MINUTES: ${{ inputs.wait_minutes || 30 }}
  ROUTING_LABELS: ${{ inputs.routing_labels || 'bugs,feats,refacts,tests,docs' }}
  MOCK_MODE: ${{ inputs.mock || false }}
  JULES_MOCK_TAG: ${{ format('mock-run-{0}', github.run_id) }}
  JLO_RUN_FLAGS: ${{ (inputs.mock || false) && '--mock' || '' }}
jobs:
  run-narrator:
    if: |-
      vars.JULES_PAUSED != 'true' && (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') == 'narrator') ||
        (github.event_name == 'workflow_call' && (inputs.entry_point || 'narrator') == 'narrator')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      expected_count: ${{ steps.run-narrator.outputs.expected_count }}
      run_started_at: ${{ steps.run-narrator.outputs.run_started_at }}
      mock_pr_numbers_json: ${{ steps.run-narrator.outputs.mock_pr_numbers_json }}
      mock_branches_json: ${{ steps.run-narrator.outputs.mock_branches_json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Validate .jules workspace exists
      run: |
        if [ ! -d ".jules" ]; then
          echo "::error::.jules directory is missing on the 'jules' branch."
          exit 1
        fi
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run narrator
      id: run-narrator
      run: bash .github/scripts/jules-run-narrator.sh
    - name: Validate workspace (fail-fast)
      run: jlo doctor
  wait-after-narrator:
    needs: run-narrator
    if: |
      always() &&
      needs.run-narrator.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      pr_numbers_json: ${{ steps.wait.outputs.pr_numbers_json }}
      pr_heads_json: ${{ steps.wait.outputs.pr_heads_json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Wait for narrator PRs
      id: wait
      env:
        EXPECTED_COUNT: ${{ needs.run-narrator.outputs.expected_count }}
        RUN_STARTED_AT: ${{ needs.run-narrator.outputs.run_started_at }}
        BASE_BRANCH: jules
        CONTRACTS_PATH: .jules/roles/narrator/contracts.yml
        WAIT_MINUTES: ${{ env.WAIT_MINUTES }}
        MOCK_MODE: ${{ env.MOCK_MODE }}
        WAIT_MODE: merge
        MOCK_PR_NUMBERS_JSON: ${{ needs.run-narrator.outputs.mock_pr_numbers_json }}
      run: bash .github/scripts/jules-wait-for-prs.sh
  generate-workstream-matrix:
    needs: wait-after-narrator
    if: |
      always() &&
      vars.JULES_PAUSED != 'true' &&
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') &&
      (needs.wait-after-narrator.result == 'success' || needs.wait-after-narrator.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_workstreams: ${{ steps.matrix.outputs.has_workstreams }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Validate .jules workspace
      run: |
        if [ ! -d ".jules" ]; then
          echo "::error::.jules directory is missing on the 'jules' branch."
          exit 1
        fi
        if ! ls .jules/workstreams/*/scheduled.toml >/dev/null 2>&1; then
          echo "::error::No workstream scheduled.toml found under .jules/workstreams/."
          exit 1
        fi
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate workstream matrix
      id: matrix
      run: bash .github/scripts/jules-generate-workstream-matrix.sh
  generate-observer-matrix:
    needs: generate-workstream-matrix
    if: |-
      needs.generate-workstream-matrix.outputs.has_workstreams == 'true' && (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') != 'deciders') ||
        (github.event_name == 'workflow_call' && (inputs.entry_point || 'narrator') != 'deciders')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_observers: ${{ steps.matrix.outputs.has_observers }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate observer matrix
      id: matrix
      env:
        WORKSTREAMS_JSON: ${{ needs.generate-workstream-matrix.outputs.matrix }}
      run: bash .github/scripts/jules-generate-observer-matrix.sh
  run-observers:
    needs:
    - generate-workstream-matrix
    - generate-observer-matrix
    if: |
      always() &&
      needs.generate-observer-matrix.result == 'success' &&
      needs.generate-observer-matrix.outputs.has_observers == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      expected_count: ${{ steps.run-observers.outputs.expected_count }}
      run_started_at: ${{ steps.run-observers.outputs.run_started_at }}
      mock_pr_numbers_json: ${{ steps.run-observers.outputs.mock_pr_numbers_json }}
      mock_branches_json: ${{ steps.run-observers.outputs.mock_branches_json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run observers sequentially
      id: run-observers
      env:
        OBSERVER_MATRIX: ${{ needs.generate-observer-matrix.outputs.matrix }}
      run: bash .github/scripts/jules-run-observers-sequential.sh
  wait-after-observers:
    needs:
    - generate-observer-matrix
    - run-observers
    if: |
      always() &&
      needs.run-observers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      pr_numbers_json: ${{ steps.wait.outputs.pr_numbers_json }}
      pr_heads_json: ${{ steps.wait.outputs.pr_heads_json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Wait for observer PRs
      id: wait
      env:
        EXPECTED_COUNT: ${{ needs.run-observers.outputs.expected_count }}
        RUN_STARTED_AT: ${{ needs.run-observers.outputs.run_started_at }}
        BASE_BRANCH: jules
        CONTRACTS_PATH: .jules/roles/observers/contracts.yml
        WAIT_MINUTES: ${{ env.WAIT_MINUTES }}
        MOCK_MODE: ${{ env.MOCK_MODE }}
        WAIT_MODE: merge
        MOCK_PR_NUMBERS_JSON: ${{ needs.run-observers.outputs.mock_pr_numbers_json }}
      run: bash .github/scripts/jules-wait-for-prs.sh
  generate-decider-matrix:
    needs:
    - generate-workstream-matrix
    - generate-observer-matrix
    - wait-after-observers
    if: |
      always() &&
      needs.generate-workstream-matrix.outputs.has_workstreams == 'true' &&
      (needs.generate-observer-matrix.result == 'success' || needs.generate-observer-matrix.result == 'skipped') &&
      (needs.wait-after-observers.result == 'success' || needs.wait-after-observers.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_pending: ${{ steps.matrix.outputs.has_pending }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate decider matrix from pending events
      id: matrix
      env:
        WORKSTREAMS_JSON: ${{ needs.generate-workstream-matrix.outputs.matrix }}
      run: bash .github/scripts/jules-generate-decider-matrix.sh
  run-deciders:
    needs:
    - generate-decider-matrix
    if: |
      always() &&
      needs.generate-decider-matrix.result == 'success' &&
      needs.generate-decider-matrix.outputs.has_pending == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      expected_count: ${{ steps.run-deciders.outputs.expected_count }}
      run_started_at: ${{ steps.run-deciders.outputs.run_started_at }}
      mock_pr_numbers_json: ${{ steps.run-deciders.outputs.mock_pr_numbers_json }}
      mock_branches_json: ${{ steps.run-deciders.outputs.mock_branches_json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run deciders sequentially
      id: run-deciders
      env:
        DECIDER_MATRIX: ${{ needs.generate-decider-matrix.outputs.matrix }}
      run: bash .github/scripts/jules-run-deciders-sequential.sh
  wait-after-deciders:
    needs:
    - generate-decider-matrix
    - run-deciders
    if: |
      always() &&
      needs.run-deciders.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      pr_numbers_json: ${{ steps.wait.outputs.pr_numbers_json }}
      pr_heads_json: ${{ steps.wait.outputs.pr_heads_json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Wait for decider PRs
      id: wait
      env:
        EXPECTED_COUNT: ${{ needs.run-deciders.outputs.expected_count }}
        RUN_STARTED_AT: ${{ needs.run-deciders.outputs.run_started_at }}
        BASE_BRANCH: jules
        CONTRACTS_PATH: .jules/roles/deciders/contracts.yml
        WAIT_MINUTES: ${{ env.WAIT_MINUTES }}
        MOCK_MODE: ${{ env.MOCK_MODE }}
        WAIT_MODE: merge
        MOCK_PR_NUMBERS_JSON: ${{ needs.run-deciders.outputs.mock_pr_numbers_json }}
      run: bash .github/scripts/jules-wait-for-prs.sh
  generate-planner-matrix:
    needs:
    - generate-workstream-matrix
    - generate-decider-matrix
    - run-deciders
    - wait-after-deciders
    if: |
      always() &&
      needs.generate-workstream-matrix.outputs.has_workstreams == 'true' &&
      (needs.generate-decider-matrix.result == 'success' || needs.generate-decider-matrix.result == 'skipped') &&
      (needs.run-deciders.result == 'success' || needs.run-deciders.result == 'skipped') &&
      (needs.wait-after-deciders.result == 'success' || needs.wait-after-deciders.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      planner_matrix: ${{ steps.matrix.outputs.planner_matrix }}
      has_planners: ${{ steps.matrix.outputs.has_planners }}
      implementer_matrix: ${{ steps.matrix.outputs.implementer_matrix }}
      has_implementers: ${{ steps.matrix.outputs.has_implementers }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate planner and implementer matrices
      id: matrix
      env:
        WORKSTREAMS_JSON: ${{ needs.generate-workstream-matrix.outputs.matrix }}
        ROUTING_LABELS: ${{ env.ROUTING_LABELS }}
      run: bash .github/scripts/jules-generate-routing-matrices.sh
  run-planners:
    needs:
    - generate-planner-matrix
    if: |
      always() &&
      needs.generate-planner-matrix.result == 'success' &&
      needs.generate-planner-matrix.outputs.has_planners == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      expected_count: ${{ steps.run-planners.outputs.expected_count }}
      run_started_at: ${{ steps.run-planners.outputs.run_started_at }}
      mock_pr_numbers_json: ${{ steps.run-planners.outputs.mock_pr_numbers_json }}
      mock_branches_json: ${{ steps.run-planners.outputs.mock_branches_json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run planners sequentially
      id: run-planners
      env:
        PLANNER_MATRIX: ${{ needs.generate-planner-matrix.outputs.planner_matrix }}
      run: bash .github/scripts/jules-run-planners-sequential.sh
  wait-after-planners:
    needs:
    - run-planners
    if: |
      always() &&
      needs.run-planners.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      pr_numbers_json: ${{ steps.wait.outputs.pr_numbers_json }}
      pr_heads_json: ${{ steps.wait.outputs.pr_heads_json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      REPO: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Wait for planner PRs
      id: wait
      env:
        EXPECTED_COUNT: ${{ needs.run-planners.outputs.expected_count }}
        RUN_STARTED_AT: ${{ needs.run-planners.outputs.run_started_at }}
        BASE_BRANCH: jules
        CONTRACTS_PATH: .jules/roles/planners/contracts.yml
        WAIT_MINUTES: ${{ env.WAIT_MINUTES }}
        MOCK_MODE: ${{ env.MOCK_MODE }}
        WAIT_MODE: merge
        MOCK_PR_NUMBERS_JSON: ${{ needs.run-planners.outputs.mock_pr_numbers_json }}
      run: bash .github/scripts/jules-wait-for-prs.sh
  run-implementers:
    needs:
    - generate-planner-matrix
    if: |
      always() &&
      needs.generate-planner-matrix.result == 'success' &&
      needs.generate-planner-matrix.outputs.has_implementers == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      expected_count: ${{ steps.run-implementers.outputs.expected_count }}
      run_started_at: ${{ steps.run-implementers.outputs.run_started_at }}
      mock_pr_numbers_json: ${{ steps.run-implementers.outputs.mock_pr_numbers_json }}
      mock_branches_json: ${{ steps.run-implementers.outputs.mock_branches_json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      TARGET_BRANCH: ${{ vars.JULES_TARGET_BRANCH || 'main' }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Run implementers sequentially
      id: run-implementers
      env:
        IMPLEMENTER_MATRIX: ${{ needs.generate-planner-matrix.outputs.implementer_matrix }}
      run: bash .github/scripts/jules-run-implementers-sequential.sh
  wait-after-implementers:
    needs:
    - run-implementers
    if: |
      always() &&
      needs.run-implementers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      pr_numbers_json: ${{ steps.wait.outputs.pr_numbers_json }}
      pr_heads_json: ${{ steps.wait.outputs.pr_heads_json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      REPO: ${{ github.repository }}
      TARGET_BRANCH: ${{ vars.JULES_TARGET_BRANCH || 'main' }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Wait for implementer labels
      id: wait
      env:
        EXPECTED_COUNT: ${{ needs.run-implementers.outputs.expected_count }}
        RUN_STARTED_AT: ${{ needs.run-implementers.outputs.run_started_at }}
        BASE_BRANCH: ${{ vars.JULES_TARGET_BRANCH || 'main' }}
        CONTRACTS_PATH: .jules/roles/implementers/contracts.yml
        WAIT_MINUTES: ${{ env.WAIT_MINUTES }}
        MOCK_MODE: ${{ env.MOCK_MODE }}
        WAIT_MODE: label
        MOCK_PR_NUMBERS_JSON: ${{ needs.run-implementers.outputs.mock_pr_numbers_json }}
      run: bash .github/scripts/jules-wait-for-prs.sh
  cleanup-mock:
    needs:
    - run-narrator
    - run-observers
    - run-deciders
    - run-planners
    - run-implementers
    - wait-after-narrator
    - wait-after-observers
    - wait-after-deciders
    - wait-after-planners
    - wait-after-implementers
    if: |-
      always() && (
        (github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true') ||
        (github.event_name == 'workflow_call' && inputs.mock == true)
      )
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      REPO: ${{ github.repository }}
      MOCK_TAG: ${{ format('mock-run-{0}', github.run_id) }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Aggregate mock outputs
      id: aggregate
      run: |
        normalize() {
          local value="$1"
          if [ -z "$value" ] || [ "$value" = "null" ]; then
            echo "[]"
          else
            echo "$value"
          fi
        }

        pr_payloads=(
          "$(normalize "$${{ needs.run-narrator.outputs.mock_pr_numbers_json }}")"
          "$(normalize "$${{ needs.run-observers.outputs.mock_pr_numbers_json }}")"
          "$(normalize "$${{ needs.run-deciders.outputs.mock_pr_numbers_json }}")"
          "$(normalize "$${{ needs.run-planners.outputs.mock_pr_numbers_json }}")"
          "$(normalize "$${{ needs.run-implementers.outputs.mock_pr_numbers_json }}")"
        )

        branch_payloads=(
          "$(normalize "$${{ needs.run-narrator.outputs.mock_branches_json }}")"
          "$(normalize "$${{ needs.run-observers.outputs.mock_branches_json }}")"
          "$(normalize "$${{ needs.run-deciders.outputs.mock_branches_json }}")"
          "$(normalize "$${{ needs.run-planners.outputs.mock_branches_json }}")"
          "$(normalize "$${{ needs.run-implementers.outputs.mock_branches_json }}")"
        )

        pr_numbers_json=$(printf '%s\n' "${pr_payloads[@]}" | jq -s 'map(select(type=="array")) | add | unique')
        branches_json=$(printf '%s\n' "${branch_payloads[@]}" | jq -s 'map(select(type=="array")) | add | unique')

        echo "pr_numbers_json=$pr_numbers_json" >> "$GITHUB_OUTPUT"
        echo "branches_json=$branches_json" >> "$GITHUB_OUTPUT"
    - name: Cleanup mock artifacts
      env:
        MOCK_PR_NUMBERS_JSON: ${{ steps.aggregate.outputs.pr_numbers_json }}
        MOCK_BRANCHES_JSON: ${{ steps.aggregate.outputs.branches_json }}
      run: bash .github/scripts/jules-mock-cleanup.sh
