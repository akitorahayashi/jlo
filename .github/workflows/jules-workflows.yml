# Jules Agent Orchestration
#
# Coordinates scheduled agent execution and event-driven workflows.
# Uses reusable workflows for each agent type.
#
# Flow:
#   Scheduled: sync-jules → observers
#   On push to events/: decider
#   On push to issues/: planners (matrix)
#   On push to tasks/: implementers (matrix)

name: Jules Workflows

on:
  schedule:
    # Daily at 19:00 UTC (04:00 JST) - triggers sync + observers
    - cron: '0 19 * * *'
  push:
    branches: [jules]
    paths:
      - '.jules/exchange/events/**/*.yml'
      - '.jules/exchange/issues/*.yml'
      - '.jules/exchange/tasks/*.yml'
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent type to run'
        required: true
        type: choice
        options:
          - observers
          - decider
          - planners
          - implementers


permissions:
  contents: write

jobs:
  # ============================================================================
  # Sync main → jules (before observers)
  # ============================================================================
  sync:
    if: github.event_name == 'schedule' && github.event.schedule == '0 19 * * *' || (github.event_name == 'workflow_dispatch' && inputs.agent == 'observers')
    uses: ./.github/workflows/sync-jules.yml

  # ============================================================================
  # Scheduled Observers (after sync)
  # ============================================================================
  list-observers:
    needs: sync
    if: |
      always() && needs.sync.result == 'success' &&
      (github.event_name == 'schedule' && github.event.schedule == '0 19 * * *' ||
       (github.event_name == 'workflow_dispatch' && inputs.agent == 'observers'))
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      has_roles: ${{ steps.scan.outputs.has_roles }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Discover observer roles
        id: scan
        run: |
          dir=".jules/roles/observers"
          if [ ! -d "$dir" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Read enabled observers from file
          enabled_file="$dir/enabled-observers.txt"
          if [ ! -f "$enabled_file" ]; then
            echo "Warning: $enabled_file not found"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          roles_list=()
          while IFS= read -r role; do
            [ -n "$role" ] && roles_list+=("$role")
          done < "$enabled_file"

          # Verify roles exist
          valid_roles=()
          for role in "${roles_list[@]}"; do
            if [ -d "$dir/$role" ]; then
              valid_roles+=("$role")
            else
              echo "Warning: Role '$role' not found in $dir"
            fi
          done

          if [ ${#valid_roles[@]} -eq 0 ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          roles=$(printf "%s\n" "${valid_roles[@]}" \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')
          if [ "$roles" = "[]" ] || [ -z "$roles" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
          else
            echo "matrix=$roles" >> "$GITHUB_OUTPUT"
            echo "has_roles=true" >> "$GITHUB_OUTPUT"
          fi

  observers:
    needs: [sync, list-observers]
    if: |
      always() && needs.sync.result == 'success' && needs.list-observers.outputs.has_roles == 'true' &&
      (github.event_name == 'schedule' && github.event.schedule == '0 19 * * *' || 
       (github.event_name == 'workflow_dispatch' && inputs.agent == 'observers'))
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        role: ${{ fromJson(needs.list-observers.outputs.matrix) }}
    uses: ./.github/workflows/run-observer.yml
    with:
      role: ${{ matrix.role }}
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}

  # ============================================================================
  # Decider (triggered when new events are merged)
  # ============================================================================
  list-events:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.agent == 'decider')
    runs-on: ubuntu-latest
    outputs:
      has_events: ${{ steps.scan.outputs.has_events }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Detect event changes
        id: scan
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="$(git rev-parse HEAD~1)"
            fi
            changed=$(git diff --name-status "$base" "$head" | awk '$1 ~ /^[AM]$/ {print $2}')
            matches=$(printf "%s\n" "$changed" | grep '^\.jules/exchange/events/.*\.yml$' || true)
            if [ -n "$matches" ]; then
              echo "has_events=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_events=false" >> "$GITHUB_OUTPUT"
            fi
          else
            count=$(find .jules/exchange/events -name "*.yml" -type f 2>/dev/null | wc -l | tr -d ' ')
            if [ "$count" != "0" ]; then
              echo "has_events=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_events=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  decider:
    needs: list-events
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.agent == 'decider') ||
      (github.event_name == 'push' && needs.list-events.outputs.has_events == 'true')
    uses: ./.github/workflows/run-decider.yml
    with:
      role: triage
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}

  # ============================================================================
  # On-Demand Planners (push to issues/)
  # ============================================================================
  list-issues:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.agent == 'planners')
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      has_issues: ${{ steps.scan.outputs.has_issues }}
    steps:
      - uses: actions/checkout@v4

      - name: Scan for issues
        id: scan
        run: |
          dir=".jules/exchange/issues"
          if [ ! -d "$dir" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_issues=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "${{ github.event_name }}" = "push" ]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="$(git rev-parse HEAD~1)"
            fi
            changed=$(git diff --name-status "$base" "$head" | awk '$1 ~ /^[AM]$/ {print $2}')
            files=$(printf "%s\n" "$changed" | grep '^\.jules/exchange/issues/.*\.yml$' | sed 's#.*/##' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            files=$(find "$dir" -maxdepth 1 -name "*.yml" -type f -exec basename {} \; 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          if [ "$files" = "[]" ] || [ -z "$files" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_issues=false" >> "$GITHUB_OUTPUT"
          else
            echo "matrix=$files" >> "$GITHUB_OUTPUT"
            echo "has_issues=true" >> "$GITHUB_OUTPUT"
          fi

  planners:
    needs: list-issues
    if: needs.list-issues.outputs.has_issues == 'true'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        issue: ${{ fromJson(needs.list-issues.outputs.matrix) }}
    uses: ./.github/workflows/run-planner.yml
    with:
      role: specifier
      issue_file: ${{ matrix.issue }}
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}

  # ============================================================================
  # On-Demand Implementers (push to tasks/)
  # ============================================================================
  list-tasks:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.agent == 'implementers')
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      has_tasks: ${{ steps.scan.outputs.has_tasks }}
    steps:
      - uses: actions/checkout@v4

      - name: Scan for tasks
        id: scan
        run: |
          dir=".jules/exchange/tasks"
          if [ ! -d "$dir" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_tasks=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ "${{ github.event_name }}" = "push" ]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="$(git rev-parse HEAD~1)"
            fi
            changed=$(git diff --name-status "$base" "$head" | awk '$1 ~ /^[AM]$/ {print $2}')
            files=$(printf "%s\n" "$changed" | grep '^\.jules/exchange/tasks/.*\.yml$' | sed 's#.*/##' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          else
            files=$(find "$dir" -maxdepth 1 -name "*.yml" -type f -exec basename {} \; 2>/dev/null | jq -R -s -c 'split("\n") | map(select(length > 0))')
          fi
          if [ "$files" = "[]" ] || [ -z "$files" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_tasks=false" >> "$GITHUB_OUTPUT"
          else
            echo "matrix=$files" >> "$GITHUB_OUTPUT"
            echo "has_tasks=true" >> "$GITHUB_OUTPUT"
          fi

  implementers:
    needs: list-tasks
    if: needs.list-tasks.outputs.has_tasks == 'true'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        task: ${{ fromJson(needs.list-tasks.outputs.matrix) }}
    uses: ./.github/workflows/run-implementer.yml
    with:
      task_file: ${{ matrix.task }}
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}
