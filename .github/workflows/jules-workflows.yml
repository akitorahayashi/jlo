# Jules Agent Orchestration
#
# Coordinates scheduled agent execution and event-driven workflows.
# Uses reusable workflows for each agent type.
#
# Flow:
#   Scheduled: sync-jules → observers
#   On push to events/: decider
#   On push to issues/: issue promotion OR planner (based on requires_deep_analysis)

name: Jules Workflows

on:
  schedule:
    # Daily at 19:00 UTC (04:00 JST) - triggers sync + observers
    - cron: '0 19 * * *'
  push:
    branches: [jules]
    paths:
      - '.jules/exchange/events/**/*.yml'
      - '.jules/exchange/issues/*.yml'
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent type to run'
        required: true
        type: choice
        options:
          - observers
          - decider
          - issue-sync
          - planners


permissions:
  contents: write
  issues: write

jobs:
  # ============================================================================
  # Sync main → jules (before observers)
  # ============================================================================
  sync:
    if: github.event_name == 'schedule' && github.event.schedule == '0 19 * * *' || (github.event_name == 'workflow_dispatch' && inputs.agent == 'observers')
    uses: ./.github/workflows/sync-jules.yml

  # ============================================================================
  # Scheduled Observers (after sync)
  # ============================================================================
  list-observers:
    needs: sync
    if: |
      always() && needs.sync.result == 'success' &&
      (github.event_name == 'schedule' && github.event.schedule == '0 19 * * *' ||
       (github.event_name == 'workflow_dispatch' && inputs.agent == 'observers'))
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.scan.outputs.matrix }}
      has_roles: ${{ steps.scan.outputs.has_roles }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Discover observer roles
        id: scan
        run: |
          dir=".jules/roles/observers"
          if [ ! -d "$dir" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          # Read enabled observers from config
          config_file=".github/config/jules.json"
          if [ ! -f "$config_file" ]; then
            echo "Warning: $config_file not found"
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          roles_list=()
          while IFS= read -r role; do
            [ -n "$role" ] && roles_list+=("$role")
          done < <(jq -r '.observers[]' "$config_file")

          # Verify roles exist
          valid_roles=()
          for role in "${roles_list[@]}"; do
            if [ -d "$dir/$role" ]; then
              valid_roles+=("$role")
            else
              echo "Warning: Role '$role' not found in $dir"
            fi
          done

          if [ ${#valid_roles[@]} -eq 0 ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          roles=$(printf "%s\n" "${valid_roles[@]}" \
            | jq -R -s -c 'split("\n") | map(select(length > 0))')
          if [ "$roles" = "[]" ] || [ -z "$roles" ]; then
            echo "matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
          else
            echo "matrix=$roles" >> "$GITHUB_OUTPUT"
            echo "has_roles=true" >> "$GITHUB_OUTPUT"
          fi

  observers:
    needs: [sync, list-observers]
    if: |
      always() && needs.sync.result == 'success' && needs.list-observers.outputs.has_roles == 'true' &&
      (github.event_name == 'schedule' && github.event.schedule == '0 19 * * *' || 
       (github.event_name == 'workflow_dispatch' && inputs.agent == 'observers'))
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        role: ${{ fromJson(needs.list-observers.outputs.matrix) }}
    uses: ./.github/workflows/run-observer.yml
    with:
      role: ${{ matrix.role }}
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}

  # ============================================================================
  # Decider (triggered when new events are merged)
  # ============================================================================
  list-events:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.agent == 'decider')
    runs-on: ubuntu-latest
    outputs:
      has_events: ${{ steps.scan.outputs.has_events }}
      decider_roles: ${{ steps.roles.outputs.roles }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Load decider roles
        id: roles
        run: |
          config=".github/config/jules.json"
          if [ ! -f "$config" ]; then
            echo "Error: missing $config"
            exit 1
          fi
          roles=$(jq -c '.deciders // []' "$config")
          if [ "$roles" = "[]" ] || [ -z "$roles" ]; then
            echo "Error: no decider roles configured in $config"
            exit 1
          fi
          echo "roles=$roles" >> "$GITHUB_OUTPUT"

      - name: Detect event changes
        id: scan
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="$(git rev-parse HEAD~1)"
            fi
            changed=$(git diff --name-status "$base" "$head" | awk '$1 ~ /^[AM]$/ {print $2}')
            matches=$(printf "%s\n" "$changed" | grep '^\.jules/exchange/events/.*\.yml$' || true)
            if [ -n "$matches" ]; then
              echo "has_events=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_events=false" >> "$GITHUB_OUTPUT"
            fi
          else
            count=$(find .jules/exchange/events -name "*.yml" -type f 2>/dev/null | wc -l | tr -d ' ')
            if [ "$count" != "0" ]; then
              echo "has_events=true" >> "$GITHUB_OUTPUT"
            else
              echo "has_events=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  decider:
    needs: list-events
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.agent == 'decider') ||
      (github.event_name == 'push' && needs.list-events.outputs.has_events == 'true')
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        role: ${{ fromJson(needs.list-events.outputs.decider_roles) }}
    uses: ./.github/workflows/run-decider.yml
    with:
      role: ${{ matrix.role }}
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}

  # ============================================================================
  # On-Demand Planners (push to issues/ with requires_deep_analysis: true)
  # ============================================================================
  list-issues:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && (inputs.agent == 'planners' || inputs.agent == 'issue-sync'))
    runs-on: ubuntu-latest
    outputs:
      planner_matrix: ${{ steps.scan.outputs.planner_matrix }}
      has_planner_issues: ${{ steps.scan.outputs.has_planner_issues }}
      sync_matrix: ${{ steps.scan.outputs.sync_matrix }}
      has_sync_issues: ${{ steps.scan.outputs.has_sync_issues }}
      planner_roles: ${{ steps.roles.outputs.roles }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Load planner roles
        id: roles
        run: |
          config=".github/config/jules.json"
          if [ ! -f "$config" ]; then
            echo "Error: missing $config"
            exit 1
          fi
          roles=$(jq -c '.planners // []' "$config")
          if [ "$roles" = "[]" ] || [ -z "$roles" ]; then
            echo "Error: no planner roles configured in $config"
            exit 1
          fi
          echo "roles=$roles" >> "$GITHUB_OUTPUT"

      - name: Scan for issues
        id: scan
        run: |
          dir=".jules/exchange/issues"
          if [ ! -d "$dir" ]; then
            echo "planner_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_planner_issues=false" >> "$GITHUB_OUTPUT"
            echo "sync_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_sync_issues=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          # Get changed files
          if [ "${{ github.event_name }}" = "push" ]; then
            base="${{ github.event.before }}"
            head="${{ github.sha }}"
            if [ -z "$base" ] || [ "$base" = "0000000000000000000000000000000000000000" ]; then
              base="$(git rev-parse HEAD~1)"
            fi
            changed=$(git diff --name-status "$base" "$head" | awk '$1 ~ /^[AM]$/ {print $2}')
            files=$(printf "%s\n" "$changed" | grep '^\.jules/exchange/issues/.*\.yml$' || true)
          else
            files=$(find "$dir" -maxdepth 1 -name "*.yml" -type f 2>/dev/null || true)
          fi
          
          # Separate into planner (requires_deep_analysis: true) and sync (false)
          planner_files=()
          sync_files=()
          
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            requires_deep=$(yq -r '.requires_deep_analysis // false' "$file" 2>/dev/null || echo "false")
            if [ "$requires_deep" = "true" ]; then
              planner_files+=("$(basename "$file")")
            else
              sync_files+=("$file")
            fi
          done <<< "$files"
          
          # Output planner matrix (basenames for run-planner.yml)
          if [ ${#planner_files[@]} -eq 0 ]; then
            echo "planner_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_planner_issues=false" >> "$GITHUB_OUTPUT"
          else
            planner_json=$(printf '%s\n' "${planner_files[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "planner_matrix=$planner_json" >> "$GITHUB_OUTPUT"
            echo "has_planner_issues=true" >> "$GITHUB_OUTPUT"
          fi
          
          # Output sync matrix (full paths for issue-sync action)
          if [ ${#sync_files[@]} -eq 0 ]; then
            echo "sync_matrix=[]" >> "$GITHUB_OUTPUT"
            echo "has_sync_issues=false" >> "$GITHUB_OUTPUT"
          else
            sync_json=$(printf '%s\n' "${sync_files[@]}" | jq -R -s -c 'split("\n") | map(select(length > 0))')
            echo "sync_matrix=$sync_json" >> "$GITHUB_OUTPUT"
            echo "has_sync_issues=true" >> "$GITHUB_OUTPUT"
          fi

  # Issue Promotion (sync to GitHub Issues)
  issue-sync:
    needs: list-issues
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.agent == 'issue-sync') ||
      (needs.list-issues.outputs.has_sync_issues == 'true')
    strategy:
      fail-fast: false
      matrix:
        issue_file: ${{ fromJson(needs.list-issues.outputs.sync_matrix) }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Sync issue to GitHub
        uses: ./.github/actions/jules-issue-sync
        with:
          issue_file: ${{ matrix.issue_file }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

  planners:
    needs: list-issues
    if: needs.list-issues.outputs.has_planner_issues == 'true'
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        role: ${{ fromJson(needs.list-issues.outputs.planner_roles) }}
        issue: ${{ fromJson(needs.list-issues.outputs.planner_matrix) }}
    uses: ./.github/workflows/run-planner.yml
    with:
      role: ${{ matrix.role }}
      issue_file: ${{ matrix.issue }}
    secrets:
      jules_api_key: ${{ secrets.JULES_API_KEY }}
