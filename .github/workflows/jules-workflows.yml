name: Jules Workflows
on:
  schedule:
  - cron: 0 20 * * *
  workflow_dispatch:
    inputs:
      entry_point:
        description: Start from layer
        type: choice
        options:
        - narrator
        - observers
        - deciders
        - planners
        - implementers
        default: narrator
      wait_minutes:
        description: Minutes to wait between layers (Jules async processing time)
        type: number
        default: 30
      routing_labels:
        description: Issue labels eligible for planner/implementer routing (comma-separated)
        type: string
        default: bugs,feats,refacts,tests,docs
      mock:
        description: Run in mock mode (creates branches/PRs without Jules API)
        type: boolean
        default: false
  workflow_call:
    inputs:
      entry_point:
        type: string
        default: narrator
      wait_minutes:
        type: number
        default: 30
      routing_labels:
        type: string
        default: bugs,feats,refacts,tests,docs
      mock:
        type: boolean
        default: false
permissions:
  contents: write
  issues: write
  pull-requests: write
concurrency:
  group: jules
  cancel-in-progress: false
env:
  WAIT_MINUTES: ${{ inputs.wait_minutes || 30 }}
  ROUTING_LABELS: ${{ inputs.routing_labels || 'bugs,feats,refacts,tests,docs' }}
  MOCK_MODE: ${{ (github.event.inputs.mock == 'true') || (inputs.mock == true) }}
  JULES_MOCK_TAG: ${{ format('mock-run-{0}', github.run_id) }}
  JLO_RUN_FLAGS: ${{ ((github.event.inputs.mock == 'true') || (inputs.mock == true)) && '--mock' || '' }}
jobs:
  run-narrator:
    if: |-
      vars.JULES_PAUSED != 'true' && (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') == 'narrator') ||
        (github.event_name == 'workflow_call' && (inputs.entry_point || 'narrator') == 'narrator')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Validate .jules workspace exists
      run: |
        if [ ! -d ".jules" ]; then
          echo "::error::.jules directory is missing on the 'jules' branch."
          exit 1
        fi
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run narrator
      id: run
      run: jlo workflow run global narrator ${{ env.JLO_RUN_FLAGS }}
    - name: Validate workspace (fail-fast)
      run: jlo doctor
  wait-after-narrator:
    needs: run-narrator
    if: |
      always() &&
      needs.run-narrator.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
      id: wait
      uses: ./.github/actions/wait
      with:
        wait_minutes: ${{ env.WAIT_MINUTES }}
        mock_mode: ${{ env.MOCK_MODE }}
        process_name: narrator
  generate-workstream-matrix:
    needs: wait-after-narrator
    if: |
      always() &&
      vars.JULES_PAUSED != 'true' &&
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') &&
      (needs.wait-after-narrator.result == 'success' || needs.wait-after-narrator.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      json: ${{ steps.matrix.outputs.json }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Validate .jules workspace
      run: |
        if [ ! -d ".jules" ]; then
          echo "::error::.jules directory is missing on the 'jules' branch."
          exit 1
        fi
        if ! ls .jules/workstreams/*/scheduled.toml >/dev/null 2>&1; then
          echo "::error::No workstream scheduled.toml found under .jules/workstreams/."
          exit 1
        fi
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate workstream matrix
      id: matrix
      run: jlo workflow matrix workstreams
  run-observers:
    needs: generate-workstream-matrix
    if: |
      always() &&
      needs.generate-workstream-matrix.result == 'success' &&
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run observers for each workstream
      id: run
      env:
        WORKSTREAMS_OUTPUT: ${{ needs.generate-workstream-matrix.outputs.json }}
      run: |
        set -euo pipefail
        echo "$WORKSTREAMS_OUTPUT" | jq -r '.matrix.include[].workstream' | while read ws; do
          echo "Running observers for workstream: $ws"
          jlo workflow run "$ws" observers ${{ env.JLO_RUN_FLAGS }}
        done
  wait-after-observers:
    needs:
    - generate-workstream-matrix
    - run-observers
    if: |
      always() &&
      needs.run-observers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
      id: wait
      uses: ./.github/actions/wait
      with:
        wait_minutes: ${{ env.WAIT_MINUTES }}
        mock_mode: ${{ env.MOCK_MODE }}
        process_name: observers
  generate-decider-matrix:
    needs:
    - generate-workstream-matrix
    - wait-after-observers
    if: |
      always() &&
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true &&
      (needs.wait-after-observers.result == 'success' || needs.wait-after-observers.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      json: ${{ steps.matrix.outputs.json }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate decider matrix from pending events
      id: matrix
      env:
        WORKSTREAMS_OUTPUT: ${{ needs.generate-workstream-matrix.outputs.json }}
      run: |
        WORKSTREAMS_JSON=$(echo "$WORKSTREAMS_OUTPUT" | jq -c '.matrix')
        jlo workflow matrix pending-workstreams --workstreams-json "$WORKSTREAMS_JSON"
  run-deciders:
    needs:
    - generate-decider-matrix
    if: |
      always() &&
      needs.generate-decider-matrix.result == 'success' &&
      fromJSON(needs.generate-decider-matrix.outputs.json).has_pending == true
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run deciders for each pending workstream
      id: run
      env:
        MATRIX_OUTPUT: ${{ needs.generate-decider-matrix.outputs.json }}
      run: |
        set -euo pipefail
        echo "$MATRIX_OUTPUT" | jq -r '.matrix.include[].workstream' | while read ws; do
          echo "Running deciders for workstream: $ws"
          jlo workflow run "$ws" deciders ${{ env.JLO_RUN_FLAGS }}
        done
  wait-after-deciders:
    needs:
    - generate-decider-matrix
    - run-deciders
    if: |
      always() &&
      needs.run-deciders.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
      id: wait
      uses: ./.github/actions/wait
      with:
        wait_minutes: ${{ env.WAIT_MINUTES }}
        mock_mode: ${{ env.MOCK_MODE }}
        process_name: deciders
  generate-planner-matrix:
    needs:
    - generate-workstream-matrix
    - generate-decider-matrix
    - run-deciders
    - wait-after-deciders
    if: |
      always() &&
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true &&
      (needs.generate-decider-matrix.result == 'success' || needs.generate-decider-matrix.result == 'skipped') &&
      (needs.run-deciders.result == 'success' || needs.run-deciders.result == 'skipped') &&
      (needs.wait-after-deciders.result == 'success' || needs.wait-after-deciders.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      json: ${{ steps.matrix.outputs.json }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Generate planner and implementer matrices
      id: matrix
      env:
        WORKSTREAMS_OUTPUT: ${{ needs.generate-workstream-matrix.outputs.json }}
      run: |
        WORKSTREAMS_JSON=$(echo "$WORKSTREAMS_OUTPUT" | jq -c '.matrix')
        jlo workflow matrix routing --workstreams-json "$WORKSTREAMS_JSON" --routing-labels "$ROUTING_LABELS"
  run-planners:
    needs:
    - generate-planner-matrix
    if: |
      always() &&
      needs.generate-planner-matrix.result == 'success' &&
      fromJSON(needs.generate-planner-matrix.outputs.json).has_planners == true
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Run planners for each workstream
      id: run
      env:
        MATRIX_OUTPUT: ${{ needs.generate-planner-matrix.outputs.json }}
      run: |
        set -euo pipefail
        echo "$MATRIX_OUTPUT" | jq -r '.planner_matrix.include[].workstream // empty' | sort -u | while read ws; do
          [ -z "$ws" ] && continue
          echo "Running planners for workstream: $ws"
          jlo workflow run "$ws" planners ${{ env.JLO_RUN_FLAGS }}
        done
  wait-after-planners:
    needs:
    - run-planners
    if: |
      always() &&
      needs.run-planners.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
      id: wait
      uses: ./.github/actions/wait
      with:
        wait_minutes: ${{ env.WAIT_MINUTES }}
        mock_mode: ${{ env.MOCK_MODE }}
        process_name: planners
  run-implementers:
    needs:
    - generate-planner-matrix
    if: |
      always() &&
      needs.generate-planner-matrix.result == 'success' &&
      fromJSON(needs.generate-planner-matrix.outputs.json).has_implementers == true
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      json: ${{ steps.run.outputs.json }}
    env:
      JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
      TARGET_BRANCH: ${{ vars.JULES_TARGET_BRANCH || 'main' }}
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Configure Git
      uses: ./.github/actions/configure-git
    - name: Run implementers for each workstream
      id: run
      env:
        MATRIX_OUTPUT: ${{ needs.generate-planner-matrix.outputs.json }}
      run: |
        set -euo pipefail
        echo "$MATRIX_OUTPUT" | jq -r '.implementer_matrix.include[].workstream // empty' | sort -u | while read ws; do
          [ -z "$ws" ] && continue
          echo "Running implementers for workstream: $ws"
          jlo workflow run "$ws" implementers ${{ env.JLO_RUN_FLAGS }}
        done
  wait-after-implementers:
    needs:
    - run-implementers
    if: |
      always() &&
      needs.run-implementers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      json: ${{ steps.wait.outputs.json }}
    env:
      GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
      GITHUB_REPOSITORY: ${{ github.repository }}
      TARGET_BRANCH: ${{ vars.JULES_TARGET_BRANCH || 'main' }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: jules
        fetch-depth: 0
        token: ${{ secrets.JLO_BOT_TOKEN }}
    - name: Install jlo
      uses: ./.github/actions/install-jlo
    - name: Wait ${{ env.WAIT_MINUTES }} minutes for Jules async processing
      id: wait
      uses: ./.github/actions/wait
      with:
        wait_minutes: ${{ env.WAIT_MINUTES }}
        mock_mode: ${{ env.MOCK_MODE }}
        process_name: implementers
