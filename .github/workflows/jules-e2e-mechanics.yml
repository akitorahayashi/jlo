name: Jules E2E Mechanics

on:
  workflow_dispatch:
    inputs:
      run_pr_automerge:
        description: 'Run PR creation and auto-merge test'
        type: boolean
        default: true
      run_issue_creation:
        description: 'Run issue creation test'
        type: boolean
        default: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  test-pr-automerge:
    if: inputs.run_pr_automerge
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Resolve observer branch prefix
        id: branch
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f ".jules/JULES.md" ]; then
            echo "Missing .jules/JULES.md in the jules branch." >&2
            exit 1
          fi

          pattern=$(grep -n "Observers:" .jules/JULES.md | head -n 1 | sed -n 's/.*`\(jules-[^`]*\)`/\1/p')
          if [ -z "$pattern" ]; then
            echo "Could not resolve observer branch pattern from .jules/JULES.md." >&2
            exit 1
          fi

          prefix="${pattern%%<*}"
          if [ -z "$prefix" ]; then
            echo "Observer branch prefix is empty." >&2
            exit 1
          fi

          echo "prefix=$prefix" >> "$GITHUB_OUTPUT"

      - name: Create test branch
        shell: bash
        run: |
          set -euo pipefail
          RANDOM_ID=$(printf '%04x' "$RANDOM")
          BRANCH="${{ steps.branch.outputs.prefix }}${RANDOM_ID}"

          CATEGORY=$(ls -1 .jules/exchange/events | head -n 1 || true)
          if [ -z "$CATEGORY" ]; then
            echo "No exchange event categories found under .jules/exchange/events." >&2
            exit 1
          fi

          ROLE=$(find .jules/roles/observers -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | head -n 1 || true)
          if [ -z "$ROLE" ]; then
            echo "No observer roles found under .jules/roles/observers." >&2
            exit 1
          fi

          escape_sed() {
            printf '%s' "$1" | sed -e 's/[\\/&]/\\&/g'
          }

          render_template() {
            local template="$1"
            local output="$2"
            shift 2

            cp "$template" "$output"
            while [ "$#" -gt 1 ]; do
              local placeholder="$1"
              local value="$2"
              shift 2
              value=$(escape_sed "$value")
              sed -i "s|$placeholder|$value|g" "$output"
            done
          }

          EVENT_ID="$(date -u +%Y-%m-%d_%H%M%S)_${CATEGORY}_${ROLE}_${RANDOM_ID}"
          EVENT_DATE="$(date -u +%Y-%m-%d)"
          EVENT_PATH=".jules/exchange/events/$CATEGORY/${EVENT_ID}.yml"
          EVENT_TEMPLATE=".github/assets/jules-e2e/event.yml"

          mkdir -p ".jules/exchange/events/$CATEGORY"

          render_template \
            "$EVENT_TEMPLATE" \
            "$EVENT_PATH" \
            "__EVENT_ID__" "$EVENT_ID" \
            "__EVENT_DATE__" "$EVENT_DATE" \
            "__ROLE__" "$ROLE" \
            "__CATEGORY__" "$CATEGORY" \
            "__EVENT_TITLE__" "E2E observer event" \
            "__EVENT_STATEMENT__" "Synthetic observer event created for auto-merge validation." \
            "__EVIDENCE_PATH__" "README.md" \
            "__EVIDENCE_LOC__" "# .jules/" \
            "__EVIDENCE_NOTE__" "Validates the observer event flow for e2e mechanics." \
            "__EVENT_TAG__" "e2e"

          git checkout -b "$BRANCH"
          git add "$EVENT_PATH"
          git commit -m "E2E: Observer event for workflow validation $RANDOM_ID"
          git push origin "$BRANCH"

          echo "BRANCH=$BRANCH" >> "$GITHUB_ENV"

      - name: Create PR
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base jules \
            --head "$BRANCH" \
            --title "[E2E Test] Workflow validation" \
            --body "Automated E2E test. Will be auto-merged and deleted.")

          echo "Created PR: $PR_URL"
          echo "PR_URL=$PR_URL" >> "$GITHUB_ENV"

      - name: Wait for merge
        id: wait-merge
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          echo "Waiting for auto-merge..."

          for i in {1..120}; do
            STATE=$(gh pr view "$PR_URL" --json state -q '.state')

            if [ "$STATE" = "MERGED" ]; then
              echo "âœ… PR merged successfully"
              echo "result=success" >> "$GITHUB_OUTPUT"
              exit 0
            elif [ "$STATE" = "CLOSED" ]; then
              echo "âŒ PR was closed but not merged"
              echo "result=closed" >> "$GITHUB_OUTPUT"
              exit 1
            fi

            echo "State: $STATE - Waiting... ($i/120)"
            sleep 10
          done

          echo "âŒ Timeout waiting for merge"
          echo "result=timeout" >> "$GITHUB_OUTPUT"
          exit 1

      - name: Cleanup
        if: always()
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          echo "Run Result: ${{ steps.wait-merge.outcome }}"

          if [ -n "$PR_URL" ]; then
             STATE=$(gh pr view "$PR_URL" --json state -q '.state')

             if [ "$STATE" != "MERGED" ]; then
               echo "ðŸ§¹ Closing failed/stalled PR: $PR_URL"
               gh pr close "$PR_URL" --delete-branch || echo "âš ï¸ Failed to close PR (might be already closed)"
             else
               echo "âœ¨ PR was successfully merged. No cleanup needed."
             fi

          elif [ -n "$BRANCH" ]; then
             echo "ðŸ§¹ Deleting via git push: $BRANCH"
             git push origin --delete "$BRANCH" || echo "âš ï¸ Failed to delete branch (might not exist)"
          fi

  test-issue-creation:
    if: inputs.run_issue_creation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Create test issue
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          ISSUE_URL=$(gh issue create \
            --title "[E2E Test] Issue creation validation" \
            --body "Automated E2E test. Will be closed immediately." \
            --repo "${{ github.repository }}")

          echo "âœ… Created Issue: $ISSUE_URL"
          echo "ISSUE_URL=$ISSUE_URL" >> "$GITHUB_ENV"

      - name: Close test issue
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          gh issue close "$ISSUE_URL" --repo "${{ github.repository }}"
          echo "âœ… Closed Issue successfully"
