name: Jules Workstream

on:
  workflow_call:
    inputs:
      workstream:
        required: true
        type: string
      entry_point:
        required: false
        type: string
        default: observers
      wait_minutes:
        required: false
        type: number
        default: 15
      routing_labels:
        required: false
        type: string
        default: docs,tests
    secrets:
      JULES_API_KEY:
        required: true

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  observer-matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_roles: ${{ steps.matrix.outputs.has_roles }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Export observer roles
        id: matrix
        env:
          WORKSTREAM: ${{ inputs.workstream }}
        run: |
          set -euo pipefail
          matrix=$(
            timeout 20s bash -lc \
              "set -euo pipefail; jlo schedule export --scope roles --layer observers --workstream \"$WORKSTREAM\" --format github-matrix | jq -c 'del(.schema_version)'"
          ) || { echo "::error::Timed out while generating observer role matrix (jlo schedule export)"; exit 1; }
          count=$(echo "$matrix" | jq '.include | length')
          if [ "$count" -gt 0 ]; then
            echo "has_roles=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
          fi
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  observers:
    needs: observer-matrix
    if: inputs.entry_point == 'observers' && needs.observer-matrix.outputs.has_roles == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
      matrix: ${{ fromJson(needs.observer-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Run observer
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          timeout 20m jlo run observers --workstream "${{ matrix.workstream }}" --role "${{ matrix.role }}"

  wait-after-observers:
    needs: observers
    if: inputs.entry_point == 'observers' && needs.observers.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Wait for observers
        run: |
          WAIT_SECONDS=$(( ${{ inputs.wait_minutes }} * 60 ))
          echo "⏳ Waiting ${WAIT_SECONDS}s for Jules to complete observer tasks..."
          sleep "$WAIT_SECONDS"

  doctor-after-observers:
    needs: [observers, wait-after-observers]
    if: >-
      always() &&
      needs.observers.result != 'failure' &&
      needs.wait-after-observers.result != 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Validate workstream
        run: timeout 2m jlo doctor --workstream "${{ inputs.workstream }}"

  inspect-workstream:
    needs: doctor-after-observers
    if: >-
      always() &&
      (inputs.entry_point == 'deciders' || needs.doctor-after-observers.result == 'success')
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has_pending: ${{ steps.inspect.outputs.has_pending }}
      pending_count: ${{ steps.inspect.outputs.pending_count }}
      issues_before: ${{ steps.inspect.outputs.issues_before }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Inspect workstream
        id: inspect
        env:
          WORKSTREAM: ${{ inputs.workstream }}
        run: |
          set -euo pipefail
          output=$(timeout 20s jlo workstreams inspect --workstream "$WORKSTREAM" --format json)
          echo "$output" > inspect.json

          pending=$(jq '[.events.items[] | select(.state == "pending")] | length' inspect.json)
          echo "pending_count=$pending" >> "$GITHUB_OUTPUT"

          if [ "$pending" -gt 0 ]; then
            echo "has_pending=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_pending=false" >> "$GITHUB_OUTPUT"
          fi

          issues_before=$(jq -c '[.issues.items[].path]' inspect.json)
          echo "issues_before=$issues_before" >> "$GITHUB_OUTPUT"

  decider-matrix:
    needs: inspect-workstream
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has_roles: ${{ steps.matrix.outputs.has_roles }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Export decider roles
        id: matrix
        env:
          WORKSTREAM: ${{ inputs.workstream }}
          HAS_PENDING: ${{ needs.inspect-workstream.outputs.has_pending }}
        run: |
          set -euo pipefail
          if [ "$HAS_PENDING" != "true" ]; then
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
            echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"
            exit 0
          fi

          matrix=$(
            timeout 20s bash -lc \
              "set -euo pipefail; jlo schedule export --scope roles --layer deciders --workstream \"$WORKSTREAM\" --format github-matrix | jq -c 'del(.schema_version)'"
          ) || { echo "::error::Timed out while generating decider role matrix (jlo schedule export)"; exit 1; }
          count=$(echo "$matrix" | jq '.include | length')
          if [ "$count" -gt 0 ]; then
            echo "has_roles=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_roles=false" >> "$GITHUB_OUTPUT"
          fi
          echo "matrix=$matrix" >> "$GITHUB_OUTPUT"

  deciders:
    needs: decider-matrix
    if: needs.decider-matrix.outputs.has_roles == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
      matrix: ${{ fromJson(needs.decider-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Run decider
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          timeout 20m jlo run deciders --workstream "${{ matrix.workstream }}" --role "${{ matrix.role }}"

  wait-after-deciders:
    needs: deciders
    if: needs.deciders.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Wait for deciders
        run: |
          WAIT_SECONDS=$(( ${{ inputs.wait_minutes }} * 60 ))
          echo "⏳ Waiting ${WAIT_SECONDS}s for Jules to complete decider tasks..."
          sleep "$WAIT_SECONDS"

  doctor-final:
    needs: [deciders, wait-after-deciders]
    if: >-
      always() &&
      needs.deciders.result != 'failure' &&
      needs.wait-after-deciders.result != 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Validate workstream after deciders
        run: timeout 2m jlo doctor --workstream "${{ inputs.workstream }}"

  inspect-post-deciders:
    needs: [inspect-workstream, doctor-final]
    if: >-
      always() &&
      needs.inspect-workstream.result != 'failure' &&
      needs.doctor-final.result != 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      planner_matrix: ${{ steps.route.outputs.planner_matrix }}
      has_planners: ${{ steps.route.outputs.has_planners }}
      new_issues: ${{ steps.route.outputs.new_issues }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Build planner matrix
        id: route
        env:
          WORKSTREAM: ${{ inputs.workstream }}
          ISSUES_BEFORE: ${{ needs.inspect-workstream.outputs.issues_before }}
          ROUTING_LABELS: ${{ inputs.routing_labels }}
        run: |
          set -euo pipefail
          output=$(timeout 20s jlo workstreams inspect --workstream "$WORKSTREAM" --format json)
          echo "$output" > inspect.json

          if [ -z "$ISSUES_BEFORE" ]; then
            echo "Missing issues_before snapshot" >&2
            exit 1
          fi

          labels_json=$(printf '%s' "$ROUTING_LABELS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length>0))')

          new_issues=$(jq -c --argjson before "$ISSUES_BEFORE" '
            [ .issues.items[].path | select(($before | index(.)) | not) ]
          ' inspect.json)

          planner_matrix=$(jq -c --argjson before "$ISSUES_BEFORE" --argjson labels "$labels_json" '
            {include: [.issues.items[]
              | select((($before | index(.path)) | not))
              | select(($labels | index(.label)) != null)
              | select(.requires_deep_analysis == true)
              | {issue: .path}
            ]}
          ' inspect.json)

          planner_count=$(echo "$planner_matrix" | jq '.include | length')
          if [ "$planner_count" -gt 0 ]; then
            echo "has_planners=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_planners=false" >> "$GITHUB_OUTPUT"
          fi

          echo "planner_matrix=$planner_matrix" >> "$GITHUB_OUTPUT"
          echo "new_issues=$new_issues" >> "$GITHUB_OUTPUT"

  planners:
    needs: inspect-post-deciders
    if: needs.inspect-post-deciders.outputs.has_planners == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
      matrix: ${{ fromJson(needs.inspect-post-deciders.outputs.planner_matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Run planner
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          timeout 20m jlo run planners "${{ matrix.issue }}"

  wait-after-planners:
    needs: planners
    if: needs.planners.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Wait for planners
        run: |
          WAIT_SECONDS=$(( ${{ inputs.wait_minutes }} * 60 ))
          echo "⏳ Waiting ${WAIT_SECONDS}s for Jules to complete planner tasks..."
          sleep "$WAIT_SECONDS"

  doctor-after-planners:
    needs: [planners, wait-after-planners]
    if: >-
      always() &&
      needs.planners.result != 'failure' &&
      needs.wait-after-planners.result != 'failure'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Validate workstream after planners
        run: timeout 2m jlo doctor --workstream "${{ inputs.workstream }}"

  inspect-post-planners:
    needs: [inspect-post-deciders, doctor-after-planners]
    if: >-
      always() &&
      needs.inspect-post-deciders.result != 'failure' &&
      (needs.doctor-after-planners.result == 'success' || needs.doctor-after-planners.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      implementer_matrix: ${{ steps.route.outputs.implementer_matrix }}
      has_implementers: ${{ steps.route.outputs.has_implementers }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Build implementer matrix
        id: route
        env:
          WORKSTREAM: ${{ inputs.workstream }}
          NEW_ISSUES: ${{ needs.inspect-post-deciders.outputs.new_issues }}
          ROUTING_LABELS: ${{ inputs.routing_labels }}
        run: |
          set -euo pipefail
          output=$(timeout 20s jlo workstreams inspect --workstream "$WORKSTREAM" --format json)
          echo "$output" > inspect.json

          if [ -z "$NEW_ISSUES" ]; then
            echo "Missing new_issues snapshot" >&2
            exit 1
          fi

          labels_json=$(printf '%s' "$ROUTING_LABELS" | jq -R 'split(",") | map(gsub("^\\s+|\\s+$";"")) | map(select(length>0))')

          implementer_matrix=$(jq -c --argjson new "$NEW_ISSUES" --argjson labels "$labels_json" '
            {include: [.issues.items[]
              | select(($new | index(.path)) != null)
              | select(($labels | index(.label)) != null)
              | select(.requires_deep_analysis == false)
              | {issue: .path}
            ]}
          ' inspect.json)

          implementer_count=$(echo "$implementer_matrix" | jq '.include | length')
          if [ "$implementer_count" -gt 0 ]; then
            echo "has_implementers=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_implementers=false" >> "$GITHUB_OUTPUT"
          fi

          echo "implementer_matrix=$implementer_matrix" >> "$GITHUB_OUTPUT"

  implementers:
    needs: inspect-post-planners
    if: needs.inspect-post-planners.outputs.has_implementers == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      max-parallel: 1
      matrix: ${{ fromJson(needs.inspect-post-planners.outputs.implementer_matrix) }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Run implementer
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          timeout 20m jlo run implementers "${{ matrix.issue }}"
