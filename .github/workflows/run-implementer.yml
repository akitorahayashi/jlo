name: Run Implementer

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'GitHub Issue number to implement'
        required: true
        type: number
      role:
        description: 'Implementer role name'
        required: false
        type: string
        default: 'executor'

jobs:
  implement:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: read
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Load implementer role
        id: role
        run: |
          role="${{ inputs.role }}"
          if [ -z "$role" ]; then
            role="executor"
          fi
          echo "role=$role" >> "$GITHUB_OUTPUT"

      - name: Fetch GitHub Issue
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          issue_number="${{ inputs.issue_number }}"
          
          # Fetch issue details
          issue_json=$(gh issue view "$issue_number" --json title,body,labels)
          
          title=$(echo "$issue_json" | jq -r '.title')
          body=$(echo "$issue_json" | jq -r '.body')
          
          # Output for prompt
          delimiter="ISSUE_EOF_$(date +%s%N)"
          {
            echo "title<<$delimiter"
            echo "$title"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"
          
          {
            echo "body<<$delimiter"
            echo "$body"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Read prompt
        id: prompt
        uses: ./.github/actions/read-role-prompt
        with:
          layer: implementers
          role: ${{ steps.role.outputs.role }}

      - name: Invoke Jules
        uses: ./.github/actions/jules-invoke
        with:
          prompt: |
            ${{ steps.prompt.outputs.prompt }}
            
            ---
            GitHub Issue #${{ inputs.issue_number }}: ${{ steps.issue.outputs.title }}
            
            ${{ steps.issue.outputs.body }}
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          starting_branch: main
