name: Run Implementer

on:
  workflow_call:
    inputs:
      task_file:
        description: 'Task file basename (e.g., 2026-01-28_task_example.yml)'
        required: true
        type: string
    secrets:
      jules_api_key:
        required: true

jobs:
  implement:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          path: jules-task-read

      - name: Read task
        id: task
        run: |
          task_file="${{ inputs.task_file }}"
          if [[ "$task_file" == */* ]] || [[ "$task_file" == *..* ]]; then
            echo "Error: task_file cannot contain path traversal characters ('/' or '..')."
            exit 1
          fi
          task_path="jules-task-read/.jules/exchange/tasks/$task_file"
          if [ ! -f "$task_path" ]; then
            echo "Error: Task file not found at $task_path"
            exit 1
          fi
          delimiter="TASK_EOF_$(date +%s%N)"
          content=$(cat "$task_path")
          {
            echo "content<<$delimiter"
            echo "$content"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@v4
        with:
          ref: main

      - name: Read prompt
        id: prompt
        uses: ./.github/actions/read-role-prompt
        with:
          layer: implementers
          role: executor

      - name: Invoke Jules
        uses: ./.github/actions/jules-invoke
        with:
          prompt: |
            ${{ steps.prompt.outputs.prompt }}
            
            Task file: .jules/exchange/tasks/${{ inputs.task_file }}
            
            ${{ steps.task.outputs.content }}
            
            Task cleanup is handled on the jules branch after verification.
          jules_api_key: ${{ secrets.jules_api_key }}
          starting_branch: main

      - uses: actions/checkout@v4
        if: success()
        with:
          ref: jules
          path: jules-task-cleanup

      - name: Delete task on jules
        if: success()
        run: |
          task_file="${{ inputs.task_file }}"
          if [[ "$task_file" == */* ]] || [[ "$task_file" == *..* ]]; then
            echo "Error: task_file cannot contain path traversal characters ('/' or '..')."
            exit 1
          fi
          cd jules-task-cleanup
          task_path=".jules/exchange/tasks/$task_file"
          if [ ! -f "$task_path" ]; then
            echo "Task file not found at $task_path; nothing to delete."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          rm "$task_path"
          git add "$task_path"
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m "Remove processed task $task_file"
          git push origin HEAD:jules
