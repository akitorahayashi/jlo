name: Jules E2E Exchange Flow

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  exchange-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Setup Rust
        uses: ./.github/actions/setup

      - name: Verify Jules workspace
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d ".jules" ]; then
            echo "Expected .jules/ workspace on the jules branch." >&2
            exit 1
          fi
          if [ ! -f ".jules/config.toml" ]; then
            echo "Missing .jules/config.toml." >&2
            exit 1
          fi

      - name: Dry-run configured layers
        shell: bash
        run: |
          set -euo pipefail
          layers=$(awk '
            BEGIN { in_agents=0 }
            /^\[agents\]/{ in_agents=1; next }
            /^\[/{ if (in_agents==1) in_agents=0 }
            in_agents {
              line=$0
              sub(/#.*/, "", line)
              gsub(/^[ \t]+|[ \t]+$/, "", line)
              if (line=="" || line !~ /=/) next
              split(line, parts, "=")
              key=parts[1]
              gsub(/[ \t]+/, "", key)
              val=parts[2]
              gsub(/^[ \t]+|[ \t]+$/, "", val)
              if (val ~ /^\[/ && val ~ /\]$/) {
                inner=val
                gsub(/^\[/, "", inner)
                gsub(/\]$/, "", inner)
                gsub(/[ \t]/, "", inner)
                if (inner != "") print key
              }
            }
          ' .jules/config.toml)

          if [ -z "$layers" ]; then
            echo "No configured roles found in .jules/config.toml." >&2
            exit 1
          fi

          for layer in $layers; do
            cargo run --quiet -- run "$layer" --dry-run
          done

      - name: Execute exchange flow
        shell: bash
        run: |
          set -euo pipefail
          MOCK_ROOT="$GITHUB_WORKSPACE/.jules-mock"
          EVENT_ROOT="$MOCK_ROOT/.jules/exchange/events"
          ISSUE_ROOT="$MOCK_ROOT/.jules/exchange/issues"
          TEMPLATE_ROOT="$GITHUB_WORKSPACE/.github/assets/jules-e2e"

          rm -rf "$MOCK_ROOT"
          mkdir -p "$EVENT_ROOT" "$ISSUE_ROOT"

          CATEGORY=$(ls -1 "$GITHUB_WORKSPACE/.jules/exchange/events" | head -n 1 || true)
          if [ -z "$CATEGORY" ]; then
            echo "No exchange event categories found under .jules/exchange/events." >&2
            exit 1
          fi

          ROLE=$(find "$GITHUB_WORKSPACE/.jules/roles/observers" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | head -n 1 || true)
          if [ -z "$ROLE" ]; then
            echo "No observer roles found under .jules/roles/observers." >&2
            exit 1
          fi

          escape_sed() {
            printf '%s' "$1" | sed -e 's/[\\/&]/\\&/g'
          }

          render_template() {
            local template="$1"
            local output="$2"
            shift 2

            cp "$template" "$output"
            while [ "$#" -gt 1 ]; do
              local placeholder="$1"
              local value="$2"
              shift 2
              value=$(escape_sed "$value")
              sed -i "s|$placeholder|$value|g" "$output"
            done
          }

          extract_template_value() {
            local file="$1"
            local key="$2"
            local line

            line=$(grep -E "^[[:space:]]*$key:" "$file" | head -n 1 | sed -E 's/^[^:]*:[[:space:]]*//')
            line=${line%%#*}
            line=$(printf '%s' "$line" | tr -d '"' | xargs)
            printf '%s' "$line"
          }

          pick_enum_value() {
            local raw="$1"
            IFS='|' read -r -a parts <<< "$raw"
            local count=${#parts[@]}
            if [ "$count" -eq 0 ]; then
              return 1
            fi
            local index=$((count / 2))
            printf '%s' "${parts[$index]}"
          }

          OBSERVER_TEMPLATE="$GITHUB_WORKSPACE/.jules/roles/observers/event.yml"
          DECIDER_TEMPLATE="$GITHUB_WORKSPACE/.jules/roles/deciders/issue.yml"

          CONFIDENCE_ENUM=$(extract_template_value "$OBSERVER_TEMPLATE" "confidence")
          if [ -z "$CONFIDENCE_ENUM" ]; then
            echo "Failed to read confidence enum from $OBSERVER_TEMPLATE." >&2
            exit 1
          fi
          EVENT_CONFIDENCE=$(pick_enum_value "$CONFIDENCE_ENUM")

          PRIORITY_ENUM=$(extract_template_value "$DECIDER_TEMPLATE" "priority")
          if [ -z "$PRIORITY_ENUM" ]; then
            echo "Failed to read priority enum from $DECIDER_TEMPLATE." >&2
            exit 1
          fi
          ISSUE_PRIORITY=$(pick_enum_value "$PRIORITY_ENUM")

          ISSUE_STATUS=$(extract_template_value "$DECIDER_TEMPLATE" "status")
          if [ -z "$ISSUE_STATUS" ]; then
            echo "Failed to read status from $DECIDER_TEMPLATE." >&2
            exit 1
          fi

          RANDOM_ID=$(printf '%04x' "$RANDOM")
          EVENT_ID="$(date -u +%Y-%m-%d_%H%M%S)_${CATEGORY}_${ROLE}_${RANDOM_ID}"
          EVENT_DATE="$(date -u +%Y-%m-%d)"
          EVENT_PATH="$EVENT_ROOT/$CATEGORY/${EVENT_ID}.yml"

          mkdir -p "$EVENT_ROOT/$CATEGORY"

          render_template \
            "$TEMPLATE_ROOT/event.yml" \
            "$EVENT_PATH" \
            "__EVENT_ID__" "$EVENT_ID" \
            "__EVENT_DATE__" "$EVENT_DATE" \
            "__ROLE__" "$ROLE" \
            "__CATEGORY__" "$CATEGORY" \
            "__CONFIDENCE__" "$EVENT_CONFIDENCE" \
            "__EVENT_TITLE__" "Mock pipeline event" \
            "__EVENT_STATEMENT__" "Mock observation generated for pipeline validation." \
            "__EVIDENCE_PATH__" "README.md" \
            "__EVIDENCE_LOC__" "# .jules/" \
            "__EVIDENCE_NOTE__" "Demonstrates event structure for mock flow validation." \
            "__EVENT_TAG__" "pipeline"

          ISSUE_ID="$(date -u +%Y-%m-%d)_mock_pipeline_${CATEGORY}"
          ISSUE_PATH="$ISSUE_ROOT/${ISSUE_ID}.yml"

          render_template \
            "$TEMPLATE_ROOT/issue-pending.yml" \
            "$ISSUE_PATH" \
            "__ISSUE_ID__" "$ISSUE_ID" \
            "__CATEGORY__" "$CATEGORY" \
            "__EVENT_ID__" "$EVENT_ID" \
            "__PRIORITY__" "$ISSUE_PRIORITY" \
            "__STATUS__" "$ISSUE_STATUS" \
            "__REQUIRES_DEEP_ANALYSIS__" "true" \
            "__ISSUE_TITLE__" "Mock pipeline issue" \
            "__ISSUE_SUMMARY__" "Mock issue derived from a synthetic event." \
            "__AFFECTED_AREA__" "README.md" \
            "__PROBLEM__" "The mock event needs validation coverage." \
            "__IMPACT__" "Pipeline validation needs deterministic artifacts." \
            "__DESIRED_OUTCOME__" "The pipeline steps produce valid issue artifacts." \
            "__ACCEPTANCE_1__" "Mock pipeline validation passes." \
            "__ACCEPTANCE_2__" "requires_deep_analysis is false after planning."

          rm -f "$EVENT_PATH"

          render_template \
            "$TEMPLATE_ROOT/issue-expanded.yml" \
            "$ISSUE_PATH" \
            "__ISSUE_ID__" "$ISSUE_ID" \
            "__CATEGORY__" "$CATEGORY" \
            "__EVENT_ID__" "$EVENT_ID" \
            "__PRIORITY__" "$ISSUE_PRIORITY" \
            "__STATUS__" "$ISSUE_STATUS" \
            "__REQUIRES_DEEP_ANALYSIS__" "false" \
            "__ISSUE_TITLE__" "Mock pipeline issue" \
            "__ISSUE_SUMMARY__" "Mock issue derived from a synthetic event." \
            "__AFFECTED_AREA__" "README.md" \
            "__CONSTRAINT__" "Mock expansion overwrote the issue in place." \
            "__RISK__" "Mock pipeline skips external API usage." \
            "__PROBLEM__" "The mock event needs validation coverage." \
            "__IMPACT__" "Pipeline validation needs deterministic artifacts." \
            "__DESIRED_OUTCOME__" "The pipeline steps produce valid issue artifacts." \
            "__ACCEPTANCE_1__" "Mock pipeline validation passes." \
            "__ACCEPTANCE_2__" "requires_deep_analysis is false."

      - name: Verify exchange flow
        shell: bash
        run: |
          set -euo pipefail
          MOCK_ROOT="$GITHUB_WORKSPACE/.jules-mock"
          ISSUE_PATH=$(find "$MOCK_ROOT/.jules/exchange/issues" -maxdepth 1 -type f -name "*.yml" | head -n 1 || true)

          if [ -d "$MOCK_ROOT/.jules/exchange/events" ]; then
            if find "$MOCK_ROOT/.jules/exchange/events" -type f -name "*.yml" | grep -q .; then
              echo "Event inbox is not empty after mock decider step." >&2
              exit 1
            fi
          fi

          if [ -z "$ISSUE_PATH" ] || [ ! -f "$ISSUE_PATH" ]; then
            echo "Expected issue file missing." >&2
            exit 1
          fi

          if ! grep -q "requires_deep_analysis: false" "$ISSUE_PATH"; then
            echo "Issue was not expanded by mock planner step." >&2
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: rm -rf "$GITHUB_WORKSPACE/.jules-mock"
