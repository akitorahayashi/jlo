# Jules E2E Pipeline Simulation
#
# Simulates the actual Observer → Decider → Planner pipeline flow without
# calling Jules API. Each phase creates a real branch and PR, triggering
# the auto-merge workflow.

name: Jules E2E Pipeline

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================================
  # Mock Observer Phase
  # Creates an event file and submits PR for auto-merge
  # ============================================================
  mock-observer:
    runs-on: ubuntu-latest
    outputs:
      event_id: ${{ steps.create.outputs.event_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Create event file
        id: create
        shell: bash
        run: |
          set -euo pipefail
          RANDOM_ID=$(printf '%04x' "$RANDOM")
          BRANCH="jules-observer-e2e-${RANDOM_ID}"
          WORKSTREAM="generic"
          
          EVENT_TEMPLATE=".jules/roles/observers/event.yml"
          if [ ! -f "$EVENT_TEMPLATE" ]; then
            echo "Missing event template" >&2
            exit 1
          fi

          # Find first observer role
          ROLE=$(find .jules/roles/observers -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | head -n 1 || true)
          if [ -z "$ROLE" ]; then
            echo "No observer roles found" >&2
            exit 1
          fi

          DATE_STR="$(date -u +%Y-%m-%d)"
          TIME_STR="$(date -u +%H%M%S)"
          EVENT_ID="${DATE_STR}_${TIME_STR}_${ROLE}_e2e_${RANDOM_ID}"
          EVENT_PATH=".jules/workstreams/$WORKSTREAM/events/${EVENT_ID}.yml"

          mkdir -p ".jules/workstreams/$WORKSTREAM/events"
          cp "$EVENT_TEMPLATE" "$EVENT_PATH"

          # Replace placeholders
          sed -i "s#YYYY-MM-DD_HHMMSS_<role>_<id>#$EVENT_ID#g" "$EVENT_PATH"
          sed -i "s#YYYY-MM-DD#$DATE_STR#g" "$EVENT_PATH"
          sed -i "s#<role>#$ROLE#g" "$EVENT_PATH"
          sed -i "s#low|medium|high#medium#g" "$EVENT_PATH"
          sed -i "s#<short descriptive title>#E2E Pipeline Test Event#g" "$EVENT_PATH"
          sed -i "s#<concise statement of the observation>#Synthetic event for E2E pipeline validation.#g" "$EVENT_PATH"
          sed -i "s#<repo-relative path>#README.md#g" "$EVENT_PATH"
          sed -i "s#<line number or symbol># jlo#g" "$EVENT_PATH"
          sed -i "s#<why this supports the statement>#E2E test evidence.#g" "$EVENT_PATH"
          sed -i "s#<tag>#e2e-pipeline#g" "$EVENT_PATH"

          git checkout -b "$BRANCH"
          git add "$EVENT_PATH"
          git commit -m "E2E Pipeline: Mock observer event $RANDOM_ID"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "event_id=$EVENT_ID" >> "$GITHUB_OUTPUT"
          echo "event_path=$EVENT_PATH" >> "$GITHUB_OUTPUT"
          echo "workstream=$WORKSTREAM" >> "$GITHUB_OUTPUT"

      - name: Create PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base jules \
            --head "${{ steps.create.outputs.branch }}" \
            --title "[E2E Pipeline] Mock Observer" \
            --body "Automated E2E pipeline test - Observer phase.")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      - name: Wait for auto-merge
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          for i in {1..60}; do
            STATE=$(gh pr view "${{ steps.pr.outputs.pr_url }}" --json state -q '.state')
            if [ "$STATE" = "MERGED" ]; then
              echo "✅ Observer PR merged"
              exit 0
            elif [ "$STATE" = "CLOSED" ]; then
              echo "❌ Observer PR closed without merge"
              exit 1
            fi
            echo "Waiting for merge... ($i/60)"
            sleep 2
          done
          echo "❌ Timeout waiting for observer merge"
          exit 1

  # ============================================================
  # Mock Decider Phase
  # Processes event, creates issue, deletes event
  # ============================================================
  mock-decider:
    needs: mock-observer
    runs-on: ubuntu-latest
    outputs:
      issue_path: ${{ steps.create.outputs.issue_path }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Process event and create issue
        id: create
        shell: bash
        run: |
          set -euo pipefail
          RANDOM_ID=$(printf '%04x' "$RANDOM")
          BRANCH="jules-decider-e2e-${RANDOM_ID}"
          WORKSTREAM="generic"
          
          ISSUE_TEMPLATE=".jules/roles/deciders/issue.yml"
          if [ ! -f "$ISSUE_TEMPLATE" ]; then
            echo "Missing issue template" >&2
            exit 1
          fi

          # Find the event created by observer
          EVENT_PATH=$(find .jules/workstreams/$WORKSTREAM/events -name "*.yml" -type f | head -n 1 || true)
          if [ -z "$EVENT_PATH" ]; then
            echo "No event files found to process" >&2
            exit 1
          fi

          ISSUE_ID="e2e_pipeline_${RANDOM_ID}"
          PRIORITY="medium"
          ISSUE_PATH=".jules/workstreams/$WORKSTREAM/issues/$PRIORITY/${ISSUE_ID}.yml"

          mkdir -p ".jules/workstreams/$WORKSTREAM/issues/$PRIORITY"
          cp "$ISSUE_TEMPLATE" "$ISSUE_PATH"

          # Replace placeholders
          sed -i "s#<fingerprint>#$ISSUE_ID#g" "$ISSUE_PATH"
          sed -i "s#<Descriptive Title>#E2E Pipeline Test Issue#g" "$ISSUE_PATH"
          sed -i "s#low|medium|high#$PRIORITY#g" "$ISSUE_PATH"
          sed -i "s#<One-line statement of the issue>#Issue created from E2E pipeline event.#g" "$ISSUE_PATH"
          sed -i "s#<What is wrong or missing - conceptual description>#E2E pipeline validation.#g" "$ISSUE_PATH"
          sed -i "s#<Why this matters - consequences if not addressed>#Pipeline flow test.#g" "$ISSUE_PATH"
          sed -i "s#<What should be true after resolution>#E2E test passes.#g" "$ISSUE_PATH"
          sed -i "s#<file or module path>#README.md#g" "$ISSUE_PATH"
          sed -i "s#<condition 1>#Pipeline completes successfully.#g" "$ISSUE_PATH"
          sed -i "s#<condition 2>#Issue state is correct.#g" "$ISSUE_PATH"
          sed -i "s#<command 1 (e.g. format check)>#echo verified#g" "$ISSUE_PATH"
          sed -i "s#<command 2 (e.g. lint check)>##g" "$ISSUE_PATH"
          sed -i "s#<command 3 (e.g. test commands)>##g" "$ISSUE_PATH"

          # Delete processed event
          rm -f "$EVENT_PATH"

          git checkout -b "$BRANCH"
          git add -A
          git commit -m "E2E Pipeline: Mock decider - process event, create issue"
          git push origin "$BRANCH"

          echo "branch=$BRANCH" >> "$GITHUB_OUTPUT"
          echo "issue_path=$ISSUE_PATH" >> "$GITHUB_OUTPUT"

      - name: Create PR
        id: pr
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --base jules \
            --head "${{ steps.create.outputs.branch }}" \
            --title "[E2E Pipeline] Mock Decider" \
            --body "Automated E2E pipeline test - Decider phase.")
          echo "pr_url=$PR_URL" >> "$GITHUB_OUTPUT"

      - name: Wait for auto-merge
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          for i in {1..60}; do
            STATE=$(gh pr view "${{ steps.pr.outputs.pr_url }}" --json state -q '.state')
            if [ "$STATE" = "MERGED" ]; then
              echo "✅ Decider PR merged"
              exit 0
            elif [ "$STATE" = "CLOSED" ]; then
              echo "❌ Decider PR closed without merge"
              exit 1
            fi
            echo "Waiting for merge... ($i/60)"
            sleep 2
          done
          echo "❌ Timeout waiting for decider merge"
          exit 1

  # ============================================================
  # Verification
  # Planners and Implementers are single-role, issue-driven layers
  # tested separately via jules-e2e-single-role.yml
  # ============================================================
  verify:
    needs: mock-decider
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Verify final state
        shell: bash
        run: |
          set -euo pipefail
          WORKSTREAM="generic"

          echo "=== Checking event inbox ==="
          EVENT_COUNT=$(find .jules/workstreams/$WORKSTREAM/events -name "*.yml" -type f 2>/dev/null | wc -l)
          if [ "$EVENT_COUNT" -gt 0 ]; then
            echo "❌ Event inbox not empty (found $EVENT_COUNT files)"
            find .jules/workstreams/$WORKSTREAM/events -name "*.yml" -type f
            exit 1
          fi
          echo "✅ Event inbox is empty"

          echo "=== Checking issue was created ==="
          ISSUE_PATH=$(find .jules/workstreams/$WORKSTREAM/issues -name "*.yml" -type f | head -n 1 || true)
          if [ -z "$ISSUE_PATH" ]; then
            echo "❌ No issue files found"
            exit 1
          fi
          echo "✅ Found issue: $ISSUE_PATH"

          echo "=== E2E Pipeline Verification Complete ==="

  # ============================================================
  # Cleanup (runs regardless of success/failure)
  # ============================================================
  cleanup:
    if: always()
    needs: [mock-observer, mock-decider, verify]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: ${{ secrets.JLO_BOT_TOKEN }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Clean up test artifacts
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN }}
        run: |
          set -x
          WORKSTREAM="generic"

          # Close any open E2E PRs
          gh pr list --state open --json number,headRefName --jq '.[] | select(.headRefName | startswith("jules-") and contains("-e2e-")) | .number' | while read -r pr_num; do
            echo "Closing PR #$pr_num"
            gh pr close "$pr_num" --delete-branch || true
          done

          # Delete leftover E2E branches
          git fetch --prune
          git branch -r | grep -E 'jules-(observer|decider)-e2e-' | sed 's#origin/##' | while read -r branch; do
            echo "Deleting branch: $branch"
            git push origin --delete "$branch" || true
          done

          # Remove test event files
          if find .jules/workstreams/$WORKSTREAM/events -name "*e2e*.yml" -type f 2>/dev/null | grep -q .; then
            find .jules/workstreams/$WORKSTREAM/events -name "*e2e*.yml" -type f -delete
            git add -A
            git commit -m "E2E Cleanup: Remove test event files" || true
            git push origin jules || true
          fi

          # Remove test issue files
          if find .jules/workstreams/$WORKSTREAM/issues -name "*e2e*.yml" -type f 2>/dev/null | grep -q .; then
            find .jules/workstreams/$WORKSTREAM/issues -name "*e2e*.yml" -type f -delete
            git add -A
            git commit -m "E2E Cleanup: Remove test issue files" || true
            git push origin jules || true
          fi

          echo "✅ Cleanup complete"
