name: Jules E2E Exchange Flow

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  exchange-flow:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Setup Rust
        uses: ./.github/actions/setup

      - name: Verify Jules workspace
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -d ".jules" ]; then
            echo "Expected .jules/ workspace on the jules branch." >&2
            exit 1
          fi
          if [ ! -f ".jules/config.toml" ]; then
            echo "Missing .jules/config.toml." >&2
            exit 1
          fi

      - name: Dry-run configured layers
        shell: bash
        run: |
          set -euo pipefail
          layers=$(awk '
            BEGIN { in_agents=0 }
            /^\[agents\]/{ in_agents=1; next }
            /^\[/{ if (in_agents==1) in_agents=0 }
            in_agents {
              line=$0
              sub(/#.*/, "", line)
              gsub(/^[ \t]+|[ \t]+$/, "", line)
              if (line=="" || line !~ /=/) next
              split(line, parts, "=")
              key=parts[1]
              gsub(/[ \t]+/, "", key)
              val=parts[2]
              gsub(/^[ \t]+|[ \t]+$/, "", val)
              if (val ~ /^\[/ && val ~ /\]$/) {
                inner=val
                gsub(/^\[/, "", inner)
                gsub(/\]$/, "", inner)
                gsub(/[ \t]/, "", inner)
                if (inner != "") print key
              }
            }
          ' .jules/config.toml)

          if [ -z "$layers" ]; then
            echo "No configured roles found in .jules/config.toml." >&2
            exit 1
          fi

          for layer in $layers; do
            cargo run --quiet -- run "$layer" --dry-run
          done

      - name: Execute exchange flow
        shell: bash
        run: |
          set -euo pipefail
          MOCK_ROOT="$GITHUB_WORKSPACE/.jules-mock"
          WORKSTREAM="generic"
          
          EVENT_ROOT="$MOCK_ROOT/.jules/workstreams/$WORKSTREAM/events"
          ISSUE_ROOT="$MOCK_ROOT/.jules/workstreams/$WORKSTREAM/issues"
          
          # Templates from the workspace
          EVENT_TEMPLATE="$GITHUB_WORKSPACE/.jules/roles/observers/event.yml"
          ISSUE_TEMPLATE="$GITHUB_WORKSPACE/.jules/roles/deciders/issue.yml"
          
          if [ ! -f "$EVENT_TEMPLATE" ] || [ ! -f "$ISSUE_TEMPLATE" ]; then
             echo "Missing templates in workspace." >&2
             exit 1
          fi

          rm -rf "$MOCK_ROOT"
          mkdir -p "$EVENT_ROOT" "$ISSUE_ROOT/pending"

          ROLE=$(find "$GITHUB_WORKSPACE/.jules/roles/observers" -mindepth 1 -maxdepth 1 -type d -printf "%f\n" | head -n 1 || true)
          if [ -z "$ROLE" ]; then
            echo "No observer roles found under .jules/roles/observers." >&2
            exit 1
          fi

          escape_sed() {
            printf '%s' "$1" | sed -e 's/[\\&#]/\\&/g'
          }

          render_template() {
            local template="$1"
            local output="$2"
            shift 2

            cp "$template" "$output"
            while [ "$#" -gt 1 ]; do
              local placeholder="$1"
              local value="$2"
              shift 2
              value=$(escape_sed "$value")
              sed -i "s#$placeholder#$value#g" "$output"
            done
          }

          extract_template_value() {
            local file="$1"
            local key="$2"
            local line

            line=$(grep -E "^[[:space:]]*$key:" "$file" | head -n 1 | sed -E 's/^[^:]*:[[:space:]]*//')
            line=${line%%#*}
            line=$(printf '%s' "$line" | tr -d '"' | xargs)
            printf '%s' "$line"
          }

          pick_enum_value() {
            local raw="$1"
            IFS='|' read -r -a parts <<< "$raw"
            local count=${#parts[@]}
            if [ "$count" -eq 0 ]; then
              return 1
            fi
            local index=$((count / 2))
            printf '%s' "${parts[$index]}"
          }

          CONFIDENCE_ENUM=$(extract_template_value "$EVENT_TEMPLATE" "confidence")
          if [ -z "$CONFIDENCE_ENUM" ]; then
            echo "Failed to read confidence enum." >&2
            exit 1
          fi
          EVENT_CONFIDENCE=$(pick_enum_value "$CONFIDENCE_ENUM")

          PRIORITY_ENUM=$(extract_template_value "$ISSUE_TEMPLATE" "priority")
          if [ -z "$PRIORITY_ENUM" ]; then
            echo "Failed to read priority enum." >&2
            exit 1
          fi
          ISSUE_PRIORITY=$(pick_enum_value "$PRIORITY_ENUM")

          # Create Event
          DATE_STR="$(date -u +%Y-%m-%d)"
          TIME_STR="$(date -u +%H%M%S)"
          RANDOM_ID=$(printf '%04x' "$RANDOM")
          EVENT_ID="${DATE_STR}_${TIME_STR}_${ROLE}_${RANDOM_ID}"
          EVENT_PATH="$EVENT_ROOT/${EVENT_ID}.yml"

          render_template \
            "$EVENT_TEMPLATE" \
            "$EVENT_PATH" \
            "YYYY-MM-DD_HHMMSS_<role>_<id>" "$EVENT_ID" \
            "YYYY-MM-DD" "$DATE_STR" \
            "<role>" "$ROLE" \
            "low|medium|high" "$EVENT_CONFIDENCE" \
            "<short descriptive title>" "Mock pipeline event" \
            "<concise statement of the observation>" "Mock observation generated for pipeline validation." \
            "<repo-relative path>" "README.md" \
            "<line number or symbol>" "# .jules/" \
            "<why this supports the statement>" "Demonstrates event structure for mock flow validation." \
            "<tag>" "pipeline"

          # Create Issue (Simulate Decider + Planner flow)
          # 1. Decider creates issue (pending analysis)
          
          ISSUE_ID="mock_pipeline_${WORKSTREAM}_${RANDOM_ID}"
          ISSUE_PATH="$ISSUE_ROOT/${ISSUE_PRIORITY}/${ISSUE_ID}.yml"
          mkdir -p "$(dirname "$ISSUE_PATH")"

          # Render base issue
          render_template \
            "$ISSUE_TEMPLATE" \
            "$ISSUE_PATH" \
            "<fingerprint>" "$ISSUE_ID" \
            "<Descriptive Title>" "Mock pipeline issue" \
            "low|medium|high" "$ISSUE_PRIORITY" \
            "<One-line statement of the issue>" "Mock issue derived from a synthetic event." \
            "<What is wrong or missing - conceptual description>" "The mock event needs validation coverage." \
            "<Why this matters - consequences if not addressed>" "Pipeline validation needs deterministic artifacts." \
            "<What should be true after resolution>" "The pipeline steps produce valid issue artifacts." \
            "<file or module path>" "README.md" \
            "<condition 1>" "Mock pipeline validation passes." \
            "<condition 2>" "requires_deep_analysis is false." \
            "<command 1 (e.g. format check)>" "echo 'verified'"

          # 2. Simulate Planner expansion (update requires_deep_analysis)
          # First, set to true to simulate state before planning
          sed -i 's/requires_deep_analysis: false/requires_deep_analysis: true/' "$ISSUE_PATH"
          sed -i 's/deep_analysis_reason: ""/deep_analysis_reason: "Mock deep analysis"/' "$ISSUE_PATH"
          
          # Then, Mock Planner "runs" and sets it to false
          # In this simplified test, we just overwrite it back to false essentially, or verify the toggle
          # But the original test validated that the file ends up with false.
          
          rm -f "$EVENT_PATH" # Decider consumes event
          
          # Planner expansion
          sed -i 's/requires_deep_analysis: true/requires_deep_analysis: false/' "$ISSUE_PATH"
          sed -i 's/deep_analysis_reason: "Mock deep analysis"/deep_analysis_reason: "Mock analysis complete"/' "$ISSUE_PATH"

      - name: Verify exchange flow
        shell: bash
        run: |
          set -euo pipefail
          MOCK_ROOT="$GITHUB_WORKSPACE/.jules-mock"
          WORKSTREAM="generic"
          
          if [ -d "$MOCK_ROOT/.jules/workstreams/$WORKSTREAM/events" ]; then
             if find "$MOCK_ROOT/.jules/workstreams/$WORKSTREAM/events" -type f -name "*.yml" | grep -q .; then
               echo "Event inbox is not empty after mock decider step." >&2
               exit 1
             fi
          fi
          
          # Check for issue in any priority folder
          ISSUE_PATH=$(find "$MOCK_ROOT/.jules/workstreams/$WORKSTREAM/issues" -type f -name "*.yml" | head -n 1 || true)

          if [ -z "$ISSUE_PATH" ] || [ ! -f "$ISSUE_PATH" ]; then
            echo "Expected issue file missing." >&2
            exit 1
          fi

          if ! grep -q "requires_deep_analysis: false" "$ISSUE_PATH"; then
            echo "Issue was not expanded by mock planner step." >&2
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: rm -rf "$GITHUB_WORKSPACE/.jules-mock"
