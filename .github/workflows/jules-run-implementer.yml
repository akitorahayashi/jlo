# Jules Run Implementer
#
# Manual execution of the implementer layer for a specific issue.
# Separated from the main orchestration workflow to allow targeted execution.

name: Jules Run Implementer

on:
  workflow_dispatch:
    inputs:
      issue_file:
        description: 'Issue file path'
        type: string
        required: true
      dry_run:
        description: 'Show prompts without executing'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  implementers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Validate inputs
        env:
          ISSUE_FILE: ${{ inputs.issue_file }}
        run: |
          if [ -z "$ISSUE_FILE" ]; then
            echo "::error::issue_file is required"
            exit 1
          fi
          # We can't strictly check file existence before checkout/install in all cases if generic,
          # but here we are on 'jules' branch.
          if [ ! -f "$ISSUE_FILE" ]; then
            echo "::error::Issue file not found in repository: $ISSUE_FILE"
            exit 1
          fi

      - name: Install jlo
        uses: ./.github/actions/install-jlo
        with:
          version: ${{ vars.JLO_VERSION || 'latest' }}

      - name: Run implementers
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
          ISSUE_FILE: ${{ inputs.issue_file }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          args=("$ISSUE_FILE")
          [ "$DRY_RUN" = "true" ] && args+=("--dry-run")
          jlo run implementers "${args[@]}" --branch main

      - name: Configure Git
        if: inputs.dry_run != 'true'
        uses: ./.github/actions/configure-git

      - name: Delete processed issue and source events
        if: inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN || github.token }}
          ISSUE_FILE: ${{ inputs.issue_file }}
        run: |
          if [ -f "$ISSUE_FILE" ]; then
            # 1. Extract source events IDs
            # Looking for:
            # source_events:
            #   - "id1"
            #   - "id2"
            
            # Simple grep/sed extraction assuming standard formatting
            EVENT_IDS=$(grep -A 20 "source_events:" "$ISSUE_FILE" | grep -E '^\s+-\s+"[a-z0-9]+"' | sed -E 's/^\s+-\s+"([^"]+)".*/\1/')
            
            # 2. Delete source events
            # Find matching event files in any workstream's events directory
            # Strategy: find .jules/workstreams/*/events/ -name "*.yml" and check IDs
            
            if [ ! -z "$EVENT_IDS" ]; then
              echo "Found source events to delete:"
              echo "$EVENT_IDS"
              
              # Find all event files first to avoid repeated find calls
              # Optimization: Just look in the same workstream as the issue? 
              # Better to be safe and look in the expected location relative to the issue if possible, 
              # but issues are in workstreams/generic/issues/... and events are in workstreams/generic/events/...
              
              # We can deduce the workstream root from the ISSUE_FILE path
              # e.g. .jules/workstreams/generic/issues/feats/file.yml -> .jules/workstreams/generic
              
              WORKSTREAM_DIR=$(echo "$ISSUE_FILE" | awk -F'/issues/' '{print $1}')
              if [[ "$WORKSTREAM_DIR" == "$ISSUE_FILE" ]]; then
                echo "Error: Could not extract workstream directory from $ISSUE_FILE"
                exit 1
              fi
              EVENTS_DIR="$WORKSTREAM_DIR/events/decided"
              
              if [ -d "$EVENTS_DIR" ]; then
                echo "Searching for events in $EVENTS_DIR"
                for ID in $EVENT_IDS; do
                  # Find file containing 'id: "ID"'
                  MATCH=$(grep -l "id: \"$ID\"" "$EVENTS_DIR"/*.yml 2>/dev/null | head -n 1)
                  if [ ! -z "$MATCH" ]; then
                    git rm "$MATCH"
                    echo "Marked for deletion: $MATCH"
                  else
                    echo "Warning: Source event $ID not found in $EVENTS_DIR"
                  fi
                done
              else
                 echo "Warning: Events directory not found at $EVENTS_DIR"
              fi
            fi

            # 3. Delete the issue itself
            git rm "$ISSUE_FILE"
            
            # 4. Commit changes
            git commit -m "Remove processed issue and source events: $(basename "$ISSUE_FILE")"
            git push origin jules
            echo "âœ… Cleanup complete."
          fi
