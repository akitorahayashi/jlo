name: Run Linters

on:
  workflow_call:

jobs:
  run-linters:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - name: Setup Rust Environment
        uses: ./.github/actions/setup
        with:
          components: rustfmt,clippy

      - name: Build jlo
        run: cargo build --locked --bin jlo
        shell: bash

      - name: Install aqua
        uses: aquaproj/aqua-installer@097ac59b80cea8bd5afb5d01f5310d26db620742 # v4.0.3
        with:
          aqua_version: v2.43.1
          github_token: ${{ github.token }}
          enable_aqua_install: true
          aqua_opts: -l

      - name: Install aqua packages
        run: aqua i
        shell: bash

      - name: Generate workflow scaffold
        run: |
          "${CARGO_TARGET_DIR:-target}/debug/jlo" workflow generate self-hosted --output-dir .tmp/workflow-scaffold-generate/self-hosted
        shell: bash

      - name: Run actionlint
        run: |
          aqua exec -- actionlint .tmp/workflow-scaffold-generate/self-hosted/.github/workflows/*.yml
        shell: bash

      - name: Run Linters
        run: |
          cargo fmt --check
          cargo clippy --all-targets --all-features -- -D warnings
        shell: bash
