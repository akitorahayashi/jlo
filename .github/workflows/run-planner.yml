name: Run Planner

on:
  workflow_call:
    inputs:
      role:
        description: 'Planner role name'
        required: true
        type: string
      issue_file:
        description: 'Issue file basename to process (requires_deep_analysis: true)'
        required: true
        type: string
    secrets:
      jules_api_key:
        required: true

jobs:
  plan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Read and validate issue
        id: issue
        run: |
          # Validate issue_file to prevent path traversal
          issue_file="${{ inputs.issue_file }}"
          if [[ "$issue_file" == */* ]] || [[ "$issue_file" == *..* ]]; then
            echo "Error: issue_file cannot contain path traversal characters ('/' or '..')."
            exit 1
          fi
          
          issue_path=".jules/exchange/issues/$issue_file"
          if [ ! -f "$issue_path" ]; then
            echo "Error: Issue file not found at $issue_path"
            exit 1
          fi
          
          # Verify requires_deep_analysis is true
          requires_deep=$(yq -r '.requires_deep_analysis // false' "$issue_path")
          if [ "$requires_deep" != "true" ]; then
            echo "Error: Issue does not require deep analysis (requires_deep_analysis: $requires_deep)"
            exit 1
          fi
          
          # Use unique delimiter to avoid collision with file content
          delimiter="ISSUE_EOF_$(date +%s%N)"
          content=$(cat "$issue_path")
          {
            echo "content<<$delimiter"
            echo "$content"
            echo "$delimiter"
          } >> "$GITHUB_OUTPUT"

      - name: Read prompt
        id: prompt
        uses: ./.github/actions/read-role-prompt
        with:
          layer: planners
          role: ${{ inputs.role }}

      - name: Invoke Jules
        uses: ./.github/actions/jules-invoke
        with:
          prompt: |
            ${{ steps.prompt.outputs.prompt }}
            
            ---
            Target issue: .jules/exchange/issues/${{ inputs.issue_file }}
            
            ${{ steps.issue.outputs.content }}
          jules_api_key: ${{ secrets.jules_api_key }}
          starting_branch: jules
