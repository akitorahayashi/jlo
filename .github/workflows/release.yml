# Binary Release Workflow
#
# Builds and publishes jlo binaries for multiple platforms on tag push.

name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  actions: read

jobs:
  prepare-artifacts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts from CI workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Look for a successful run of the CI workflow for the current commit
          RUN_ID=$(gh run list --workflow ci-workflows.yml --commit ${{ github.sha }} --status success --json databaseId --jq '.[0].databaseId')

          if [ -z "$RUN_ID" ] || [ "$RUN_ID" == "null" ]; then
            echo "No successful CI workflow run found for commit ${{ github.sha }}."
            echo "Please ensure the commit has passed CI before tagging."
            exit 1
          fi

          echo "Downloading artifacts from run $RUN_ID"

          artifacts=("jlo-linux-x86_64" "jlo-linux-aarch64" "jlo-darwin-x86_64" "jlo-darwin-aarch64")

          for artifact in "${artifacts[@]}"; do
            echo "Downloading $artifact..."
            gh run download "$RUN_ID" -n "$artifact"

            if [ -d "$artifact" ]; then
                mv "$artifact/$artifact" .
                rmdir "$artifact"
            fi

            chmod +x "$artifact"
          done

      - name: Upload artifacts for release
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: |
            jlo-linux-x86_64
            jlo-linux-aarch64
            jlo-darwin-x86_64
            jlo-darwin-aarch64

  release:
    needs: prepare-artifacts
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: binaries

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            jlo-linux-x86_64
            jlo-linux-aarch64
            jlo-darwin-x86_64
            jlo-darwin-aarch64
          generate_release_notes: true
