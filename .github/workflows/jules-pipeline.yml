# Jules Pipeline
#
# Drives the file-based flow described in .jules/ by:
#   events -> issues (local file-based, no GitHub Issue promotion)
#
# This workflow is intentionally state-based and may be triggered multiple times.

name: Jules Pipeline

on:
  workflow_run:
    workflows: ["CI Workflows"]
    types: [completed]
  workflow_dispatch:
    inputs:
      jlo_version:
        description: 'jlo release tag (e.g. v2.0.0) or "latest"'
        required: false
        type: string
        default: 'latest'

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: jules-pipeline
  cancel-in-progress: false

jobs:
  pipeline:
    if: >-
      vars.JULES_PAUSED != 'true' &&
      (github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'workflow_run' &&
        github.event.workflow_run.conclusion == 'success' &&
        github.event.workflow_run.head_branch == 'jules'))
    runs-on: ubuntu-latest
    env:
      JLO_VERSION: ${{ github.event.inputs.jlo_version || vars.JLO_VERSION || 'latest' }}
    steps:
      - name: Checkout jules branch
        uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${JLO_VERSION}"
          if [ -z "$VERSION" ]; then
            VERSION="latest"
          fi
          if [ "$VERSION" != "latest" ] && [ "${VERSION#v}" = "$VERSION" ]; then
            VERSION="v${VERSION}"
          fi
          if [ "$VERSION" = "latest" ]; then
            URL="https://github.com/akitorahayashi/jlo/releases/latest/download/jlo-linux-x86_64"
          else
            URL="https://github.com/akitorahayashi/jlo/releases/download/${VERSION}/jlo-linux-x86_64"
          fi
          curl -sSL "$URL" -o jlo
          chmod +x jlo && sudo mv jlo /usr/local/bin/

      - name: Decide next action
        id: decide
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.JLO_BOT_TOKEN || github.token }}
        run: |
          set -euo pipefail

          if [ ! -d ".jules" ]; then
            echo "Missing .jules workspace." >&2
            exit 1
          fi

          has_events=false
          if find ".jules/exchange/events" -type f -name "*.yml" -print -quit 2>/dev/null | grep -q .; then
            has_events=true
          fi

          has_deep_issues=false
          if [ -d ".jules/exchange/issues" ]; then
            if grep -R -n "^requires_deep_analysis:[[:space:]]*true" ".jules/exchange/issues" >/dev/null 2>&1; then
              has_deep_issues=true
            fi
          fi

          branch_prefix() {
            local label="$1"
            local pattern
            pattern=$(grep -n "$label" .jules/JULES.md | head -n 1 | sed -n 's/.*`\(jules-[^`]*\)`/\1/p')
            if [ -z "$pattern" ]; then
              echo "";
              return 0
            fi
            echo "${pattern%%<*}"
          }

          decider_prefix=$(branch_prefix "Deciders:")
          planner_prefix=$(branch_prefix "Planners:")

          open_heads=$(gh pr list --state open --json headRefName --jq '.[].headRefName')

          decider_running=false
          if [ -n "$decider_prefix" ] && echo "$open_heads" | grep -q "^$decider_prefix"; then
            decider_running=true
          fi

          planner_running=false
          if [ -n "$planner_prefix" ] && echo "$open_heads" | grep -q "^$planner_prefix"; then
            planner_running=true
          fi

          if [ "$has_events" = "true" ] && [ "$decider_running" = "false" ]; then
            echo "action=run_deciders" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ "$has_deep_issues" = "true" ] && [ "$planner_running" = "false" ]; then
            echo "action=run_planners" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "action=none" >> "$GITHUB_OUTPUT"
          echo "Pipeline is stable. No events to process and no issues requiring deep analysis."

      - name: Run deciders
        if: steps.decide.outputs.action == 'run_deciders'
        shell: bash
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: jlo run deciders

      - name: Run planners
        if: steps.decide.outputs.action == 'run_planners'
        shell: bash
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: jlo run planners
