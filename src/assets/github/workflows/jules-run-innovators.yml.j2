# This file is auto-generated. Manual edits are strictly prohibited.
# Jules Run Innovators Workflow
#
# Runs innovators and publishes proposals.

name: Jules Run Innovators

on:
  workflow_dispatch:
    inputs:
      wait_minutes:
        description: 'Minutes to wait for Jules async processing time'
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false
  workflow_call:
    inputs:
      wait_minutes:
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: 'jules-run-innovators'
  cancel-in-progress: false

env:
  WAIT_MINUTES: {{ gha_expr("inputs.wait_minutes || " ~ workflow_wait_minutes_default) }}
  MOCK_MODE: {{ gha_expr("inputs.mock || false") }}
  JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
  JLO_RUN_FLAGS: {{ gha_expr("(inputs.mock || false) && '--mock' || ''") }}
  JLO_TARGET_BRANCH: '{{ target_branch }}'
  JULES_WORKER_BRANCH: '{{ worker_branch }}'
{% import "workflows/jules-workflows/macros/wait_job.j2" as wait_macro %}
jobs:
{% include "workflows/jules-workflows/components/bootstrap.yml.j2" %}

  run-innovators:
    needs: [bootstrap]
    if: needs.bootstrap.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: '{{ worker_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run innovators
        id: run
        run: |
          set -euo pipefail
          jlo workflow run innovators {{ gha_raw("env.JLO_RUN_FLAGS") }} --task create_three_proposals

{{ wait_macro.wait_for_processing('wait-after-run-innovators', 'run-innovators', 'run-innovators', 'innovators') }}

  publish-proposals:
    needs: [wait-after-run-innovators]
    if: |
      needs.wait-after-run-innovators.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 30
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: '{{ worker_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Publish proposals
        run: jlo workflow exchange publish-proposals

  cleanup-mock-artifacts:
    needs: [wait-after-run-innovators]
    if: |
      always() &&
      (
        (github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true') ||
        (github.event_name == 'workflow_call' && inputs.mock == true)
      )
    runs-on: {{ runner }}
    timeout-minutes: 10
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: '{{ worker_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Cleanup mock artifacts for this run
        run: |
          jlo workflow exchange clean mock --mock-tag "$JULES_MOCK_TAG"
