  cleanup-mock-artifacts:
    needs: [publish-proposals, wait-after-planner, wait-after-implementer]
    if: |
      always() &&
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true')
    runs-on: {{ runner }}
    timeout-minutes: 10
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: '{{ worker_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Cleanup mock artifacts for this run
        run: |
          jlo workflow exchange clean mock --mock-tag "$JULES_MOCK_TAG"

      - name: Validate repository (fail-fast)
        run: jlo workflow doctor

      - name: Merge mock cleanup changes
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain .jules)" ]; then
            echo "No mock cleanup changes detected."
            exit 0
          fi
          jlo workflow gh push worker-branch \
            --change-token "mock-cleanup-${JULES_MOCK_TAG}" \
            --commit-message "jules: cleanup mock artifacts ${JULES_MOCK_TAG}" \
            --pr-title "chore: cleanup mock artifacts ${JULES_MOCK_TAG}" \
            --pr-body "Automated cleanup for mock run ${JULES_MOCK_TAG}."
