  generate-routing-matrix:
    needs: [resolve-run-plan, generate-decider-matrix, run-decider, wait-after-decider]
    if: |
      always() &&
      needs.resolve-run-plan.result == 'success' &&
      (fromJSON(needs.resolve-run-plan.outputs.json).run_planner == true || fromJSON(needs.resolve-run-plan.outputs.json).run_implementer == true) &&
      (
        (
          fromJSON(needs.resolve-run-plan.outputs.json).run_decider == false &&
          needs.generate-decider-matrix.result == 'skipped' &&
          needs.run-decider.result == 'skipped' &&
          needs.wait-after-decider.result == 'skipped'
        ) ||
        (
          fromJSON(needs.resolve-run-plan.outputs.json).run_decider == true &&
          needs.generate-decider-matrix.result == 'success' &&
          (
            (
              needs.run-decider.result == 'success' &&
              needs.wait-after-decider.result == 'success'
            ) ||
            (
              needs.run-decider.result == 'skipped' &&
              needs.wait-after-decider.result == 'skipped'
            )
          )
        )
      )
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - name: Resolve planner/implementer run requests
        id: matrix
        env:
          REQUEST_PLANNER: {{ gha_expr("fromJSON(needs.resolve-run-plan.outputs.json).run_planner") }}
          REQUEST_IMPLEMENTER: {{ gha_expr("fromJSON(needs.resolve-run-plan.outputs.json).run_implementer") }}
        run: |
          set -euo pipefail
          echo "json={\"run_planner\":$REQUEST_PLANNER,\"run_implementer\":$REQUEST_IMPLEMENTER}" >> "$GITHUB_OUTPUT"
