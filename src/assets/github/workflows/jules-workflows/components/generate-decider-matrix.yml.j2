  generate-decider-matrix:
    needs: [resolve-run-plan, wait-after-observers]
    if: |
      always() &&
      needs.resolve-run-plan.result == 'success' &&
      fromJSON(needs.resolve-run-plan.outputs.json).run_decider == true &&
      (
        (
          fromJSON(needs.resolve-run-plan.outputs.json).run_observers == true &&
          needs.wait-after-observers.result == 'success'
        ) ||
        (
          fromJSON(needs.resolve-run-plan.outputs.json).run_observers == false &&
          needs.wait-after-observers.result == 'skipped'
        )
      )
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: '{{ worker_branch }}'
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Check for pending events
        id: matrix
        env:
          REQUEST_DECIDER: {{ gha_expr("fromJSON(needs.resolve-run-plan.outputs.json).run_decider") }}
        run: |
          set -euo pipefail
          HAS_PENDING=$(jlo workflow exchange inspect | jq '(.events.pending_files | length) > 0')
          RUN_DECIDER=false
          if [ "$REQUEST_DECIDER" = "true" ] && [ "$HAS_PENDING" = "true" ]; then
            RUN_DECIDER=true
          fi
          echo "json={\"has_pending\":$HAS_PENDING,\"run_decider\":$RUN_DECIDER}" >> "$GITHUB_OUTPUT"
