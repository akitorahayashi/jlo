  generate-planner-matrix:
    needs: [check-schedule, generate-decider-matrix, run-decider, wait-after-decider]
    if: |
      always() &&
      (fromJSON(needs.check-schedule.outputs.json).run_planner == true || fromJSON(needs.check-schedule.outputs.json).run_implementer == true) &&
      (needs.generate-decider-matrix.result == 'success' || needs.generate-decider-matrix.result == 'skipped') &&
      (needs.run-decider.result == 'success' || needs.run-decider.result == 'skipped') &&
      (needs.wait-after-decider.result == 'success' || needs.wait-after-decider.result == 'skipped')
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - name: Resolve planner/implementer run requests
        id: matrix
        env:
          REQUEST_PLANNER: {{ gha_expr("fromJSON(needs.check-schedule.outputs.json).run_planner") }}
          REQUEST_IMPLEMENTER: {{ gha_expr("fromJSON(needs.check-schedule.outputs.json).run_implementer") }}
        run: |
          set -euo pipefail
          OUTPUT_JSON=$(jlo workflow workspace inspect | jq -c --argjson req_planner "$REQUEST_PLANNER" --argjson req_implementer "$REQUEST_IMPLEMENTER" '{
            run_planner: ($req_planner and (([.requirements.items[] | select(.requires_deep_analysis == true)] | length) > 0)),
            run_implementer: ($req_implementer and (([.requirements.items[] | select(.requires_deep_analysis == false)] | length) > 0))
          }')
          echo "json=$OUTPUT_JSON" >> "$GITHUB_OUTPUT"
