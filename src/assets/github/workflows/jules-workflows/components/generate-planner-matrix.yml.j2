  generate-planner-matrix:
    needs: [check-schedule, generate-decider-matrix, run-decider, wait-after-decider]
    if: |
      always() &&
      fromJSON(needs.check-schedule.outputs.json).should_run == true &&
      (needs.generate-decider-matrix.result == 'success' || needs.generate-decider-matrix.result == 'skipped') &&
      (needs.run-decider.result == 'success' || needs.run-decider.result == 'skipped') &&
      (needs.wait-after-decider.result == 'success' || needs.wait-after-decider.result == 'skipped')
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: '{{ worker_branch }}'
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Discover requirements for routing
        id: matrix
        run: |
          set -euo pipefail
          INSPECT=$(jlo workflow workspace inspect)
          REQ_COUNT=$(echo "$INSPECT" | jq '.requirements.count')
          DEEP=$(echo "$INSPECT" | jq '[.requirements.items[] | select(.requires_deep_analysis == true)] | length')
          SHALLOW=$(echo "$INSPECT" | jq '[.requirements.items[] | select(.requires_deep_analysis == false)] | length')
          HAS_PLANNERS=$([ "$DEEP" -gt 0 ] && echo true || echo false)
          HAS_IMPLEMENTERS=$([ "$SHALLOW" -gt 0 ] && echo true || echo false)
          echo "json={\"has_planners\":$HAS_PLANNERS,\"has_implementers\":$HAS_IMPLEMENTERS,\"requirement_count\":$REQ_COUNT}" >> "$GITHUB_OUTPUT"
