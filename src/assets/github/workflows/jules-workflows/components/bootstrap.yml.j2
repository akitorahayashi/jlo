  bootstrap:
    if: >-
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      ((vars.JLO_PAUSED || 'false') != 'true' || github.event_name != 'schedule')
    runs-on: {{ runner }}
    timeout-minutes: 10
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: '{{ target_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Sync worker branch
        run: jlo workflow bootstrap worker-branch

      - name: Bootstrap managed files
        run: jlo workflow bootstrap managed-files

      - name: Reset narrator changes summary
        run: jlo workflow bootstrap exchange-changes

      - name: Validate repository
        run: jlo workflow doctor

      - name: Publish bootstrap updates via worker-branch merge path
        run: |
          set -euo pipefail
          if [ -z "$(git status --porcelain .jules)" ]; then
            echo "No bootstrap changes detected."
            exit 0
          fi

          pr_body=$(cat <<EOF
          Automated bootstrap update for the runtime workspace.

          - synchronize ${JLO_TARGET_BRANCH} into ${JULES_WORKER_BRANCH} via \`jlo workflow bootstrap worker-branch\`
          - bootstrap managed files via \`jlo workflow bootstrap managed-files\`
          - reset narrator summary via \`jlo workflow bootstrap exchange-changes\`
          EOF
          )
          jlo_version="$(jlo --version | cut -d ' ' -f 2)"
          jlo workflow push worker-branch \
            --change-token "bootstrap" \
            --commit-message "chore: bootstrap .jules/ runtime repository [jlo ${jlo_version}]" \
            --pr-title "chore: bootstrap runtime workspace" \
            --pr-body "${pr_body}"
