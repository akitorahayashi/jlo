  bootstrap:
    if: >-
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') &&
      ((vars.JLO_PAUSED || 'false') != 'true' || github.event_name != 'schedule')
    runs-on: {{ runner }}
    timeout-minutes: 10
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: '{{ target_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Ensure worker branch
        run: |
          set -euo pipefail
          git fetch origin "${JLO_TARGET_BRANCH}"
          if git ls-remote --exit-code --heads origin "${JULES_WORKER_BRANCH}" >/dev/null 2>&1; then
            echo "${JULES_WORKER_BRANCH} branch exists, checking out"
          else
            echo "Creating ${JULES_WORKER_BRANCH} from ${JLO_TARGET_BRANCH} via GitHub API"
            target_sha="$(git rev-parse "origin/${JLO_TARGET_BRANCH}")"
            gh api \
              --method POST \
              "/repos/${GITHUB_REPOSITORY}/git/refs" \
              -f ref="refs/heads/${JULES_WORKER_BRANCH}" \
              -f sha="${target_sha}" >/dev/null
          fi
          git fetch origin "${JULES_WORKER_BRANCH}"
          git checkout -B "${JULES_WORKER_BRANCH}" "origin/${JULES_WORKER_BRANCH}"

      - name: Merge target branch into worker
        run: |
          set -euo pipefail
          git fetch origin "$JLO_TARGET_BRANCH"
          # Merge control branch, preferring control-plane code changes.
          git merge "origin/$JLO_TARGET_BRANCH" --no-edit -X theirs --allow-unrelated-histories || {
            # On conflict, preserve runtime plane from the worker branch.
            git checkout --ours .jules/
            git add .jules/
            if git diff --cached --quiet; then
              echo "::error::Merge failed and no conflict resolution changes were staged."
              exit 1
            fi
            git commit --no-edit
          }

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Bootstrap runtime repository
        run: jlo workflow bootstrap

      - name: Commit changes and open bootstrap PR
        id: bootstrap
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain .jules)" ]; then
            git add .jules/
            git commit -m "chore: bootstrap .jules/ runtime repository [jlo $(jlo --version | awk '{print $2}')]"
          fi

          ahead_count="$(git rev-list --count "origin/${JULES_WORKER_BRANCH}..HEAD")"
          if [ "${ahead_count}" -eq 0 ]; then
            echo "committed=false" >> "$GITHUB_OUTPUT"
            echo "pr_created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          bootstrap_branch="jules-bootstrap-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}"
          git checkout -B "${bootstrap_branch}"
          git push origin "${bootstrap_branch}"

          pr_number="$(gh pr list \
            --state open \
            --head "${bootstrap_branch}" \
            --base "${JULES_WORKER_BRANCH}" \
            --json number \
            --jq '.[0].number')"
          if [ -z "${pr_number}" ] || [ "${pr_number}" = "null" ]; then
            pr_body=$'Automated bootstrap update for the runtime workspace.\n\n- synchronize '"${JLO_TARGET_BRANCH}"' into '"${JULES_WORKER_BRANCH}"$'\n- materialize .jules via jlo workflow bootstrap'
            gh pr create \
              --base "${JULES_WORKER_BRANCH}" \
              --head "${bootstrap_branch}" \
              --title "chore: bootstrap runtime workspace" \
              --body "${pr_body}"

            pr_number="$(gh pr list \
              --state open \
              --head "${bootstrap_branch}" \
              --base "${JULES_WORKER_BRANCH}" \
              --json number \
              --jq '.[0].number')"
            echo "pr_created=true" >> "$GITHUB_OUTPUT"
          else
            echo "pr_created=false" >> "$GITHUB_OUTPUT"
          fi

          echo "committed=true" >> "$GITHUB_OUTPUT"
          echo "pr_number=${pr_number}" >> "$GITHUB_OUTPUT"
