{%- macro run_agent_job(job_name, needs_job, check_output_key, layer, step_label, extra_env_vars={}, needs_list=none, if_condition=none, extra_run_args='', checkout_ref=none) %}
  {{ job_name }}:
    needs: {{ needs_list if needs_list else "[" ~ needs_job ~ "]" }}
    if: |
      {{ (if_condition if if_condition else "needs." ~ needs_job ~ ".result == 'success' &&\n      fromJSON(needs." ~ needs_job ~ ".outputs.json)." ~ check_output_key ~ " == true") | indent(6) }}

    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      {%- for key in extra_env_vars %}
      {{ key }}: {{ extra_env_vars[key] }}
      {%- endfor %}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: '{{ checkout_ref if checkout_ref else worker_branch }}'
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: {{ step_label }}
        id: run
        run: |
          set -euo pipefail
          jlo workflow run {{ layer }} {{ gha_raw("env.JLO_RUN_FLAGS") }}{% if extra_run_args %} {{ extra_run_args }}{% endif %}

{%- endmacro %}
