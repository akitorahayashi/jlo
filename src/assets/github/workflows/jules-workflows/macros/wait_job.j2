{%- macro wait_for_processing(job_name, needs, run_job, process_name, if_condition=none, wait_requested_expr=none, skip_message=none) %}
  {{ job_name }}:
    needs: {{ needs }}
    if: |
      {{ (if_condition if if_condition else "needs." ~ run_job ~ ".result == 'success'") | indent(6) }}
    runs-on: {{ runner }}
    timeout-minutes: 60
    outputs:
      json: {{ gha_expr("steps.wait.outputs.json") }}
    {%- if wait_requested_expr %}
    env:
      WAIT_REQUESTED: {{ gha_expr(wait_requested_expr) }}
    {%- endif %}
    steps:
      - name: Wait {{ gha_raw("env.WAIT_MINUTES") }} minutes for Jules async processing
        id: wait
        shell: bash
        run: |
          set -euo pipefail
          trap 'echo "Cancellation detected. Exiting wait early."; exit 130' INT TERM

          {%- if wait_requested_expr %}
          if [ "$WAIT_REQUESTED" != "true" ]; then
            TOTAL_SECONDS=0
            echo "{{ skip_message if skip_message else 'Wait not requested; skipping wait.' }}"
          elif [ "{{ gha_expr("env.MOCK_MODE") }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$(({{ gha_expr("env.WAIT_MINUTES") }} * 60))
          fi
          {%- else %}
          if [ "{{ gha_expr("env.MOCK_MODE") }}" = "true" ]; then
            TOTAL_SECONDS=15
            echo "Mock mode enabled: overriding wait to 15 seconds."
          else
            TOTAL_SECONDS=$(({{ gha_expr("env.WAIT_MINUTES") }} * 60))
          fi
          {%- endif %}

          if [ "$TOTAL_SECONDS" -le 0 ]; then
            echo "Wait skipped (TOTAL_SECONDS=$TOTAL_SECONDS)."
            echo "json={}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          {%- if process_name %}
            echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process {{ process_name }}..."
          {%- else %}
            echo "Waiting ${TOTAL_SECONDS} seconds for Jules to process..."
          {%- endif %}
          ELAPSED=0
          INTERVAL=5
          while [ $ELAPSED -lt $TOTAL_SECONDS ]; do
            STEP=$INTERVAL
            REMAINING=$((TOTAL_SECONDS - ELAPSED))
            if [ "$REMAINING" -lt "$STEP" ]; then
              STEP=$REMAINING
            fi
            sleep "$STEP" &
            wait $!
            ELAPSED=$((ELAPSED + STEP))
            echo "[$ELAPSED/$TOTAL_SECONDS seconds]"
          done
          echo "Wait complete."
          echo "json={}" >> "$GITHUB_OUTPUT"
{%- endmacro %}
