# This file is auto-generated. Do not edit manually.
# Jules Agent Orchestration
#
# Orchestrates scheduled/dispatch layer execution in sequence.
# Implementer PR metadata and auto-merge are delegated to dedicated workflows.
# Layer/task orchestration is command-driven through `jlo workflow`.

name: Jules Scheduled Workflows

on:
  schedule:
{% for cron in workflow_schedule_crons %}
    - cron: '{{ cron }}'
{% endfor %}
  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: choice
        options:
          - narrator
          - innovators
          - observers
          - decider
          - requirements
        default: narrator
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: 'jules-orchestration'
  cancel-in-progress: false

env:
  WAIT_MINUTES: {{ gha_expr("github.event_name == 'workflow_dispatch' && (github.event.inputs.wait_minutes || " ~ workflow_wait_minutes_default ~ ") || " ~ workflow_wait_minutes_default) }}
  MOCK_MODE: {{ gha_expr("github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true' || false") }}
  JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
  JLO_RUN_FLAGS: {{ gha_expr("github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true' && '--mock' || ''") }}
  JLO_TARGET_BRANCH: '{{ target_branch }}'
  JULES_WORKER_BRANCH: '{{ worker_branch }}'
{% import "workflows/jules-workflows/macros/wait_job.j2" as wait_macro %}
{% import "workflows/jules-workflows/macros/run_job.j2" as run_macro %}
jobs:
  # ============================================================
  # Phase 0: Bootstrap runtime repository on worker branch
  # ============================================================
{% include "workflows/jules-workflows/components/bootstrap.yml.j2" %}

  # ============================================================
  # Phase 1: Resolve run plan
  # ============================================================
{% include "workflows/jules-workflows/components/resolve-run-plan.yml.j2" %}

  # ============================================================
  # Phase 2: Run narrator
  # ============================================================
{{ run_macro.run_agent_job(
    job_name='run-narrator',
    needs_job='resolve-run-plan',
    check_output_key='run_narrator',
    layer='narrator',
    step_label='Run narrator'
) }}
  # ============================================================
  # Phase 3: Run innovators
  # ============================================================
{{ run_macro.run_agent_job(
    job_name='run-innovators',
    needs_job='bootstrap',
    check_output_key='ignored',
    layer='innovators',
    step_label='Run innovators',
    needs_list=['bootstrap'],
    if_condition="needs.bootstrap.result == 'success' &&
((vars.JLO_PAUSED || 'false') != 'true' || github.event_name != 'schedule') &&
(
  github.event_name == 'schedule' ||
  (
    github.event_name == 'workflow_dispatch' &&
    (github.event.inputs.entry_point || 'narrator') == 'innovators'
  )
)",
    extra_run_args='--task create_three_proposals'
) }}
  # ============================================================
  # Phase 4: Wait for innovators processing
  # ============================================================
{{ wait_macro.wait_for_processing(
    job_name='wait-after-run-innovators',
    needs=['run-innovators'],
    run_job='run-innovators',
    process_name='innovators',
    if_condition="always() &&
needs.run-innovators.result == 'success' &&
fromJSON(needs.run-innovators.outputs.json).number_of_api_requests_succeeded > 0"
) }}
  # ============================================================
  # Phase 5: Publish innovators proposals
  # ============================================================
{% include "workflows/jules-workflows/components/publish-proposals.yml.j2" %}
  # ============================================================
  # Phase 6: Wait for narrator processing
  # ============================================================
{{ wait_macro.wait_for_processing(
    job_name='wait-after-narrator',
    needs=['resolve-run-plan', 'run-narrator'],
    run_job='run-narrator',
    process_name='narrator',
    if_condition="always() &&
needs.resolve-run-plan.result == 'success' &&
(
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_narrator == true &&
    needs.run-narrator.result == 'success'
  ) ||
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_narrator == false &&
    needs.run-narrator.result == 'skipped'
  )
)",
    wait_requested_expr='fromJSON(needs.resolve-run-plan.outputs.json).run_narrator',
    skip_message='Narrator not requested; skipping wait.'
) }}
  # ============================================================
  # Phase 7: Run observers
  # ============================================================
{{ run_macro.run_agent_job(
    'run-observers',
    'wait-after-narrator',
    'json',
    'observers',
    'Run observers',
    {},
    ['resolve-run-plan', 'wait-after-narrator'],
    "fromJSON(needs.resolve-run-plan.outputs.json).run_observers == true &&
      needs.wait-after-narrator.result == 'success'"
) }}
  # ============================================================
  # Phase 8: Wait for observer processing
  # ============================================================
{{ wait_macro.wait_for_processing(
    job_name='wait-after-observers',
    needs=['run-observers'],
    run_job='run-observers',
    process_name='observers',
    if_condition="always() &&
needs.run-observers.result == 'success' &&
fromJSON(needs.run-observers.outputs.json).number_of_api_requests_succeeded > 0"
) }}
  # ============================================================
  # Phase 9: Run decider
  # ============================================================
{{ run_macro.run_agent_job(
    'run-decider',
    'resolve-run-plan',
    'run_decider',
    'decider',
    'Run decider',
    {},
    ['resolve-run-plan', 'wait-after-observers'],
    "always() &&
needs.resolve-run-plan.result == 'success' &&
fromJSON(needs.resolve-run-plan.outputs.json).run_decider == true &&
(
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_observers == true &&
    needs.wait-after-observers.result == 'success'
  ) ||
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_observers == false &&
    needs.wait-after-observers.result == 'skipped'
  )
)"
) }}
  # ============================================================
  # Phase 10: Wait for decider processing
  # ============================================================
{{ wait_macro.wait_for_processing(
    job_name='wait-after-decider',
    needs=['run-decider'],
    run_job='run-decider',
    process_name='decider',
    if_condition="always() &&
needs.run-decider.result == 'success' &&
fromJSON(needs.run-decider.outputs.json).number_of_api_requests_succeeded > 0"
) }}
  # ============================================================
  # Phase 11: Run planner
  # ============================================================
{{ run_macro.run_agent_job(
    'run-planner',
    'resolve-run-plan',
    'run_planner',
    'planner',
    'Run planner',
    {},
    ['resolve-run-plan', 'wait-after-decider'],
    "always() &&
needs.resolve-run-plan.result == 'success' &&
fromJSON(needs.resolve-run-plan.outputs.json).run_planner == true &&
(
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_decider == true &&
    needs.wait-after-decider.result == 'success'
  ) ||
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_decider == false &&
    needs.wait-after-decider.result == 'skipped'
  )
)"
) }}
  # ============================================================
  # Phase 12: Wait for planner PRs
  # ============================================================
{{ wait_macro.wait_for_processing(
    job_name='wait-after-planner',
    needs=['run-planner'],
    run_job='run-planner',
    process_name='planner',
    if_condition="always() &&
needs.run-planner.result == 'success' &&
fromJSON(needs.run-planner.outputs.json).number_of_api_requests_succeeded > 0"
) }}
  # ============================================================
  # Phase 13: Run implementer
  # ============================================================
{{ run_macro.run_agent_job(
    'run-implementer',
    'resolve-run-plan',
    'run_implementer',
    'implementer',
    'Run implementer',
    {},
    ['resolve-run-plan', 'wait-after-decider'],
    "always() &&
needs.resolve-run-plan.result == 'success' &&
fromJSON(needs.resolve-run-plan.outputs.json).run_implementer == true &&
(
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_decider == true &&
    needs.wait-after-decider.result == 'success'
  ) ||
  (
    fromJSON(needs.resolve-run-plan.outputs.json).run_decider == false &&
    needs.wait-after-decider.result == 'skipped'
  )
)",
    extra_run_args='--branch "${JLO_TARGET_BRANCH}"'
) }}
  # ============================================================
  # Phase 14: Wait for implementer labels
  # ============================================================
{{ wait_macro.wait_for_processing(
    job_name='wait-after-implementer',
    needs=['run-implementer'],
    run_job='run-implementer',
    process_name='implementer',
    if_condition="always() &&
needs.run-implementer.result == 'success' &&
fromJSON(needs.run-implementer.outputs.json).number_of_api_requests_succeeded > 0"
) }}

  # ============================================================
  # Phase 15: Cleanup mock artifacts
  # ============================================================
{% include "workflows/jules-workflows/components/cleanup-mock-artifacts.yml.j2" %}
