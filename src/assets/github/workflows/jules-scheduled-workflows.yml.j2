# Jules Agent Orchestration
#
# Orchestrates sequential execution and PR event handling from a single workflow.
# Layer-phase orchestration, metadata synchronization, and auto-merge delegation
# are command-driven through `jlo workflow`.

name: Jules Scheduled Workflows

on:
  schedule:
{% for cron in workflow_schedule_crons %}
    - cron: '{{ cron }}'
{% endfor %}
  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: choice
        options:
          - narrator
          - observers
          - decider
          - planner
          - implementer
          - innovators
        default: narrator
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false

  workflow_call:
    inputs:
      entry_point:
        type: string
        default: narrator
      wait_minutes:
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        type: boolean
        default: false

  push:
    branches:
      - 'jules-implementer-*'

  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - '{{ worker_branch }}'

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: {{ gha_expr("(github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') && 'jules-orchestration' || format('jules-events-{0}-{1}', github.event_name, github.ref_name)") }}
  cancel-in-progress: false

env:
  WAIT_MINUTES: {{ gha_expr("inputs.wait_minutes || " ~ workflow_wait_minutes_default) }}
  MOCK_MODE: {{ gha_expr("inputs.mock || false") }}
  JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
  JLO_RUN_FLAGS: {{ gha_expr("(inputs.mock || false) && '--mock' || ''") }}
  JLO_TARGET_BRANCH: '{{ target_branch }}'
  JULES_WORKER_BRANCH: '{{ worker_branch }}'
{% import "workflows/jules-workflows/macros/wait_job.j2" as wait_macro %}
{% import "workflows/jules-workflows/macros/run_job.j2" as run_macro %}
jobs:
  process-implementer-pr-metadata:
    if: {{ gha_expr("github.event_name == 'push' && startsWith(github.ref_name, 'jules-implementer-')") }}
    runs-on: {{ runner }}
    concurrency:
      group: {{ gha_expr("format('jules-implementer-pr-{0}', github.ref_name)") }}
      cancel-in-progress: true
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          # Label definitions and contracts are read from the worker branch.
          ref: '{{ worker_branch }}'
          fetch-depth: 1
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Discover PR number
        id: discover
        env:
          GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
          BRANCH_NAME: {{ gha_expr("github.ref_name") }}
          REPO: {{ gha_expr("github.repository") }}
        run: |
          set -euo pipefail
          PR_NUMBER=""
          ATTEMPTS=24
          for _ in $(seq 1 "$ATTEMPTS"); do
            PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --repo "$REPO" --json number -q '.[0].number')
            if [ -n "$PR_NUMBER" ]; then
              break
            fi
            sleep 5
          done
          if [ -z "$PR_NUMBER" ]; then
            echo "::notice::No PR found yet for branch $BRANCH_NAME. Skipping metadata sync."
            echo "found=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "found=true" >> "$GITHUB_OUTPUT"

      - name: Install jlo
        if: steps.discover.outputs.found == 'true'
        uses: ./.github/actions/install-jlo

      - name: Validate linked GitHub token
        if: steps.discover.outputs.found == 'true'
        env:
          LINKED_GH_TOKEN: {{ gha_expr("secrets.JULES_LINKED_GH_PAT") }}
        run: |
          set -euo pipefail
          if [ -z "${LINKED_GH_TOKEN}" ]; then
            echo "::error::JULES_LINKED_GH_PAT is required for implementer PR metadata processing."
            exit 1
          fi

      - name: Process PR metadata
        if: steps.discover.outputs.found == 'true'
        env:
          GH_TOKEN: {{ gha_expr("secrets.JULES_LINKED_GH_PAT") }}
        run: |
          set -euo pipefail
          jlo workflow gh pr process {{ gha_expr("steps.discover.outputs.pr_number") }} --mode metadata --fail-on-error

  validate-and-automerge:
    if: {{ gha_expr("github.event_name == 'pull_request' && github.base_ref == '" ~ worker_branch ~ "'") }}
    runs-on: {{ runner }}
    concurrency:
      group: {{ gha_expr("format('jules-automerge-pr-{0}', github.event.pull_request.number)") }}
      cancel-in-progress: false
    steps:
      - name: Validate branch variables
        run: |
          set -euo pipefail
          if [ -z "${JLO_TARGET_BRANCH:-}" ]; then
            echo "::error::JLO_TARGET_BRANCH is required."
            exit 1
          fi
          if [ -z "${JULES_WORKER_BRANCH:-}" ]; then
            echo "::error::JULES_WORKER_BRANCH is required."
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          ref: {{ gha_expr("github.head_ref") }}
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Validate with doctor
        run: |
          echo "::group::Doctor check"
          jlo workflow doctor
          echo "::endgroup::"

      - name: Process PR auto-merge
        env:
          GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
        run: |
          set -euo pipefail
          jlo workflow gh pr process {{ gha_expr("github.event.pull_request.number") }} \
            --mode automerge \
            --retry-attempts 12 \
            --retry-delay-seconds 10 \
            --fail-on-error

  # ============================================================
  # Phase 0: Bootstrap runtime workspace on worker branch
  # ============================================================
{% include "workflows/jules-workflows/components/bootstrap.yml.j2" %}

  # ============================================================
  # Phase 1: Run narrator (changes feed generation)
  # ============================================================
{% include "workflows/jules-workflows/components/run-narrator.yml.j2" %}

  # ============================================================
  # Phase 2: Wait for narrator processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-narrator', 'run-narrator', 'run-narrator', 'narrator') }}
  # ============================================================
  # Phase 3: Check schedule
  # ============================================================
{% include "workflows/jules-workflows/components/check-schedule.yml.j2" %}

  # ============================================================
  # Phase 4: Run innovators (first pass - idea creation)
  # ============================================================
{{ run_macro.run_agent_job(
    'run-innovators-1',
    'check-schedule',
    'should_run',
    'innovators',
    'Run innovators (first pass)',
    extra_run_args='--phase creation'
) }}
  # ============================================================
  # Phase 5: Run observers
  # ============================================================
{{ run_macro.run_agent_job(
    'run-observers',
    'check-schedule',
    'should_run',
    'observers',
    'Run observers'
) }}
  # ============================================================
  # Phase 6: Wait for observer processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-observers', 'run-observers', 'run-observers', 'observers') }}
  # ============================================================
  # Phase 7: Wait for innovator processing (first pass)
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-innovators-1', 'run-innovators-1', 'run-innovators-1', 'innovators (first pass)') }}
  # ============================================================
  # Phase 8: Run innovators (second pass - proposal and cleanup)
  # ============================================================
{{ run_macro.run_agent_job(
    'run-innovators-2',
    'check-schedule',
    'should_run',
    'innovators',
    'Run innovators (second pass)',
    {},
    ['check-schedule', 'wait-after-observers', 'wait-after-innovators-1'],
    "always() &&
      fromJSON(needs.check-schedule.outputs.json).should_run == true &&
      (needs.wait-after-observers.result == 'success' || needs.wait-after-observers.result == 'skipped') &&
      (needs.wait-after-innovators-1.result == 'success' || needs.wait-after-innovators-1.result == 'skipped')",
    extra_run_args='--phase refinement'
) }}
  # ============================================================
  # Phase 9: Wait for innovator processing (second pass)
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-innovators-2', 'run-innovators-2', 'run-innovators-2', 'innovators (second pass)') }}
  # ============================================================
  # Phase 10: Publish innovator proposals as GitHub issues
  # ============================================================
{% include "workflows/jules-workflows/components/publish-proposals.yml.j2" %}

  # ============================================================
  # Phase 11: Check for pending events (decider gate)
  # ============================================================
{% include "workflows/jules-workflows/components/generate-decider-matrix.yml.j2" %}

  # ============================================================
  # Phase 12: Run decider
  # ============================================================
{{ run_macro.run_agent_job(
    'run-decider',
    'generate-decider-matrix',
    'has_pending',
    'decider',
    'Run decider'
) }}
  # ============================================================
  # Phase 13: Wait for decider processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-decider', 'run-decider', 'run-decider', 'decider') }}
  # ============================================================
  # Phase 14: Discover requirements for routing
  # ============================================================
{% include "workflows/jules-workflows/components/generate-planner-matrix.yml.j2" %}

  # ============================================================
  # Phase 15: Run planner
  # ============================================================
{{ run_macro.run_agent_job(
    'run-planner',
    'generate-planner-matrix',
    'has_planners',
    'planner',
    'Run planner'
) }}
  # ============================================================
  # Phase 16: Wait for planner PRs
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-planner', 'run-planner', 'run-planner', 'planner') }}
  # ============================================================
  # Phase 17: Run implementer
  # ============================================================
{{ run_macro.run_agent_job(
    'run-implementer',
    'generate-planner-matrix',
    'has_implementers',
    'implementer',
    'Run implementer',
  {'TARGET_BRANCH': "'" ~ target_branch ~ "'"}
) }}
  # ============================================================
  # Phase 18: Wait for implementer labels
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-implementer', 'run-implementer', 'run-implementer', 'implementer') }}

  # ============================================================
  # Phase 19: Cleanup mock artifacts
  # ============================================================
{% include "workflows/jules-workflows/components/cleanup-mock-artifacts.yml.j2" %}
