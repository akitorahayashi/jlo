# This file is auto-generated. Do not edit manually.
# Jules Agent Orchestration
#
# Orchestrates scheduled/dispatch layer execution in sequence.
# Implementer PR metadata and auto-merge are delegated to dedicated workflows.
# Layer/task orchestration is command-driven through `jlo workflow`.

name: Jules Scheduled Workflows

on:
  schedule:
{% for cron in workflow_schedule_crons %}
    - cron: '{{ cron }}'
{% endfor %}
  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: choice
        options:
          - narrator
          - observers
          - decider
        default: narrator
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false

  workflow_call:
    inputs:
      entry_point:
        type: string
        default: narrator
      wait_minutes:
        type: number
        default: {{ workflow_wait_minutes_default }}
      mock:
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: 'jules-orchestration'
  cancel-in-progress: false

env:
  WAIT_MINUTES: {{ gha_expr("inputs.wait_minutes || " ~ workflow_wait_minutes_default) }}
  MOCK_MODE: {{ gha_expr("inputs.mock || false") }}
  JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
  JLO_RUN_FLAGS: {{ gha_expr("(inputs.mock || false) && '--mock' || ''") }}
  JLO_TARGET_BRANCH: '{{ target_branch }}'
  JULES_WORKER_BRANCH: '{{ worker_branch }}'
{% import "workflows/jules-workflows/macros/wait_job.j2" as wait_macro %}
{% import "workflows/jules-workflows/macros/run_job.j2" as run_macro %}
jobs:
  # ============================================================
  # Phase 0: Bootstrap runtime workspace on worker branch
  # ============================================================
{% include "workflows/jules-workflows/components/bootstrap.yml.j2" %}

  # ============================================================
  # Phase 1: Check schedule
  # ============================================================
{% include "workflows/jules-workflows/components/check-schedule.yml.j2" %}

  # ============================================================
  # Phase 2: Run narrator (changes feed generation)
  # ============================================================
{% include "workflows/jules-workflows/components/run-narrator.yml.j2" %}
  # ============================================================
  # Phase 3: Run innovators (first pass - idea creation)
  # ============================================================
{{ run_macro.run_agent_job(
    'run-innovators-1',
    'check-schedule',
    'run_innovators_1',
    'innovators',
    'Run innovators (first pass)',
    extra_run_args='--task create_idea'
) }}
  # ============================================================
  # Phase 4: Wait for narrator + innovators (first pass)
  # ============================================================
{% include "workflows/jules-workflows/components/wait-after-initial-requests.yml.j2" %}
  # ============================================================
  # Phase 5: Run observers
  # ============================================================
{{ run_macro.run_agent_job(
    'run-observers',
    'wait-after-initial-requests',
    'json',
    'observers',
    'Run observers',
    {},
    ['check-schedule', 'wait-after-initial-requests'],
    "fromJSON(needs.check-schedule.outputs.json).run_observers == true &&
      needs.wait-after-initial-requests.result == 'success'"
) }}
  # ============================================================
  # Phase 6: Wait for observer processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-observers', 'run-observers', 'run-observers', 'observers') }}
  # ============================================================
  # Phase 7: Run innovators (second pass - proposal and cleanup)
  # ============================================================
{{ run_macro.run_agent_job(
    'run-innovators-2',
    'check-schedule',
    'run_innovators_2',
    'innovators',
    'Run innovators (second pass)',
    {},
    ['check-schedule', 'wait-after-observers'],
    "fromJSON(needs.check-schedule.outputs.json).run_innovators_2 == true &&
      needs.wait-after-observers.result == 'success'",
    extra_run_args='--task refine_idea_and_create_proposal'
) }}
  # ============================================================
  # Phase 8: Wait for innovator processing (second pass)
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-innovators-2', 'run-innovators-2', 'run-innovators-2', 'innovators (second pass)') }}
  # ============================================================
  # Phase 9: Publish innovator proposals as GitHub issues
  # ============================================================
{% include "workflows/jules-workflows/components/publish-proposals.yml.j2" %}

  # ============================================================
  # Phase 10: Check for pending events (decider gate)
  # ============================================================
{% include "workflows/jules-workflows/components/generate-decider-matrix.yml.j2" %}

  # ============================================================
  # Phase 11: Run decider
  # ============================================================
{{ run_macro.run_agent_job(
    'run-decider',
    'generate-decider-matrix',
    'run_decider',
    'decider',
    'Run decider'
) }}
  # ============================================================
  # Phase 12: Wait for decider processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-decider', 'run-decider', 'run-decider', 'decider') }}
  # ============================================================
  # Phase 13: Resolve planner/implementer run requests
  # ============================================================
{% include "workflows/jules-workflows/components/generate-routing-matrix.yml.j2" %}

  # ============================================================
  # Phase 14: Run planner
  # ============================================================
{{ run_macro.run_agent_job(
    'run-planner',
    'generate-routing-matrix',
    'run_planner',
    'planner',
    'Run planner'
) }}
  # ============================================================
  # Phase 15: Wait for planner PRs
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-planner', 'run-planner', 'run-planner', 'planner') }}
  # ============================================================
  # Phase 16: Run implementer
  # ============================================================
{{ run_macro.run_agent_job(
    'run-implementer',
    'generate-routing-matrix',
    'run_implementer',
    'implementer',
    'Run implementer',
  {'TARGET_BRANCH': "'" ~ target_branch ~ "'"}
) }}
  # ============================================================
  # Phase 17: Wait for implementer labels
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-implementer', 'run-implementer', 'run-implementer', 'implementer') }}

  # ============================================================
  # Phase 18: Cleanup mock artifacts
  # ============================================================
{% include "workflows/jules-workflows/components/cleanup-mock-artifacts.yml.j2" %}
