{%- macro run_agent_job(job_name, needs_job, check_output_key, role, jq_path, step_label, sort_unique=false, extra_env_vars={}, needs_list=none, if_condition=none) %}
  {{ job_name }}:
    needs: {{ needs_list if needs_list else "[" ~ needs_job ~ "]" }}
    if: |
      {{ (if_condition if if_condition else "always() &&
      needs." ~ needs_job ~ ".result == 'success' &&
      fromJSON(needs." ~ needs_job ~ ".outputs.json)." ~ check_output_key ~ " == true") | indent(6) }}

    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      {%- for key in extra_env_vars %}
      {{ key }}: {{ extra_env_vars[key] }}
      {%- endfor %}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: {{ step_label }}
        id: run
        env:
          MATRIX_OUTPUT: {{ gha_expr("needs." ~ needs_job ~ ".outputs.json") }}
        run: |
          set -euo pipefail
          echo "$MATRIX_OUTPUT" | jq -r '{{ jq_path }}' {% if sort_unique %}| sort -u {% endif %}| while read ws; do
            [ -z "$ws" ] && continue
            echo "Running {{ role }} for workstream: $ws"
            jlo workflow run "$ws" {{ role }} {{ gha_raw("env.JLO_RUN_FLAGS") }}
          done
{%- endmacro %}
