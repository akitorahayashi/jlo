  run-narrator:
    if: >-
      vars.JULES_PAUSED != 'true' &&
      (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') == 'narrator') ||
        (github.event_name == 'workflow_call' && (inputs.entry_point || 'narrator') == 'narrator')
      )
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Validate .jules workspace exists
        run: |
          if [ ! -d ".jules" ]; then
            echo "::error::.jules directory is missing on the 'jules' branch."
            exit 1
          fi

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run narrator
        id: run
        run: jlo workflow run global narrator {{ gha_raw("env.JLO_RUN_FLAGS") }}

      - name: Validate workspace (fail-fast)
        run: jlo doctor
