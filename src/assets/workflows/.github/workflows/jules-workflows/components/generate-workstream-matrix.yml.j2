  generate-workstream-matrix:
    needs: wait-after-narrator
    if: |
      always() &&
      vars.JULES_PAUSED != 'true' &&
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') &&
      (needs.wait-after-narrator.result == 'success' || needs.wait-after-narrator.result == 'skipped')
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Validate .jules workspace
        run: |
          if [ ! -d ".jules" ]; then
            echo "::error::.jules directory is missing on the 'jules' branch."
            exit 1
          fi
          if ! ls .jules/workstreams/*/scheduled.toml >/dev/null 2>&1; then
            echo "::error::No workstream scheduled.toml found under .jules/workstreams/."
            exit 1
          fi

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Generate workstream matrix
        id: matrix
        run: jlo workflow matrix workstreams
