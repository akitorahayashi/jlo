# Jules Agent Orchestration
#
#
# Orchestrates sequential execution.
# Each phase reads state, generates a matrix, then executes sequentially.
# Role-layer runs stay inside a single job to avoid multiple runners.
#
# Narrator runs first to produce changes context, followed by doctor validation.
# Doctor validation is also handled by jules-automerge.yml as a pre-merge gate.

name: Jules Workflows

on:
  schedule:
    - cron: '0 20 * * *'  # Daily at 20:00 UTC (05:00 JST)
  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: choice
        options:
          - narrator
          - observers
          - deciders
          - planners
          - implementers
          - innovators
        default: narrator
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: 30
      routing_labels:
        description: 'Issue labels eligible for planner/implementer routing (comma-separated)'
        type: string
        default: 'bugs,feats,refacts,tests,docs'
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false

  workflow_call:
    inputs:
      entry_point:
        type: string
        default: narrator
      wait_minutes:
        type: number
        default: 30
      routing_labels:
        type: string
        default: 'bugs,feats,refacts,tests,docs'
      mock:
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: jules
  cancel-in-progress: false

env:
  WAIT_MINUTES: {{ gha_expr("inputs.wait_minutes || 30") }}
  ROUTING_LABELS: {{ gha_expr("inputs.routing_labels || 'bugs,feats,refacts,tests,docs'") }}
  MOCK_MODE: {{ gha_expr("github.event.inputs.mock || inputs.mock") }}
  JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
  JLO_RUN_FLAGS: {{ gha_expr("(github.event.inputs.mock || inputs.mock) && '--mock' || ''") }}
{% import "workflows/jules-workflows/macros/wait_job.j2" as wait_macro %}
{% import "workflows/jules-workflows/macros/run_job.j2" as run_macro %}
jobs:
  # ============================================================
  # Phase 1: Run narrator (changes feed generation)
  # ============================================================
{% include "workflows/jules-workflows/components/run-narrator.yml.j2" %}

  # ============================================================
  # Phase 2: Wait for narrator processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-narrator', 'run-narrator', 'run-narrator', 'narrator') }}
  # ============================================================
  # Phase 3: Generate workstream matrix
  # ============================================================
{% include "workflows/jules-workflows/components/generate-workstream-matrix.yml.j2" %}

  # ============================================================
  # Phase 4: Run innovators (first pass - idea creation)
  # ============================================================
{{ run_macro.run_agent_job(
    'run-innovators-1',
    'generate-workstream-matrix',
    'has_workstreams',
    'innovators',
    '.matrix.include[].workstream',
    'Run innovators (first pass) for each workstream'
) }}
  # ============================================================
  # Phase 5: Run observers
  # ============================================================
{{ run_macro.run_agent_job(
    'run-observers',
    'generate-workstream-matrix',
    'has_workstreams',
    'observers',
    '.matrix.include[].workstream',
    'Run observers for each workstream'
) }}
  # ============================================================
  # Phase 6: Wait for observer processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-observers', 'run-observers', 'run-observers', 'observers') }}
  # ============================================================
  # Phase 7: Wait for innovator processing (first pass)
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-innovators-1', 'run-innovators-1', 'run-innovators-1', 'innovators (first pass)') }}
  # ============================================================
  # Phase 8: Run innovators (second pass - proposal and cleanup)
  # ============================================================
{{ run_macro.run_agent_job(
    'run-innovators-2',
    'generate-workstream-matrix',
    'has_workstreams',
    'innovators',
    '.matrix.include[].workstream',
    'Run innovators (second pass) for each workstream',
    false,
    {},
    ['generate-workstream-matrix', 'wait-after-observers', 'wait-after-innovators-1'],
    "always() &&
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true &&
      (needs.wait-after-observers.result == 'success' || needs.wait-after-observers.result == 'skipped') &&
      (needs.wait-after-innovators-1.result == 'success' || needs.wait-after-innovators-1.result == 'skipped')"
) }}
  # ============================================================
  # Phase 9: Wait for innovator processing (second pass)
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-innovators-2', 'run-innovators-2', 'run-innovators-2', 'innovators (second pass)') }}
  # ============================================================
  # Phase 10: Publish innovator proposals as GitHub issues
  # ============================================================
{% include "workflows/jules-workflows/components/publish-proposals.yml.j2" %}

  # ============================================================
  # Phase 11: Generate decider matrix (pending events check)
  # ============================================================
{% include "workflows/jules-workflows/components/generate-decider-matrix.yml.j2" %}

  # ============================================================
  # Phase 12: Run deciders
  # ============================================================
{{ run_macro.run_agent_job(
    'run-deciders',
    'generate-decider-matrix',
    'has_pending',
    'deciders',
    '.matrix.include[].workstream',
    'Run deciders for each pending workstream'
) }}
  # ============================================================
  # Phase 13: Wait for decider processing
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-deciders', 'run-deciders', 'run-deciders', 'deciders') }}
  # ============================================================
  # Phase 14: Generate routing matrices (new issues)
  # ============================================================
{% include "workflows/jules-workflows/components/generate-planner-matrix.yml.j2" %}

  # ============================================================
  # Phase 15: Run planners
  # ============================================================
{{ run_macro.run_agent_job(
    'run-planners',
    'generate-planner-matrix',
    'has_planners',
    'planners',
    '.planner_matrix.include[].workstream // empty',
    'Run planners for each workstream',
    true
) }}
  # ============================================================
  # Phase 16: Wait for planner PRs
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-planners', 'run-planners', 'run-planners', 'planners') }}
  # ============================================================
  # Phase 17: Run implementers
  # ============================================================
{{ run_macro.run_agent_job(
    'run-implementers',
    'generate-planner-matrix',
    'has_implementers',
    'implementers',
    '.implementer_matrix.include[].workstream // empty',
    'Run implementers for each workstream',
    true,
    {'TARGET_BRANCH': gha_expr("vars.JULES_TARGET_BRANCH || 'main'")}
) }}
  # ============================================================
  # Phase 18: Wait for implementer labels
  # ============================================================
{{ wait_macro.wait_for_processing('wait-after-implementers', 'run-implementers', 'run-implementers', 'implementers') }}
