# Jules Agent Orchestration
#
#
# Orchestrates sequential execution.
# Each phase reads state, generates a matrix, then executes sequentially.
# Role-layer runs stay inside a single job to avoid multiple runners.
#
# Narrator runs first to produce changes context, followed by doctor validation.
# Doctor validation is also handled by jules-automerge.yml as a pre-merge gate.

name: Jules Workflows

on:
  schedule:
    - cron: '0 20 * * *'  # Daily at 20:00 UTC (05:00 JST)
  workflow_dispatch:
    inputs:
      entry_point:
        description: 'Start from layer'
        type: string
        default: narrator
      wait_minutes:
        description: 'Minutes to wait between layers (Jules async processing time)'
        type: number
        default: 30
      routing_labels:
        description: 'Issue labels eligible for planner/implementer routing (comma-separated)'
        type: string
        default: 'bugs,feats,refacts,tests,docs'
      mock:
        description: 'Run in mock mode (creates branches/PRs without Jules API)'
        type: boolean
        default: false

  workflow_call:
    inputs:
      entry_point:
        type: string
        default: narrator
      wait_minutes:
        type: number
        default: 30
      routing_labels:
        type: string
        default: 'bugs,feats,refacts,tests,docs'
      mock:
        type: boolean
        default: false

permissions:
  contents: write
  issues: write
  pull-requests: write

concurrency:
  group: jules
  cancel-in-progress: false

env:
  WAIT_MINUTES: {{ gha_expr("inputs.wait_minutes || 30") }}
  ROUTING_LABELS: {{ gha_expr("inputs.routing_labels || 'bugs,feats,refacts,tests,docs'") }}
  MOCK_MODE: {{ gha_expr("inputs.mock || false") }}
  JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
  JLO_RUN_FLAGS: {{ gha_expr("(inputs.mock || false) && '--mock' || ''") }}

jobs:
  # ============================================================
  # Phase 1: Run narrator (changes feed generation)
  # ============================================================
  run-narrator:
    if: >-
      vars.JULES_PAUSED != 'true' &&
      (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') == 'narrator') ||
        (github.event_name == 'workflow_call' && (inputs.entry_point || 'narrator') == 'narrator')
      )
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Validate .jules workspace exists
        run: |
          if [ ! -d ".jules" ]; then
            echo "::error::.jules directory is missing on the 'jules' branch."
            exit 1
          fi

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run narrator
        id: run
        run: jlo workflow run narrator ${{ gha_raw("env.JLO_RUN_FLAGS") }}

      - name: Validate workspace (fail-fast)
        run: jlo doctor

  # ============================================================
  # Phase 2: Wait for narrator processing
  # ============================================================
  wait-after-narrator:
    needs: run-narrator
    if: |
      always() &&
      needs.run-narrator.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 60
    outputs:
      json: {{ gha_expr("steps.wait.outputs.json") }}
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Wait for narrator PRs
        id: wait
        env:
          RUN_OUTPUT: {{ gha_expr("needs.run-narrator.outputs.json") }}
        run: |
          expected_count=$(echo "$RUN_OUTPUT" | jq -r '.expected_count')
          run_started_at=$(echo "$RUN_OUTPUT" | jq -r '.run_started_at')
          mock=$(echo "$RUN_OUTPUT" | jq -r '.mock // false')
          mock_prs=$(echo "$RUN_OUTPUT" | jq -c '.mock_pr_numbers // []')
          args=(
            workflow wait prs
            --layer narrator
            --base-branch jules
            --expected-count "$expected_count"
            --run-started-at "$run_started_at"
            --wait-minutes "$WAIT_MINUTES"
            --mode merge
          )
          if [ "$mock" = "true" ]; then
            args+=(--mock --mock-pr-numbers-json "$mock_prs")
          fi
          jlo "${args[@]}"

  # ============================================================
  # Phase 3: Generate workstream matrix
  # ============================================================
  generate-workstream-matrix:
    needs: wait-after-narrator
    if: |
      always() &&
      vars.JULES_PAUSED != 'true' &&
      (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' || github.event_name == 'workflow_call') &&
      (needs.wait-after-narrator.result == 'success' || needs.wait-after-narrator.result == 'skipped')
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Validate .jules workspace
        run: |
          if [ ! -d ".jules" ]; then
            echo "::error::.jules directory is missing on the 'jules' branch."
            exit 1
          fi
          if ! ls .jules/workstreams/*/scheduled.toml >/dev/null 2>&1; then
            echo "::error::No workstream scheduled.toml found under .jules/workstreams/."
            exit 1
          fi

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Generate workstream matrix
        id: matrix
        run: jlo workflow matrix workstreams

  # ============================================================
  # Phase 4: Generate observer matrix (role-level)
  # ============================================================
  generate-observer-matrix:
    needs: generate-workstream-matrix
    if: >-
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true &&
      (
        github.event_name == 'schedule' ||
        (github.event_name == 'workflow_dispatch' && (github.event.inputs.entry_point || 'narrator') != 'deciders') ||
        (github.event_name == 'workflow_call' && (inputs.entry_point || 'narrator') != 'deciders')
      )
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Generate observer matrix
        id: matrix
        env:
          WORKSTREAMS_JSON: {{ gha_expr("needs.generate-workstream-matrix.outputs.json") }}
        run: jlo workflow matrix roles --layer observers --workstreams-json "$WORKSTREAMS_JSON"

  # ============================================================
  # Phase 5: Run observers
  # ============================================================
  run-observers:
    needs: [generate-workstream-matrix, generate-observer-matrix]
    if: |
      always() &&
      needs.generate-observer-matrix.result == 'success' &&
      fromJSON(needs.generate-observer-matrix.outputs.json).has_roles == true
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run observers sequentially
        id: run
        env:
          MATRIX_JSON: {{ gha_expr("needs.generate-observer-matrix.outputs.json") }}
        run: jlo workflow run observers --matrix-json "$MATRIX_JSON" ${{ gha_raw("env.JLO_RUN_FLAGS") }}

  # ============================================================
  # Phase 6: Wait for observer processing
  # ============================================================
  wait-after-observers:
    needs: [generate-observer-matrix, run-observers]
    if: |
      always() &&
      needs.run-observers.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 60
    outputs:
      json: {{ gha_expr("steps.wait.outputs.json") }}
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Wait for observer PRs
        id: wait
        env:
          RUN_OUTPUT: {{ gha_expr("needs.run-observers.outputs.json") }}
        run: |
          expected_count=$(echo "$RUN_OUTPUT" | jq -r '.expected_count')
          run_started_at=$(echo "$RUN_OUTPUT" | jq -r '.run_started_at')
          mock=$(echo "$RUN_OUTPUT" | jq -r '.mock // false')
          mock_prs=$(echo "$RUN_OUTPUT" | jq -c '.mock_pr_numbers // []')
          args=(
            workflow wait prs
            --layer observers
            --base-branch jules
            --expected-count "$expected_count"
            --run-started-at "$run_started_at"
            --wait-minutes "$WAIT_MINUTES"
            --mode merge
          )
          if [ "$mock" = "true" ]; then
            args+=(--mock --mock-pr-numbers-json "$mock_prs")
          fi
          jlo "${args[@]}"

  # ============================================================
  # Phase 7: Generate decider matrix (pending events check)
  # ============================================================
  generate-decider-matrix:
    needs: [generate-workstream-matrix, generate-observer-matrix, wait-after-observers]
    if: |
      always() &&
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true &&
      (needs.generate-observer-matrix.result == 'success' || needs.generate-observer-matrix.result == 'skipped') &&
      (needs.wait-after-observers.result == 'success' || needs.wait-after-observers.result == 'skipped')
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Generate decider matrix from pending events
        id: matrix
        env:
          WORKSTREAMS_JSON: {{ gha_expr("needs.generate-workstream-matrix.outputs.json") }}
        run: jlo workflow matrix pending-workstreams --workstreams-json "$WORKSTREAMS_JSON"

  # ============================================================
  # Phase 8: Run deciders
  # ============================================================
  run-deciders:
    needs: [generate-decider-matrix]
    if: |
      always() &&
      needs.generate-decider-matrix.result == 'success' &&
      fromJSON(needs.generate-decider-matrix.outputs.json).has_pending == true
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run deciders sequentially
        id: run
        env:
          MATRIX_JSON: {{ gha_expr("needs.generate-decider-matrix.outputs.json") }}
        run: jlo workflow run deciders --matrix-json "$MATRIX_JSON" ${{ gha_raw("env.JLO_RUN_FLAGS") }}

  # ============================================================
  # Phase 9: Wait for decider processing
  # ============================================================
  wait-after-deciders:
    needs: [generate-decider-matrix, run-deciders]
    if: |
      always() &&
      needs.run-deciders.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 60
    outputs:
      json: {{ gha_expr("steps.wait.outputs.json") }}
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Wait for decider PRs
        id: wait
        env:
          RUN_OUTPUT: {{ gha_expr("needs.run-deciders.outputs.json") }}
        run: |
          expected_count=$(echo "$RUN_OUTPUT" | jq -r '.expected_count')
          run_started_at=$(echo "$RUN_OUTPUT" | jq -r '.run_started_at')
          mock=$(echo "$RUN_OUTPUT" | jq -r '.mock // false')
          mock_prs=$(echo "$RUN_OUTPUT" | jq -c '.mock_pr_numbers // []')
          args=(
            workflow wait prs
            --layer deciders
            --base-branch jules
            --expected-count "$expected_count"
            --run-started-at "$run_started_at"
            --wait-minutes "$WAIT_MINUTES"
            --mode merge
          )
          if [ "$mock" = "true" ]; then
            args+=(--mock --mock-pr-numbers-json "$mock_prs")
          fi
          jlo "${args[@]}"

  # ============================================================
  # Phase 10: Generate routing matrices (new issues)
  # ============================================================
  generate-planner-matrix:
    needs: [generate-workstream-matrix, generate-decider-matrix, run-deciders, wait-after-deciders]
    if: |
      always() &&
      fromJSON(needs.generate-workstream-matrix.outputs.json).has_workstreams == true &&
      (needs.generate-decider-matrix.result == 'success' || needs.generate-decider-matrix.result == 'skipped') &&
      (needs.run-deciders.result == 'success' || needs.run-deciders.result == 'skipped') &&
      (needs.wait-after-deciders.result == 'success' || needs.wait-after-deciders.result == 'skipped')
    runs-on: {{ runner }}
    timeout-minutes: 10
    outputs:
      json: {{ gha_expr("steps.matrix.outputs.json") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Generate planner and implementer matrices
        id: matrix
        env:
          WORKSTREAMS_JSON: {{ gha_expr("needs.generate-workstream-matrix.outputs.json") }}
        run: jlo workflow matrix routing --workstreams-json "$WORKSTREAMS_JSON" --routing-labels "$ROUTING_LABELS"

  # ============================================================
  # Phase 11: Run planners
  # ============================================================
  run-planners:
    needs: [generate-planner-matrix]
    if: |
      always() &&
      needs.generate-planner-matrix.result == 'success' &&
      fromJSON(needs.generate-planner-matrix.outputs.json).has_planners == true
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Run planners sequentially
        id: run
        env:
          MATRIX_JSON: {{ gha_expr("toJSON(fromJSON(needs.generate-planner-matrix.outputs.json).planner_matrix)") }}
        run: jlo workflow run planners --matrix-json "$MATRIX_JSON" ${{ gha_raw("env.JLO_RUN_FLAGS") }}

  # ============================================================
  # Phase 12: Wait for planner PRs
  # ============================================================
  wait-after-planners:
    needs: [run-planners]
    if: |
      always() &&
      needs.run-planners.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 60
    outputs:
      json: {{ gha_expr("steps.wait.outputs.json") }}
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Wait for planner PRs
        id: wait
        env:
          RUN_OUTPUT: {{ gha_expr("needs.run-planners.outputs.json") }}
        run: |
          expected_count=$(echo "$RUN_OUTPUT" | jq -r '.expected_count')
          run_started_at=$(echo "$RUN_OUTPUT" | jq -r '.run_started_at')
          mock=$(echo "$RUN_OUTPUT" | jq -r '.mock // false')
          mock_prs=$(echo "$RUN_OUTPUT" | jq -c '.mock_pr_numbers // []')
          args=(
            workflow wait prs
            --layer planners
            --base-branch jules
            --expected-count "$expected_count"
            --run-started-at "$run_started_at"
            --wait-minutes "$WAIT_MINUTES"
            --mode merge
          )
          if [ "$mock" = "true" ]; then
            args+=(--mock --mock-pr-numbers-json "$mock_prs")
          fi
          jlo "${args[@]}"

  # ============================================================
  # Phase 13: Run implementers
  # ============================================================
  run-implementers:
    needs: [generate-planner-matrix]
    if: |
      always() &&
      needs.generate-planner-matrix.result == 'success' &&
      fromJSON(needs.generate-planner-matrix.outputs.json).has_implementers == true
    runs-on: {{ runner }}
    timeout-minutes: 30
    outputs:
      json: {{ gha_expr("steps.run.outputs.json") }}
    env:
      JULES_API_KEY: {{ gha_expr("secrets.JULES_API_KEY") }}
      TARGET_BRANCH: {{ gha_expr("vars.JULES_TARGET_BRANCH || 'main'") }}
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Run implementers sequentially
        id: run
        env:
          MATRIX_JSON: {{ gha_expr("toJSON(fromJSON(needs.generate-planner-matrix.outputs.json).implementer_matrix)") }}
        run: jlo workflow run implementers --matrix-json "$MATRIX_JSON" --target-branch "$TARGET_BRANCH" ${{ gha_raw("env.JLO_RUN_FLAGS") }}

  # ============================================================
  # Phase 14: Wait for implementer labels
  # ============================================================
  wait-after-implementers:
    needs: [run-implementers]
    if: |
      always() &&
      needs.run-implementers.result == 'success'
    runs-on: {{ runner }}
    timeout-minutes: 60
    outputs:
      json: {{ gha_expr("steps.wait.outputs.json") }}
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
      TARGET_BRANCH: {{ gha_expr("vars.JULES_TARGET_BRANCH || 'main'") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Wait for implementer labels
        id: wait
        env:
          RUN_OUTPUT: {{ gha_expr("needs.run-implementers.outputs.json") }}
        run: |
          expected_count=$(echo "$RUN_OUTPUT" | jq -r '.expected_count')
          run_started_at=$(echo "$RUN_OUTPUT" | jq -r '.run_started_at')
          mock=$(echo "$RUN_OUTPUT" | jq -r '.mock // false')
          mock_prs=$(echo "$RUN_OUTPUT" | jq -c '.mock_pr_numbers // []')
          args=(
            workflow wait prs
            --layer implementers
            --base-branch '{{ gha_raw("env.TARGET_BRANCH") }}'
            --expected-count "$expected_count"
            --run-started-at "$run_started_at"
            --wait-minutes "$WAIT_MINUTES"
            --mode label
          )
          if [ "$mock" = "true" ]; then
            args+=(--mock --mock-pr-numbers-json "$mock_prs")
          fi
          jlo "${args[@]}"

  # ============================================================
  # Phase 15: Cleanup mock artifacts
  # ============================================================
  cleanup-mock:
    needs:
      - run-narrator
      - run-observers
      - run-deciders
      - run-planners
      - run-implementers
      - wait-after-narrator
      - wait-after-observers
      - wait-after-deciders
      - wait-after-planners
      - wait-after-implementers
    if: >-
      always() &&
      (
        (github.event_name == 'workflow_dispatch' && github.event.inputs.mock == 'true') ||
        (github.event_name == 'workflow_call' && inputs.mock == true)
      )
    runs-on: {{ runner }}
    timeout-minutes: 10
    env:
      GH_TOKEN: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}
      GITHUB_REPOSITORY: {{ gha_expr("github.repository") }}
      JULES_MOCK_TAG: {{ gha_expr("format('mock-run-{0}', github.run_id)") }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: jules
          fetch-depth: 0
          token: {{ gha_expr("secrets.JLO_BOT_TOKEN") }}

      - name: Configure Git
        uses: ./.github/actions/configure-git

      - name: Install jlo
        uses: ./.github/actions/install-jlo

      - name: Cleanup mock artifacts
        run: |
          jlo workflow cleanup mock --mock-tag "$JULES_MOCK_TAG"
